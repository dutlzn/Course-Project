---
typora-root-url: /images
---



# 通用权限设计

# 解决方案设计

目前一些知名的权限框架有**shiro 和 spring security**，正常情况，直接用框架没什么问题

方便 快速，但是有一定学习的成本，需要时间



用框架有一个缺点：

每个产品要控制的权限都不太一样，如果硬用框架，会很别扭



不依赖第三方框架，会从权限相关表的设计，到权限的配置，到权限的拦截 作出一个通用的权限设计方案

权限拦截的对象： 用户

权限拦截的点: 菜单 路由 接口 按钮

有些页面只能看，不能操作

控制用户对资源的访问：

权限的操作： 配置  读取 （登录时候读取）  拦截



100个用户*100个资源

直接用用户和资源做关联来控制权限，适合小型的项目、简单、快速



三个核心概念： 用户 角色 资源

100用户 *2个角色 + 2*角色 * 100个资源



这就是比较经典的权限管理设计： 用户和角色关联，角色和资源关联



功能点：

## 配置

用户配置： 用户表、用户管理界面 已完成

资源配置： 资源表，资源配置界面 

角色配置： 角色表，角色配置界面

用户角色关联配置： 用户角色关联表 复用角色管理界面

角色资源关联配置： 角色资源关联表  复用角色管理界面

## 读取

用户权限的读取： 用户登录的时候，读取该用户的所有权限

登陆时候，通过用户角色关联表，可以知道当前登录用户的角色，再通过

角色资源关联表就可以查到当前用户所有的资源



## 拦截

用户操作业务的时候，进行权限的拦截

拦截地方有两个：

前端界面： 菜单、路由、按钮 hidden disabled 

后端接口：接口 gateway的过滤器



权限初始化



所有前端的设计都是不安全的， 所以要对前后端都要进行权限拦截



# 资源配置管理

## 资源表的设计与基本代码生成

```sql

-- 资源
drop table if exists `resource`;
create table `resource` (
  `id` char(6) not null default '' comment 'id',
  `name` varchar(100) not null comment '名称|菜单或按钮',
  `page` varchar(50) null comment '页面|路由',
  `request` varchar(200) null comment '请求|接口',
  `parent` char(6) comment '父id',
  primary key (`id`)
) engine=innodb default charset=utf8mb4 comment='资源';

insert into `resource` values ('01', '系统管理', null, null, null);
insert into `resource` values ('0101', '用户管理', '/system/user', null, '01');
insert into `resource` values ('010101', '保存', null, '["/system/admin/user/list", "/system/admin/user/save"]', '0101');
insert into `resource` values ('010102', '删除', null, '["/system/admin/user/delete"]', '0101');
insert into `resource` values ('010103', '重置密码', null, '["/system/admin/user/save-password"]', '0101');
insert into `resource` values ('0102', '资源管理', '/system/resource', null, '01');
insert into `resource` values ('010201', '保存/显示', null, '["/system/admin/resource"]', '0102');
insert into `resource` values ('0103', '角色管理', '/system/role', null, '01');
insert into `resource` values ('010301', '角色/权限管理', null, '["/system/admin/role"]', '0103');

```

mybatis 

server

vue



如果是一个页面的所有操作统一控制权限，request可以填相关接口的前缀



navbar.vue

```vue
				<v-list-item to="/system/resource">
						<v-list-item-content>
							<v-list-item-title>资源管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>
					

```





router js.

```js

import Vue from 'vue'
// import VueRouter from 'vue-router'
import Router from 'vue-router'
// 导入组件
import Login from '../views/login.vue'
import Admin from '../views/admin.vue'
import Welcome from '../views/admin/welcome.vue'
import Category from '../views/admin/category.vue'
import Teacher from '../views/admin/teacher.vue'
import Course from '../views/admin/course.vue'
import Chapter from '../views/admin/chapter.vue'
import Section from '../views/admin/section.vue'
import File from '../views/admin/file.vue'
import User from '../views/admin/user.vue'
import Role from '../views/admin/role.vue'
import Resource from '../views/admin/resource.vue'
// Vue.use(VueRouter);
Vue.use(Router);

// const routes = [
	
// ]

// const router = new VueRouter({
//   mode: 'history',
//   base: process.env.BASE_URL,
//   routes
// })

// export default router
export default new Router(
    {
        mode: 'history', // history hash 推荐使用history hash 的话前面由前缀，url形式不美观，history推荐使用，路由前面只有以恶搞#
        base: process.env.BASE_URL,
        routes: [{
            path: '*',
            redirect: "/login",
        }, {
            path: "",
            component: Login
        },{
						path: "/login",
						component: Login
				} ,{
            path: "/",
            name: "admin", 
            // name属性后面会用到
            component: Admin,
						meta: {
							loginRequire: true // 
						},
            children: [{
                path: 'welcome',
                name: 'welcome',
                component: Welcome
            }, {
                path: 'business/category',
                name: 'business/category',
                component: Category
            }, {
							path: 'business/teacher',
							name: 'business/teacher',
							component: Teacher
						}, {
							path: 'business/course',
							name: 'business/course',
							component: Course
						}, {
							path: 'business/chapter',
							name: 'business/chapter',
							component: Chapter
						}, {
							path: 'business/section',
							name: 'business/section',
							component: Section
						}, {
							path: 'file/file',
							name: 'file/file',
							component: File
						}, {
							path: 'system/user',
							name: 'system/user',
							component: User
						}, {
							path: 'system/role',
							name: 'system/role',
							component: Role	
						}, {
							path: 'system/resource',
							name: 'system/resource',
							component: Resource
						}]
        }],
				
				ScrollBehavior(to ,from, savedPosition) {
					return {x: 0, y:0};
				}
    }

)
```









# 角色权限管理



## 基本的角色管理功能

### 数据库设计

```sql

drop table if exists `role`;
create table `role` (
  `id` char(8) not null default '' comment 'id',
  `name` varchar(50) not null comment '角色',
  `desc` varchar(100) not null comment '描述',
  primary key (`id`)
) engine=innodb default charset=utf8mb4 comment='角色';

insert into `role` values ('00000000', '系统管理员', '管理用户、角色权限');
insert into `role` values ('00000001', '开发', '维护资源');
insert into `role` values ('00000002', '业务管理员', '负责业务管理');
```



mybatis 自动生成



serverGenerator生成

system-role

vue生成





navbar.vue

```vue
<template>
	<nav>
		<v-app-bar app color="#438EB9">

			<v-app-bar-nav-icon @click="drawer = !drawer"></v-app-bar-nav-icon>

			<v-toolbar-title class="text-uppercase">
				<span class="font-weight-bold">在线视频</span>
				<span>系统</span>
			</v-toolbar-title>

			<!-- text 透明度设置， color 改变按钮内部文字颜色 -->
			<!-- 尽可能多的占用空间 grid -->
			<v-spacer></v-spacer>
			<v-menu offset-y>
				<template v-slot:activator="{ on, attrs }">
					<v-btn text v-bind="attrs" v-on="on" class="font-weight-bold">
						菜单
					</v-btn>
				</template>

				<!-- 			<v-list>
					<v-list-item v-for="(item, i) in links" :key="i" :to="item.route" active-class="border">
						<v-list-item-title>{{item.text}}</v-list-item-title>
					</v-list-item>
				</v-list> -->
			</v-menu>

			<v-btn text @click="logout()">
				<span class="font-weight-bold">退出</span>
				<v-icon>exit_to_app</v-icon>
			</v-btn>
		</v-app-bar>

		<v-navigation-drawer v-model="drawer" app color="#F8F8F8">
			<!-- 对应了菜单先写死 -->
			<v-list>

				<v-list-group prepend-icon="settings" color="blue" no-action="">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>系统管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/system/user">
						<v-list-item-content>
							<v-list-item-title>用户管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

				<v-list-item to="/system/role">
						<v-list-item-content>
							<v-list-item-title>角色管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>
					
				</v-list-group>


				<v-list-group prepend-icon="apps" color="blue" no-action="">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>业务管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/business/course">
						<v-list-item-content>
							<v-list-item-title>课程管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/business/teacher">
						<v-list-item-content>
							<v-list-item-title>讲师管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/business/category">
						<v-list-item-content>
							<v-list-item-title>分类管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

				</v-list-group>

				<!-- :value="true" 就是展开了 -->
				<v-list-group prepend-icon="folder" color="blue" no-action="">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>文件管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/file/file">
						<v-list-item-content>
							<v-list-item-title>文件管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

				</v-list-group>




			</v-list>

		</v-navigation-drawer>
	</nav>
</template>

<script>
	export default {
		data() {
			return {
				drawer: true,
				link: '/welcome',
				loginUser: {},
			}
		},

		mounted: function() {
			let _this = this;
			_this.loginUser = Tool.getLoginUser();
		},

		methods: {
			// 退出

			logout() {
				let _this = this;
				Loading.show();
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/user/logout/' + _this.loginUser.token).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						Tool.setLoginUser(null);
						_this.$router.push("/login")
					} else {
						Toast.warning(resp.message)
					}
				});
			},
		}
	}
</script>

<style scoped>
</style>

```



router

```js
import Vue from 'vue'
// import VueRouter from 'vue-router'
import Router from 'vue-router'
// 导入组件
import Login from '../views/login.vue'
import Admin from '../views/admin.vue'
import Welcome from '../views/admin/welcome.vue'
import Category from '../views/admin/category.vue'
import Teacher from '../views/admin/teacher.vue'
import Course from '../views/admin/course.vue'
import Chapter from '../views/admin/chapter.vue'
import Section from '../views/admin/section.vue'
import File from '../views/admin/file.vue'
import User from '../views/admin/user.vue'
import Role from '../views/admin/role.vue'
// Vue.use(VueRouter);
Vue.use(Router);

// const routes = [
	
// ]

// const router = new VueRouter({
//   mode: 'history',
//   base: process.env.BASE_URL,
//   routes
// })

// export default router
export default new Router(
    {
        mode: 'history', // history hash 推荐使用history hash 的话前面由前缀，url形式不美观，history推荐使用，路由前面只有以恶搞#
        base: process.env.BASE_URL,
        routes: [{
            path: '*',
            redirect: "/login",
        }, {
            path: "",
            component: Login
        },{
						path: "/login",
						component: Login
				} ,{
            path: "/",
            name: "admin", 
            // name属性后面会用到
            component: Admin,
						meta: {
							loginRequire: true // 
						},
            children: [{
                path: 'welcome',
                name: 'welcome',
                component: Welcome
            }, {
                path: 'business/category',
                name: 'business/category',
                component: Category
            }, {
							path: 'business/teacher',
							name: 'business/teacher',
							component: Teacher
						}, {
							path: 'business/course',
							name: 'business/course',
							component: Course
						}, {
							path: 'business/chapter',
							name: 'business/chapter',
							component: Chapter
						}, {
							path: 'business/section',
							name: 'business/section',
							component: Section
						}, {
							path: 'file/file',
							name: 'file/file',
							component: File
						}, {
							path: 'system/user',
							name: 'system/user',
							component: User
						}, {
							path: 'system/role',
							name: 'system/role',
							component: Role	
						}]
        }],
				
				ScrollBehavior(to ,from, savedPosition) {
					return {x: 0, y:0};
				}
    }

)
```



### 资源列表

resource.json

```json
[{
    "id": "00", "name": "欢迎", "page": "welcome"
}, {
    "id": "01", "name": "系统管理",
    "children": [{
        "id": "0101", "name": "用户管理", "page": "system/user",
        "children": [
            {"id": "010101", "name": "保存", "request": ["/system/admin/user/list", "/system/admin/user/save"]},
            {"id": "010102", "name": "删除", "request": ["/system/admin/user/delete"]},
            {"id": "010103", "name": "重置密码", "request": ["/system/admin/user/save-password"]}
        ]
    }, {
        "id": "0102", "name": "资源管理", "page": "system/resource",
        "children": [
            {"id": "010201", "name": "保存/显示", "request": ["/system/admin/resource"]}
        ]
    }, {
        "id": "0103", "name": "角色管理", "page": "system/role",
        "children": [
            {"id": "010301", "name": "角色/权限管理", "request": ["/system/admin/role"]}
        ]
    }]
}, {
    "id": "02", "name": "业务管理",
    "children": [{
        "id": "0201", "name": "分类管理", "page": "business/category",
        "children": [
            {"id": "020101", "name": "增删改查", "request": ["/business/admin/category"]}
        ]
    }, {
        "id": "0202", "name": "课程管理", "page": "business/course",
        "children": [
            {"id": "020201", "name": "增删改查", "request": ["/business/admin/course", "/business/admin/category/all"]}
        ]
    }, {
        "id": "0203", "name": "讲师管理", "page": "business/teacher",
        "children": [
            {"id": "020301", "name": "增删改查", "request": ["/business/admin/teacher"]}
        ]
    }, {
        "id": "0204", "name": "会员管理", "page": "business/member",
        "children": [
            {"id": "020401", "name": "增删改查", "request": ["/business/admin/member"]}
        ]
    }, {
        "id": "0205", "name": "短信管理", "page": "business/sms",
        "children": [
            {"id": "020501", "name": "增删改查", "request": ["/business/admin/sms"]}
        ]
    }]
}, {
    "id": "03", "name": "文件管理",
    "children": [{
        "id": "0301", "name": "文件管理", "page": "file/file",
        "children": [
            {"id": "030101", "name": "文件管理", "request": ["/file/admin/file"]}
        ]
    }]
}]

```





# BUG

token失效了怎么办？  要求重新登录



## 增加角色资源关联功能



