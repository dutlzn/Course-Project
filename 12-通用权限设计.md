---
typora-root-url: /images
---



# 通用权限设计

# 解决方案设计

目前一些知名的权限框架有**shiro 和 spring security**，正常情况，直接用框架没什么问题

方便 快速，但是有一定学习的成本，需要时间



用框架有一个缺点：

每个产品要控制的权限都不太一样，如果硬用框架，会很别扭



不依赖第三方框架，会从权限相关表的设计，到权限的配置，到权限的拦截 作出一个通用的权限设计方案

权限拦截的对象： 用户

权限拦截的点: 菜单 路由 接口 按钮

有些页面只能看，不能操作

控制用户对资源的访问：

权限的操作： 配置  读取 （登录时候读取）  拦截



100个用户*100个资源

直接用用户和资源做关联来控制权限，适合小型的项目、简单、快速



三个核心概念： 用户 角色 资源

100用户 *2个角色 + 2*角色 * 100个资源



这就是比较经典的权限管理设计： 用户和角色关联，角色和资源关联



功能点：

## 配置

用户配置： 用户表、用户管理界面 已完成

资源配置： 资源表，资源配置界面 

角色配置： 角色表，角色配置界面

用户角色关联配置： 用户角色关联表 复用角色管理界面

角色资源关联配置： 角色资源关联表  复用角色管理界面

## 读取

用户权限的读取： 用户登录的时候，读取该用户的所有权限

登陆时候，通过用户角色关联表，可以知道当前登录用户的角色，再通过

角色资源关联表就可以查到当前用户所有的资源



## 拦截

用户操作业务的时候，进行权限的拦截

拦截地方有两个：

前端界面： 菜单、路由、按钮 hidden disabled 

后端接口：接口 gateway的过滤器



权限初始化



所有前端的设计都是不安全的， 所以要对前后端都要进行权限拦截



# 资源配置管理

## 资源表的设计与基本代码生成

```sql

-- 资源
drop table if exists `resource`;
create table `resource` (
  `id` char(6) not null default '' comment 'id',
  `name` varchar(100) not null comment '名称|菜单或按钮',
  `page` varchar(50) null comment '页面|路由',
  `request` varchar(200) null comment '请求|接口',
  `parent` char(6) comment '父id',
  primary key (`id`)
) engine=innodb default charset=utf8mb4 comment='资源';

insert into `resource` values ('01', '系统管理', null, null, null);
insert into `resource` values ('0101', '用户管理', '/system/user', null, '01');
insert into `resource` values ('010101', '保存', null, '["/system/admin/user/list", "/system/admin/user/save"]', '0101');
insert into `resource` values ('010102', '删除', null, '["/system/admin/user/delete"]', '0101');
insert into `resource` values ('010103', '重置密码', null, '["/system/admin/user/save-password"]', '0101');
insert into `resource` values ('0102', '资源管理', '/system/resource', null, '01');
insert into `resource` values ('010201', '保存/显示', null, '["/system/admin/resource"]', '0102');
insert into `resource` values ('0103', '角色管理', '/system/role', null, '01');
insert into `resource` values ('010301', '角色/权限管理', null, '["/system/admin/role"]', '0103');

```

mybatis 

server

vue



如果是一个页面的所有操作统一控制权限，request可以填相关接口的前缀



navbar.vue

```vue
				<v-list-item to="/system/resource">
						<v-list-item-content>
							<v-list-item-title>资源管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>
					

```





router js.

```js

import Vue from 'vue'
// import VueRouter from 'vue-router'
import Router from 'vue-router'
// 导入组件
import Login from '../views/login.vue'
import Admin from '../views/admin.vue'
import Welcome from '../views/admin/welcome.vue'
import Category from '../views/admin/category.vue'
import Teacher from '../views/admin/teacher.vue'
import Course from '../views/admin/course.vue'
import Chapter from '../views/admin/chapter.vue'
import Section from '../views/admin/section.vue'
import File from '../views/admin/file.vue'
import User from '../views/admin/user.vue'
import Role from '../views/admin/role.vue'
import Resource from '../views/admin/resource.vue'
// Vue.use(VueRouter);
Vue.use(Router);

// const routes = [
	
// ]

// const router = new VueRouter({
//   mode: 'history',
//   base: process.env.BASE_URL,
//   routes
// })

// export default router
export default new Router(
    {
        mode: 'history', // history hash 推荐使用history hash 的话前面由前缀，url形式不美观，history推荐使用，路由前面只有以恶搞#
        base: process.env.BASE_URL,
        routes: [{
            path: '*',
            redirect: "/login",
        }, {
            path: "",
            component: Login
        },{
						path: "/login",
						component: Login
				} ,{
            path: "/",
            name: "admin", 
            // name属性后面会用到
            component: Admin,
						meta: {
							loginRequire: true // 
						},
            children: [{
                path: 'welcome',
                name: 'welcome',
                component: Welcome
            }, {
                path: 'business/category',
                name: 'business/category',
                component: Category
            }, {
							path: 'business/teacher',
							name: 'business/teacher',
							component: Teacher
						}, {
							path: 'business/course',
							name: 'business/course',
							component: Course
						}, {
							path: 'business/chapter',
							name: 'business/chapter',
							component: Chapter
						}, {
							path: 'business/section',
							name: 'business/section',
							component: Section
						}, {
							path: 'file/file',
							name: 'file/file',
							component: File
						}, {
							path: 'system/user',
							name: 'system/user',
							component: User
						}, {
							path: 'system/role',
							name: 'system/role',
							component: Role	
						}, {
							path: 'system/resource',
							name: 'system/resource',
							component: Resource
						}]
        }],
				
				ScrollBehavior(to ,from, savedPosition) {
					return {x: 0, y:0};
				}
    }

)
```



用法：以后开发新功能的时候，就在该文件里加入新的资源，可以上线前将新的资源json通过控台保存进数据库



resource.vue

```vue

```





## 资源树的保存 

资源点是开发阶段就确定的，所以并不是上线之后再一个一个去配置的

资源管理最简单的一种方案就是 上线前，准备好sql，刷库



resource.json

```json
[{
    "id": "00", "name": "欢迎", "page": "welcome"
}, {
    "id": "01", "name": "系统管理",
    "children": [{
        "id": "0101", "name": "用户管理", "page": "system/user",
        "children": [
            {"id": "010101", "name": "保存", "request": ["/system/admin/user/list", "/system/admin/user/save"]},
            {"id": "010102", "name": "删除", "request": ["/system/admin/user/delete"]},
            {"id": "010103", "name": "重置密码", "request": ["/system/admin/user/save-password"]}
        ]
    }, {
        "id": "0102", "name": "资源管理", "page": "system/resource",
        "children": [
            {"id": "010201", "name": "保存/显示", "request": ["/system/admin/resource"]}
        ]
    }, {
        "id": "0103", "name": "角色管理", "page": "system/role",
        "children": [
            {"id": "010301", "name": "角色/权限管理", "request": ["/system/admin/role"]}
        ]
    }]
}, {
    "id": "02", "name": "业务管理",
    "children": [{
        "id": "0201", "name": "分类管理", "page": "business/category",
        "children": [
            {"id": "020101", "name": "增删改查", "request": ["/business/admin/category"]}
        ]
    }, {
        "id": "0202", "name": "课程管理", "page": "business/course",
        "children": [
            {"id": "020201", "name": "增删改查", "request": ["/business/admin/course", "/business/admin/category/all"]}
        ]
    }, {
        "id": "0203", "name": "讲师管理", "page": "business/teacher",
        "children": [
            {"id": "020301", "name": "增删改查", "request": ["/business/admin/teacher"]}
        ]
    }, {
        "id": "0204", "name": "会员管理", "page": "business/member",
        "children": [
            {"id": "020401", "name": "增删改查", "request": ["/business/admin/member"]}
        ]
    }, {
        "id": "0205", "name": "短信管理", "page": "business/sms",
        "children": [
            {"id": "020501", "name": "增删改查", "request": ["/business/admin/sms"]}
        ]
    }]
}, {
    "id": "03", "name": "文件管理",
    "children": [{
        "id": "0301", "name": "文件管理", "page": "file/file",
        "children": [
            {"id": "030101", "name": "文件管理", "request": ["/file/admin/file"]}
        ]
    }]
}]

```



resource.vue

```vue
<!-- 小节页面 -->
<template>
	<v-app class="ma-3" app>
		<v-dialog v-model="dialog" persistent max-width="300">
			<v-card>
				<v-card-title>
					表单
				</v-card-title>

				<v-card-text>
					<v-col cols="12">
						<v-text-field label="名称" v-model="resource.name" required></v-text-field>
					</v-col>
					<v-col cols="12">
						<v-text-field label="页面" v-model="resource.page" required></v-text-field>
					</v-col>
					<v-col cols="12">
						<v-text-field label="请求" v-model="resource.request" required></v-text-field>
					</v-col>
					<v-col cols="12">
						<v-text-field label="父id" v-model="resource.parent" required></v-text-field>
					</v-col>
				</v-card-text>
				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialog = false" clas="info">
						取消
					</v-btn>

					<v-btn @click="save()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>


		<p class="ma-10">

			<!-- 		<v-btn class="mr-5 mb-5" color="primary" @click="add()">
				<v-icon left small>add</v-icon>
				新增
			</v-btn> -->
			
			<!-- 资源树的编辑 -->
			<!-- <v-text-field  outlined></v-text-field> --> 
			<v-textarea outlined name="input-7-1" label="资源树"  v-model="resourceStr" hint="输入资源配置信息"></v-textarea>
			<v-btn class="ma-5" color="primary" @click="save()">
				保存
			</v-btn>
			<br>

			<v-btn class="mb-5" color="primary" @click="list(1)">
				<v-icon left small>refresh</v-icon>
				刷新
			</v-btn>

		</p>


		<pagination ref="pagination" v-bind:list="list" v-bind:itemCount="5"></pagination>


		<v-container>
			<v-row>
				<v-col cols="12">
					<v-simple-table>
						<thead>
							<tr>
								<th class="primary--text text-h6 text-center">id</th>
								<th class="primary--text text-h6 text-center">名称</th>
								<th class="primary--text text-h6 text-center">页面</th>
								<th class="primary--text text-h6 text-center">请求</th>
								<th class="primary--text text-h6 text-center">父id</th>
								<th class="primary--text  text-h6 text-center">
									操作
								</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="resource in resources" class="text-center">

								<td>{{resource.id}}</td>
								<td>{{resource.name}}</td>
								<td>{{resource.page}}</td>
								<td>{{resource.request}}</td>
								<td>{{resource.parent}}</td>

								<td>
									<v-row align="center" justify="space-around">
										<v-btn x-small fab @click="edit(resource)" class="primary">
											<v-icon>edit</v-icon>
										</v-btn>

										<v-btn x-small fab @click="del(resource.id)" class="warning">
											<v-icon>delete</v-icon>
										</v-btn>
									</v-row>
								</td>
							</tr>
						</tbody>
					</v-simple-table>
				</v-col>
			</v-row>
		</v-container>

	</v-app>
</template>

<script>
	import Pagination from "../../components/pagination.vue";
	export default {
		name: "system-resource",
		components: {
			Pagination
		},

		data: function() {
			return {
				
				resource: {},
				resources: [],
				// 资源树
				resourceStr: "",

				dialog: false,
			}
		},

		mounted: function() {
			let _this = this;
			_this.$refs.pagination.size = 5;
			_this.list(1);

		},

		methods: {
			// 获取所有小节的数据
			list(page) {
				let _this = this;
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/resource/list', {
					page: page,
					size: _this.$refs.pagination.size,
				}).then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.resources = resp.content.list;
					_this.$refs.pagination.render(page, resp.content.total);

				})
			},
			
			/**
			 * 保存
			 */
     /**
       * 点击【保存】
       */
      save() {
        let _this = this;

        // 保存校验
        if (Tool.isEmpty(_this.resourceStr)) {
          Toast.warning("资源不能为空！");
          return;
        }
        let json = JSON.parse(_this.resourceStr);

        Loading.show();
        _this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/resource/save', json).then((response)=>{
          Loading.hide();
          let resp = response.data;
          if (resp.success) {
            $("#form-modal").modal("hide");
            _this.list(1);
            Toast.success("保存成功！");
          } else {
            Toast.warning(resp.message)
          }
        })
      },

			/**
			 * 删除小节
			 */
			del(id) {
				let _this = this;
				Confirm.show("删除资源后不可恢复，确认删除？", function() {
					Loading.show();
					_this.$ajax.delete(process.env.VUE_APP_SERVER + '/system/admin/resource/delete/' + id).then((response) => {
						Loading.hide();
						let resp = response.data;
						if (resp.success) {
							_this.list(1);
							Toast.success("删除成功！");
						}
					})
				});
			}
		}
	}
</script>

<style>
</style>

```



resourceController.java

```java
package com.lzn.system.controller.admin;

import com.lzn.dto.ResourceDto;
import com.lzn.dto.PageDto;
import com.lzn.dto.ResponseDto;
import com.lzn.service.ResourceService;
import com.lzn.util.ValidatorUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/admin/resource")
public class ResourceController {

    public static final String BUSINESS_NAME = "资源";

    @Autowired
    private ResourceService resourceService;

    @PostMapping("/list")
    public ResponseDto list(@RequestBody PageDto pageDto) {
        ResponseDto responseDto = new ResponseDto();
        resourceService.list(pageDto);
        responseDto.setContent(pageDto);
        return responseDto;
    }
    @PostMapping("/save")
    public ResponseDto save(@RequestBody String jsonStr){
        // 保存校验
        ValidatorUtil.require(jsonStr, "资源");

        ResponseDto responseDto = new ResponseDto();
        resourceService.saveJson(jsonStr);
        return responseDto;
    }

    @DeleteMapping("/delete/{id}")
    public ResponseDto delete(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        resourceService.delete(id);
        return responseDto;
    }
}

```



ResourceDto.java

```java
package com.lzn.dto;



import java.util.List;

public class ResourceDto {

    /**
     * id
     */
    private String id;

    /**
     * 名称|菜单或按钮
     */
    private String name;

    /**
     * 页面|路由
     */
    private String page;

    /**
     * 请求|接口
     */
    private String request;

    /**
     * 父id
     */
    private String parent;

    private List<ResourceDto> children;

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getPage() {
        return page;
    }

    public void setPage(String page) {
        this.page = page;
    }

    public String getRequest() {
        return request;
    }

    public void setRequest(String request) {
        this.request = request;
    }

    public String getParent() {
        return parent;
    }

    public void setParent(String parent) {
        this.parent = parent;
    }

    public List<ResourceDto> getChildren() {
        return children;
    }

    public void setChildren(List<ResourceDto> children) {
        this.children = children;
    }

    @Override
    public String toString() {
        final StringBuffer sb = new StringBuffer("ResourceDto{");
        sb.append("id='").append(id).append('\'');
        sb.append(", name='").append(name).append('\'');
        sb.append(", page='").append(page).append('\'');
        sb.append(", request='").append(request).append('\'');
        sb.append(", parent='").append(parent).append('\'');
        sb.append(", children=").append(children);
        sb.append('}');
        return sb.toString();
    }

}
```



ResourceService.java

```java
package com.lzn.service;

import com.alibaba.fastjson.JSON;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.Resource;
import com.lzn.domain.ResourceExample;
import com.lzn.domain.Test;
import com.lzn.domain.TestExample;
import com.lzn.dto.ResourceDto;
import com.lzn.dto.PageDto;
import com.lzn.mapper.ResourceMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.CollectionUtils;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
@Service
public class ResourceService {
    private static final Logger LOG = LoggerFactory.getLogger(ResourceService.class);
    @Autowired
    private ResourceMapper resourceMapper;


    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        ResourceExample resourceExample = new ResourceExample();


        List<Resource> resourceList = resourceMapper.selectByExample(resourceExample);

        PageInfo<Resource> pageInfo = new PageInfo<>(resourceList);
        pageDto.setTotal(pageInfo.getTotal());

        List<ResourceDto> resourceDtoList = new ArrayList<>();

        for(int i = 0;i<resourceList.size();++i){
            Resource resource = resourceList.get(i);
            ResourceDto resourceDto = new ResourceDto();
            BeanUtils.copyProperties(resource, resourceDto);
            resourceDtoList.add(resourceDto);
        }
        pageDto.setList(resourceDtoList);

    }

    public void save(ResourceDto resourceDto){
        Resource resource = CopyUtil.copy(resourceDto, Resource.class);
        if(StringUtils.isEmpty(resourceDto.getId())){
            this.insert(resource);
        } else {
            this.update(resource);
        }
    }

    /**
     * 新增ID 是自定义好的，不是自动生成的
     * @param resource
     */
    private void insert(Resource resource){
//        resource.setId(UuidUtil.getShortUuid());
        resourceMapper.insert(resource);
    }


    private void update(Resource resource){
        resourceMapper.updateByPrimaryKey(resource);
    }

    public void delete(String id) {
        resourceMapper.deleteByPrimaryKey(id);
    }

    /**
     * 保存资源树
     * @param json
     */
    @Transactional
    public void saveJson(String json) {
        // 把嵌套的jsonlist的节点取出来，组成简单的list
        List<ResourceDto> jsonList = JSON.parseArray(json, ResourceDto.class);
        List<ResourceDto> list = new ArrayList<>();
        if (!CollectionUtils.isEmpty(jsonList)) {
            for (ResourceDto d: jsonList) {
                d.setParent("");
                add(list, d);
            }
        }
        LOG.info("共{}条", list.size());

        resourceMapper.deleteByExample(null);
        for (int i = 0; i < list.size(); i++) {
            this.insert(CopyUtil.copy(list.get(i), Resource.class));
        }
    }

    /**
     * 递归，将树型结构的节点全部取出来，放到list
     * @param list
     * @param dto
     */
    public void add(List<ResourceDto> list, ResourceDto dto) {
        list.add(dto);
        if (!CollectionUtils.isEmpty(dto.getChildren())) {
            for (ResourceDto d: dto.getChildren()) {
                d.setParent(dto.getId());
                add(list, d);
            }
        }
    }
}

```



## 资源树的显示

ResourceController.java

```java
package com.lzn.system.controller.admin;

import com.lzn.dto.ResourceDto;
import com.lzn.dto.PageDto;
import com.lzn.dto.ResponseDto;
import com.lzn.service.ResourceService;
import com.lzn.util.ValidatorUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/admin/resource")
public class ResourceController {

    public static final String BUSINESS_NAME = "资源";

    @Autowired
    private ResourceService resourceService;

    @PostMapping("/list")
    public ResponseDto list(@RequestBody PageDto pageDto) {
        ResponseDto responseDto = new ResponseDto();
        resourceService.list(pageDto);
        responseDto.setContent(pageDto);
        return responseDto;
    }
    @PostMapping("/save")
    public ResponseDto save(@RequestBody String jsonStr){
        // 保存校验
        ValidatorUtil.require(jsonStr, "资源");

        ResponseDto responseDto = new ResponseDto();
        resourceService.saveJson(jsonStr);
        return responseDto;
    }

    @DeleteMapping("/delete/{id}")
    public ResponseDto delete(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        resourceService.delete(id);
        return responseDto;
    }


    /**
     * 资源树查询
     */
    @GetMapping("/load-tree")
    public ResponseDto loadTree() {
        ResponseDto responseDto = new ResponseDto();
        List<ResourceDto> resourceDtoList = resourceService.loadTree();
        responseDto.setContent(resourceDtoList);
        return responseDto;
    }


}

```





ResourceService.java

```java
package com.lzn.service;

import com.alibaba.fastjson.JSON;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.Resource;
import com.lzn.domain.ResourceExample;
import com.lzn.domain.Test;
import com.lzn.domain.TestExample;
import com.lzn.dto.ResourceDto;
import com.lzn.dto.PageDto;
import com.lzn.mapper.ResourceMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.CollectionUtils;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
@Service
public class ResourceService {
    private static final Logger LOG = LoggerFactory.getLogger(ResourceService.class);
    @Autowired
    private ResourceMapper resourceMapper;


    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        ResourceExample resourceExample = new ResourceExample();


        List<Resource> resourceList = resourceMapper.selectByExample(resourceExample);

        PageInfo<Resource> pageInfo = new PageInfo<>(resourceList);
        pageDto.setTotal(pageInfo.getTotal());

        List<ResourceDto> resourceDtoList = new ArrayList<>();

        for(int i = 0;i<resourceList.size();++i){
            Resource resource = resourceList.get(i);
            ResourceDto resourceDto = new ResourceDto();
            BeanUtils.copyProperties(resource, resourceDto);
            resourceDtoList.add(resourceDto);
        }
        pageDto.setList(resourceDtoList);

    }

    public void save(ResourceDto resourceDto){
        Resource resource = CopyUtil.copy(resourceDto, Resource.class);
        if(StringUtils.isEmpty(resourceDto.getId())){
            this.insert(resource);
        } else {
            this.update(resource);
        }
    }

    /**
     * 新增ID 是自定义好的，不是自动生成的
     * @param resource
     */
    private void insert(Resource resource){
//        resource.setId(UuidUtil.getShortUuid());
        resourceMapper.insert(resource);
    }


    private void update(Resource resource){
        resourceMapper.updateByPrimaryKey(resource);
    }

    public void delete(String id) {
        resourceMapper.deleteByPrimaryKey(id);
    }

    /**
     * 保存资源树
     * @param json
     */
    @Transactional
    public void saveJson(String json) {
        List<ResourceDto> jsonList = JSON.parseArray(json, ResourceDto.class);
        List<ResourceDto> list = new ArrayList<>();
        if (!CollectionUtils.isEmpty(jsonList)) {
            for (ResourceDto d: jsonList) {
                d.setParent("");
                add(list, d);
            }
        }
        LOG.info("共{}条", list.size());

        resourceMapper.deleteByExample(null);
        for (int i = 0; i < list.size(); i++) {
            this.insert(CopyUtil.copy(list.get(i), Resource.class));
        }
    }

    /**
     * 递归，将树型结构的节点全部取出来，放到list
     * @param list
     * @param dto
     */
    public void add(List<ResourceDto> list, ResourceDto dto) {
        list.add(dto);
        if (!CollectionUtils.isEmpty(dto.getChildren())) {
            for (ResourceDto d: dto.getChildren()) {
                d.setParent(dto.getId());
                add(list, d);
            }
        }
    }

    /**
     * 按约定将列表转成树
     * 要求：ID要正序排列
     * @return
     */
    public List<ResourceDto> loadTree() {
        ResourceExample example = new ResourceExample();
        example.setOrderByClause("id asc");
        List<Resource> resourceList = resourceMapper.selectByExample(example);
        List<ResourceDto> resourceDtoList = CopyUtil.copyList(resourceList, ResourceDto.class);
        for (int i = resourceDtoList.size() - 1; i >= 0; i--) {
            // 当前要移动的记录
            ResourceDto child = resourceDtoList.get(i);

            // 如果当前节点没有父节点，则不用往下了
            if (StringUtils.isEmpty(child.getParent())) {
                continue;
            }
            // 查找父节点
            for (int j = i - 1; j >= 0; j--) {
                ResourceDto parent = resourceDtoList.get(j);
                if (child.getParent().equals(parent.getId())) {
                    if (CollectionUtils.isEmpty(parent.getChildren())) {
                        parent.setChildren(new ArrayList<>());
                    }
                    // 添加到最前面，否则会变成倒序，因为循环是从后往前循环的
                    parent.getChildren().add(0, child);

                    // 子节点找到父节点后，删除列表中的子节点
                    resourceDtoList.remove(child);
                }
            }
        }
        return resourceDtoList;
    }
}

```





postman header token

资源的保存是将树结构转成列表，重点是children 属性。资源的显示是将列表转成树结构，重点是parent属性 

利用嵌套循环去查找当前parent值对应的记录



小技巧： 一边循环list， 一边删除list里的对象，可以使用倒序循环







resource.vue

```vue
<!-- 小节页面 -->
<template>
	<v-app class="ma-3" app>

		<p class="ma-10">

			<v-btn class="mb-5" color="primary" @click="list(1)">
				<v-icon left small>refresh</v-icon>
				刷新
			</v-btn>

			<v-row>


<!-- 				<v-col cols="2">
					<v-btn class="my-auto" color="primary" @click="save()">
						保存
					</v-btn>
				</v-col> -->
				<v-col cols="6">
					<!-- <p class="display-1">资源树</p> -->
					<v-treeview open-all :items="items" return-object></v-treeview>
				</v-col>
				
				<v-col cols="6">
					<v-textarea outlined name="input-7-1" label="资源树" v-model="resourceStr" hint="输入资源配置信息"></v-textarea>
					<v-btn class="my-auto" color="primary" @click="save()">
						保存
					</v-btn>
				</v-col>
			</v-row>
			<br>

		</p>
<!-- 
		<v-main>
			<p class="display-1">资源树</p>
			<v-treeview open-all :items="items" return-object></v-treeview>
		</v-main> -->

	</v-app>

</template>

<script>
	// import Pagination from "../../components/pagination.vue";
	export default {
		name: "system-resource",
		components: {
			// Pagination
		},

		data: function() {
			return {

				resource: {},
				resources: [],
				// 资源树
				resourceStr: "",
				items: [],

			}
		},

		mounted: function() {
			let _this = this;
			_this.list();

		},

		methods: {
			// 获取所有小节的数据
			list() {
				let _this = this;
				Loading.show();
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/resource/load-tree').then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.resources = resp.content;
					console.log(_this.resources);
					_this.items = _this.resources;
				})
			},

			/**
			 * 保存
			 */
			/**
			 * 点击【保存】
			 */
			save() {
				let _this = this;

				// 保存校验
				if (Tool.isEmpty(_this.resourceStr)) {
					Toast.warning("资源不能为空！");
					return;
				}
				let json = JSON.parse(_this.resourceStr);

				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/resource/save', json).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						_this.list();
						Toast.success("保存成功！");
					} else {
						Toast.warning(resp.message)
					}
				})
			},

			/**
			 * 删除小节
			 */
			del(id) {
				let _this = this;
				Confirm.show("删除资源后不可恢复，确认删除？", function() {
					Loading.show();
					_this.$ajax.delete(process.env.VUE_APP_SERVER + '/system/admin/resource/delete/' + id).then((response) => {
						Loading.hide();
						let resp = response.data;
						if (resp.success) {
							_this.list(1);
							Toast.success("删除成功！");
						}
					})
				});
			}
		}
	}
</script>

<style>
</style>

```



这里比课程分类简单一点









# 角色权限管理

## 基本的角色管理功能

### 数据库设计

```sql

drop table if exists `role`;
create table `role` (
  `id` char(8) not null default '' comment 'id',
  `name` varchar(50) not null comment '角色',
  `desc` varchar(100) not null comment '描述',
  primary key (`id`)
) engine=innodb default charset=utf8mb4 comment='角色';

insert into `role` values ('00000000', '系统管理员', '管理用户、角色权限');
insert into `role` values ('00000001', '开发', '维护资源');
insert into `role` values ('00000002', '业务管理员', '负责业务管理');
```



mybatis 自动生成



serverGenerator生成

system-role

vue生成





navbar.vue

```vue
<template>
	<nav>
		<v-app-bar app color="#438EB9">

			<v-app-bar-nav-icon @click="drawer = !drawer"></v-app-bar-nav-icon>

			<v-toolbar-title class="text-uppercase">
				<span class="font-weight-bold">在线视频</span>
				<span>系统</span>
			</v-toolbar-title>

			<!-- text 透明度设置， color 改变按钮内部文字颜色 -->
			<!-- 尽可能多的占用空间 grid -->
			<v-spacer></v-spacer>
			<v-menu offset-y>
				<template v-slot:activator="{ on, attrs }">
					<v-btn text v-bind="attrs" v-on="on" class="font-weight-bold">
						菜单
					</v-btn>
				</template>

				<!-- 			<v-list>
					<v-list-item v-for="(item, i) in links" :key="i" :to="item.route" active-class="border">
						<v-list-item-title>{{item.text}}</v-list-item-title>
					</v-list-item>
				</v-list> -->
			</v-menu>

			<v-btn text @click="logout()">
				<span class="font-weight-bold">退出</span>
				<v-icon>exit_to_app</v-icon>
			</v-btn>
		</v-app-bar>

		<v-navigation-drawer v-model="drawer" app color="#F8F8F8">
			<!-- 对应了菜单先写死 -->
			<v-list>

				<v-list-group prepend-icon="settings" color="blue" no-action="">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>系统管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/system/user">
						<v-list-item-content>
							<v-list-item-title>用户管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

				<v-list-item to="/system/role">
						<v-list-item-content>
							<v-list-item-title>角色管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>
					
				</v-list-group>


				<v-list-group prepend-icon="apps" color="blue" no-action="">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>业务管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/business/course">
						<v-list-item-content>
							<v-list-item-title>课程管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/business/teacher">
						<v-list-item-content>
							<v-list-item-title>讲师管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/business/category">
						<v-list-item-content>
							<v-list-item-title>分类管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

				</v-list-group>

				<!-- :value="true" 就是展开了 -->
				<v-list-group prepend-icon="folder" color="blue" no-action="">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>文件管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/file/file">
						<v-list-item-content>
							<v-list-item-title>文件管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

				</v-list-group>




			</v-list>

		</v-navigation-drawer>
	</nav>
</template>

<script>
	export default {
		data() {
			return {
				drawer: true,
				link: '/welcome',
				loginUser: {},
			}
		},

		mounted: function() {
			let _this = this;
			_this.loginUser = Tool.getLoginUser();
		},

		methods: {
			// 退出

			logout() {
				let _this = this;
				Loading.show();
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/user/logout/' + _this.loginUser.token).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						Tool.setLoginUser(null);
						_this.$router.push("/login")
					} else {
						Toast.warning(resp.message)
					}
				});
			},
		}
	}
</script>

<style scoped>
</style>

```



router

```js
import Vue from 'vue'
// import VueRouter from 'vue-router'
import Router from 'vue-router'
// 导入组件
import Login from '../views/login.vue'
import Admin from '../views/admin.vue'
import Welcome from '../views/admin/welcome.vue'
import Category from '../views/admin/category.vue'
import Teacher from '../views/admin/teacher.vue'
import Course from '../views/admin/course.vue'
import Chapter from '../views/admin/chapter.vue'
import Section from '../views/admin/section.vue'
import File from '../views/admin/file.vue'
import User from '../views/admin/user.vue'
import Role from '../views/admin/role.vue'
// Vue.use(VueRouter);
Vue.use(Router);

// const routes = [
	
// ]

// const router = new VueRouter({
//   mode: 'history',
//   base: process.env.BASE_URL,
//   routes
// })

// export default router
export default new Router(
    {
        mode: 'history', // history hash 推荐使用history hash 的话前面由前缀，url形式不美观，history推荐使用，路由前面只有以恶搞#
        base: process.env.BASE_URL,
        routes: [{
            path: '*',
            redirect: "/login",
        }, {
            path: "",
            component: Login
        },{
						path: "/login",
						component: Login
				} ,{
            path: "/",
            name: "admin", 
            // name属性后面会用到
            component: Admin,
						meta: {
							loginRequire: true // 
						},
            children: [{
                path: 'welcome',
                name: 'welcome',
                component: Welcome
            }, {
                path: 'business/category',
                name: 'business/category',
                component: Category
            }, {
							path: 'business/teacher',
							name: 'business/teacher',
							component: Teacher
						}, {
							path: 'business/course',
							name: 'business/course',
							component: Course
						}, {
							path: 'business/chapter',
							name: 'business/chapter',
							component: Chapter
						}, {
							path: 'business/section',
							name: 'business/section',
							component: Section
						}, {
							path: 'file/file',
							name: 'file/file',
							component: File
						}, {
							path: 'system/user',
							name: 'system/user',
							component: User
						}, {
							path: 'system/role',
							name: 'system/role',
							component: Role	
						}]
        }],
				
				ScrollBehavior(to ,from, savedPosition) {
					return {x: 0, y:0};
				}
    }

)
```



### 资源列表

resource.json

```json
[{
    "id": "00", "name": "欢迎", "page": "welcome"
}, {
    "id": "01", "name": "系统管理",
    "children": [{
        "id": "0101", "name": "用户管理", "page": "system/user",
        "children": [
            {"id": "010101", "name": "保存", "request": ["/system/admin/user/list", "/system/admin/user/save"]},
            {"id": "010102", "name": "删除", "request": ["/system/admin/user/delete"]},
            {"id": "010103", "name": "重置密码", "request": ["/system/admin/user/save-password"]}
        ]
    }, {
        "id": "0102", "name": "资源管理", "page": "system/resource",
        "children": [
            {"id": "010201", "name": "保存/显示", "request": ["/system/admin/resource"]}
        ]
    }, {
        "id": "0103", "name": "角色管理", "page": "system/role",
        "children": [
            {"id": "010301", "name": "角色/权限管理", "request": ["/system/admin/role"]}
        ]
    }]
}, {
    "id": "02", "name": "业务管理",
    "children": [{
        "id": "0201", "name": "分类管理", "page": "business/category",
        "children": [
            {"id": "020101", "name": "增删改查", "request": ["/business/admin/category"]}
        ]
    }, {
        "id": "0202", "name": "课程管理", "page": "business/course",
        "children": [
            {"id": "020201", "name": "增删改查", "request": ["/business/admin/course", "/business/admin/category/all"]}
        ]
    }, {
        "id": "0203", "name": "讲师管理", "page": "business/teacher",
        "children": [
            {"id": "020301", "name": "增删改查", "request": ["/business/admin/teacher"]}
        ]
    }, {
        "id": "0204", "name": "会员管理", "page": "business/member",
        "children": [
            {"id": "020401", "name": "增删改查", "request": ["/business/admin/member"]}
        ]
    }, {
        "id": "0205", "name": "短信管理", "page": "business/sms",
        "children": [
            {"id": "020501", "name": "增删改查", "request": ["/business/admin/sms"]}
        ]
    }]
}, {
    "id": "03", "name": "文件管理",
    "children": [{
        "id": "0301", "name": "文件管理", "page": "file/file",
        "children": [
            {"id": "030101", "name": "文件管理", "request": ["/file/admin/file"]}
        ]
    }]
}]

```





# BUG

token失效了怎么办？  要求重新登录



## 增加角色资源关联功能



数据库设计

```sql

drop table if exists `role_resource`;
create table `role_resource` (
  `id` char(8) not null default '' comment 'id',
  `role_id` char(8) not null comment '角色|id',
  `resource_id` char(6) not null comment '资源|id',
  primary key (`id`)
) engine=innodb default charset=utf8mb4 comment='角色资源关联';

insert into `role_resource` values ('00000000', '00000000', '01');
insert into `role_resource` values ('00000001', '00000000', '0101');
insert into `role_resource` values ('00000002', '00000000', '010101');
insert into `role_resource` values ('00000003', '00000000', '010102');
insert into `role_resource` values ('00000004', '00000000', '010103');
insert into `role_resource` values ('00000005', '00000000', '0102');
insert into `role_resource` values ('00000006', '00000000', '010201');
insert into `role_resource` values ('00000007', '00000000', '0103');
insert into `role_resource` values ('00000008', '00000000', '010301');
```

mybatis 自动生成

server 自动生成

# BUG



**遇到一个bug  如何在vuetify里定义一个vnode**

**map of null** 



空的children ----> [] 

空的request ----> ""

空的page ----> ""

已解决 jackson , null 不传输，不要用其他ui去解决，最好在后端上进行解决



```
package com.lzn.dto;



import com.fasterxml.jackson.annotation.JsonInclude;

import java.util.List;

public class ResourceDto {

    /**
     * id
     */
    private String id;

    /**
     * 名称|菜单或按钮
     */
    private String name;

    /**
     * 页面|路由
     */
    @JsonInclude(JsonInclude.Include.NON_NULL)
    private String page;

    /**
     * 请求|接口
     */
    @JsonInclude(JsonInclude.Include.NON_NULL)
    private String request;

    /**
     * 父id
     */

    private String parent;
    @JsonInclude(JsonInclude.Include.NON_NULL)
    private List<ResourceDto> children;

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getPage() {
        return page;
    }

    public void setPage(String page) {
        this.page = page;
    }

    public String getRequest() {
        return request;
    }

    public void setRequest(String request) {
        this.request = request;
    }

    public String getParent() {
        return parent;
    }

    public void setParent(String parent) {
        this.parent = parent;
    }

    public List<ResourceDto> getChildren() {
        return children;
    }

    public void setChildren(List<ResourceDto> children) {
        this.children = children;
    }

    @Override
    public String toString() {
        final StringBuffer sb = new StringBuffer("ResourceDto{");
        sb.append("id='").append(id).append('\'');
        sb.append(", name='").append(name).append('\'');
        sb.append(", page='").append(page).append('\'');
        sb.append(", request='").append(request).append('\'');
        sb.append(", parent='").append(parent).append('\'');
        sb.append(", children=").append(children);
        sb.append('}');
        return sb.toString();
    }

}
```







## 加载资源数

role.vue

```vue
<!-- 小节页面 -->
<template>
	<v-app class="ma-3" app>
		<v-dialog v-model="dialog" persistent max-width="300">
			<v-card>
				<v-card-title>
					表单
				</v-card-title>

				<v-card-text>
					<v-col cols="12">
						<v-text-field label="角色" v-model="role.name" required></v-text-field>
					</v-col>
					<v-col cols="12">
						<v-text-field label="描述" v-model="role.desc" required></v-text-field>
					</v-col>
				</v-card-text>
				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialog = false" class="warning">
						取消
					</v-btn>

					<v-btn @click="save()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>

		<!-- 角色资源关联配置 -->
		<v-dialog v-model="diglogRoleResource" persistent max-width="500">
			<v-card>
				<v-card-title>
					角色资源关联配置
				</v-card-title>

				<!-- <v-card-text> -->
							<v-treeview selectable :items="items" v-model="selection" return-object></v-treeview>
				<!-- </v-card-text> -->

				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn  @click="diglogRoleResource = false" class="info">
						取消
					</v-btn>

				</v-card-actions>
			</v-card>
		</v-dialog>



		<p class="ma-10">

			<v-btn class="mr-5 mb-5" color="primary" @click="add()">
				<v-icon left small>add</v-icon>
				新增
			</v-btn>

			<v-btn class="mb-5" color="primary" @click="list(1)">
				<v-icon left small>refresh</v-icon>
				刷新
			</v-btn>

		</p>


		<pagination ref="pagination" v-bind:list="list" v-bind:itemCount="5"></pagination>


		<v-container>
			<v-row>
				<v-col cols="12">
					<v-simple-table>
						<thead>
							<tr>
								<th class="primary--text text-h6 text-center">id</th>
								<th class="primary--text text-h6 text-center">角色</th>
								<th class="primary--text text-h6 text-center">描述</th>
								<th class="primary--text  text-h6 text-center">
									操作
								</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="role in roles" class="text-center">

								<td>{{role.id}}</td>
								<td>{{role.name}}</td>
								<td>{{role.desc}}</td>

								<td>
									<v-row align="center" justify="space-around">
										<v-btn x-small fab @click="editResource(role)" class="success">
											<v-icon>lock</v-icon>
										</v-btn>

										<v-btn x-small fab @click="edit(role)" class="primary">
											<v-icon>edit</v-icon>
										</v-btn>

										<v-btn x-small fab @click="del(role.id)" class="warning">
											<v-icon>delete</v-icon>
										</v-btn>
									</v-row>
								</td>
							</tr>
						</tbody>
					</v-simple-table>
				</v-col>
			</v-row>
		</v-container>

	</v-app>
</template>

<script>
	import Pagination from "../../components/pagination.vue";
	export default {
		name: "system-role",
		components: {
			Pagination
		},

		data: function() {
			return {
				role: {},
				roles: [],
				resource: {},
				resources: [],
				// 资源树
				resourceStr: "",
				items: [],
				dialog: false,
				diglogRoleResource: false,
				selection: [], // 表示已经选择的数据
			}
		},

		mounted: function() {
			let _this = this;
			_this.$refs.pagination.size = 5;
			_this.list(1);
			_this.loadResource();

		},
		watch: {


			selection: {

				deep: true,

				handler() {

					// changedIndex 就是发生改变的位置
					console.log(this.selection);
				}

			}

		},
		methods: {
			// 获取所有小节的数据
			list(page) {
				let _this = this;
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/list', {
					page: page,
					size: _this.$refs.pagination.size,
				}).then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.roles = resp.content.list;
					_this.$refs.pagination.render(page, resp.content.total);
					

				})
			},
			/**
			 * 新增小节
			 */
			add() {
				let _this = this;
				_this.role = {};
				_this.dialog = true;
			},

			/**
			 * 编辑小节
			 */
			edit(role) {
				let _this = this;
				_this.role = $.extend({}, role);
				_this.dialog = true;
			},

			/**
			 * 保存
			 */
			save() {
				let _this = this;

				// 保存校验
				if (1 != 1 ||
					!Validator.require(_this.role.name, "角色") ||
					!Validator.length(_this.role.name, "角色", 1, 50) ||
					!Validator.require(_this.role.desc, "描述") ||
					!Validator.length(_this.role.desc, "描述", 1, 100)
				) {
					return;
				}

				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save', _this.role).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						_this.dialog = false,
							_this.list(1);
						Toast.success("保存成功！");
					} else {
						Toast.warning(resp.message)
					}
				})
			},

			/**
			 * 删除小节
			 */
			del(id) {
				let _this = this;
				Confirm.show("删除角色后不可恢复，确认删除？", function() {
					Loading.show();
					_this.$ajax.delete(process.env.VUE_APP_SERVER + '/system/admin/role/delete/' + id).then((response) => {
						Loading.hide();
						let resp = response.data;
						if (resp.success) {
							_this.list(1);
							Toast.success("删除成功！");
						}
					})
				});
			},

			/**
			 * 角色资源关联
			 */
			editResource(role) {
				let _this = this;
				// 加载资源树
				_this.loadResource();
				_this.diglogRoleResource = true;
			},

			/**
			 * 加载资源数
			 */
			loadResource() {
				let _this = this;
				Loading.show();
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/resource/load-tree').then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.resources = resp.content;
					_this.items = _this.resources;
					_this.selection = [];
				})
			}
		}
	}
</script>

<style>
</style>

```



postman header 加入token ，







## BUG

left  independent两个模式，

left

选择子节点，可以自动加入所有父节点



每次选择都是最底下的节点





## 角色 资源 相互管理

role.vue

```vue
<!-- 小节页面 -->
<template>
	<v-app class="ma-3" app>
		<v-dialog v-model="dialog" persistent max-width="300">
			<v-card>
				<v-card-title>
					表单
				</v-card-title>

				<v-card-text>
					<v-col cols="12">
						<v-text-field label="角色" v-model="role.name" required></v-text-field>
					</v-col>
					<v-col cols="12">
						<v-text-field label="描述" v-model="role.desc" required></v-text-field>
					</v-col>
				</v-card-text>
				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialog = false" class="warning">
						取消
					</v-btn>

					<v-btn @click="save()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>

		<!-- 角色资源关联配置 -->
		<v-dialog v-model="diglogRoleResource" persistent max-width="500">
			<v-card>
				<v-card-title>
					角色资源关联配置
				</v-card-title>

				<!-- <v-card-text> -->
				<v-treeview selectable :items="items" v-model="selection" selection-type="leaf" return-object></v-treeview>
				<!-- </v-card-text> -->

				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="diglogRoleResource = false" class="info">
						取消
					</v-btn>

					<v-btn @click="saveResource()" class="warning">
						保存
					</v-btn>

				</v-card-actions>
			</v-card>
		</v-dialog>



		<p class="ma-10">

			<v-btn class="mr-5 mb-5" color="primary" @click="add()">
				<v-icon left small>add</v-icon>
				新增
			</v-btn>

			<v-btn class="mb-5" color="primary" @click="list(1)">
				<v-icon left small>refresh</v-icon>
				刷新
			</v-btn>

		</p>


		<pagination ref="pagination" v-bind:list="list" v-bind:itemCount="5"></pagination>


		<v-container>
			<v-row>
				<v-col cols="12">
					<v-simple-table>
						<thead>
							<tr>
								<th class="primary--text text-h6 text-center">id</th>
								<th class="primary--text text-h6 text-center">角色</th>
								<th class="primary--text text-h6 text-center">描述</th>
								<th class="primary--text  text-h6 text-center">
									操作
								</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="role in roles" class="text-center">

								<td>{{role.id}}</td>
								<td>{{role.name}}</td>
								<td>{{role.desc}}</td>

								<td>
									<v-row align="center" justify="space-around">
										<v-btn x-small fab @click="editResource(role)" class="success">
											<v-icon>lock</v-icon>
										</v-btn>

										<v-btn x-small fab @click="edit(role)" class="primary">
											<v-icon>edit</v-icon>
										</v-btn>

										<v-btn x-small fab @click="del(role.id)" class="warning">
											<v-icon>delete</v-icon>
										</v-btn>
									</v-row>
								</td>
							</tr>
						</tbody>
					</v-simple-table>
				</v-col>
			</v-row>
		</v-container>

	</v-app>
</template>

<script>
	import Pagination from "../../components/pagination.vue";
	export default {
		name: "system-role",
		components: {
			Pagination
		},

		data: function() {
			return {
				role: {},
				roles: [],
				resource: {},
				resources: [],
				// json ----> list
				resourceList: [], /// 【{} {} {} {} {} {} 】

				// 资源树
				resourceStr: "",
				items: [],
				dialog: false,
				diglogRoleResource: false,
				selection: [], // 表示已经选择的数据
				// 勾选上的资源id列表
				resourceIds: [],
			}
		},

		mounted: function() {
			let _this = this;
			_this.$refs.pagination.size = 5;
			_this.list(1);
			// 加载资源树
			_this.loadResource();

		},
		watch: {


			selection: {
				// deep: true  // 可以深度检测到对象的属性值的变化
				deep: true,

				handler() {

					// changedIndex 就是发生改变的位置
					// console.log(this.selection.length)
					let _this = this;

				}

			}

		},
		methods: {
			// 获取所有小节的数据
			list(page) {
				let _this = this;
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/list', {
					page: page,
					size: _this.$refs.pagination.size,
				}).then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.roles = resp.content.list;
					_this.$refs.pagination.render(page, resp.content.total);


				})
			},
			/**
			 * 新增小节
			 */
			add() {
				let _this = this;
				_this.role = {};
				_this.dialog = true;
			},

			/**
			 * 编辑小节
			 */
			edit(role) {
				let _this = this;
				_this.role = $.extend({}, role);
				_this.dialog = true;
			},

			/**
			 * 保存
			 */
			save() {
				let _this = this;

				// 保存校验
				if (1 != 1 ||
					!Validator.require(_this.role.name, "角色") ||
					!Validator.length(_this.role.name, "角色", 1, 50) ||
					!Validator.require(_this.role.desc, "描述") ||
					!Validator.length(_this.role.desc, "描述", 1, 100)
				) {
					return;
				}

				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save', _this.role).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						_this.dialog = false,
							_this.list(1);
						Toast.success("保存成功！");
					} else {
						Toast.warning(resp.message)
					}
				})
			},

			/**
			 * 删除小节
			 */
			del(id) {
				let _this = this;
				Confirm.show("删除角色后不可恢复，确认删除？", function() {
					Loading.show();
					_this.$ajax.delete(process.env.VUE_APP_SERVER + '/system/admin/role/delete/' + id).then((response) => {
						Loading.hide();
						let resp = response.data;
						if (resp.success) {
							_this.list(1);
							Toast.success("删除成功！");
						}
					})
				});
			},

			/**
			 * 角色资源关联
			 */
			editResource(role) {
				let _this = this;
				// console.log("当前角色id", role.id);
				// 清空之前选择的
				_this.selection = [];
				_this.role = $.extend({}, role);
				_this.diglogRoleResource = true;
			},

			/**
			 * 资源模态框点击保存
			 */
			saveResource() {
				let _this = this;
				_this.resourceIds = [];

				// 把最底层的子节点插入到资源id数组中
				for (let i = 0; i < _this.selection.length; ++i) {
					_this.resourceIds.push(_this.selection[i].id);
				}

				// js数组对象查找 返回一个对象
				// console.log(_this.selection.find( a => {return a.id == "00"}));
				_this.findAllFathers();
				// console.log(_this.resourceIds);

				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save-resource', {
					id: _this.role.id,
					resourceIds: _this.resourceIds
				}).then((response) => {
					let resp = response.data;
					if (resp.success) {
						_this.diglogRoleResource = false; // 关闭模态框
						Toast.success("保存成功!");
					} else {
						Toast.warning(resp.message);
					}
				});
			},

			/**
			 * 后续遍历所有的节点
			 */
			findAllFathers() {
				let _this = this;
				for (let i = 0; i < _this.items.length; ++i) {
					_this.help1(_this.items[i]);
				}
			},

			help1(item) {
				let _this = this;
				// push parent 

				if (!item.children) {
					// if has no children 
					// console.log(item.id);
				} else {
					for (let i = 0; i < item.children.length; ++i) {

						// if(_this.resourceIds.includes(item.children[i].name)){
						// 	_this.resourceIds.push(item.name);
						// }

						_this.help1(item.children[i]);
					}
					// process parent 
					// console.log(item.id);

					for (let i = 0; i < item.children.length; ++i) {
						if (_this.resourceIds.includes(item.children[i].id)) {
							_this.resourceIds.push(item.id);
							break;
						}
					}

				}
			},

			/**
			 * N叉树后序遍历
			 */



			/**
			 * 加载资源数
			 */
			loadResource() {
				let _this = this;
				Loading.show();
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/resource/load-tree').then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.resources = resp.content;
					_this.items = _this.resources;
					_this.selection = [];
				})
			}
		}
	}
</script>

<style>
</style>

```





后端

roleDto.java

```java
package com.lzn.dto;


import java.util.List;

public class RoleDto {

    /**
     * id
     */
    private String id;

    /**
     * 角色
     */
    private String name;

    /**
     * 描述
     */
    private String desc;

    /**
     * 资源id
     * @return
     */
    private List<String> resourceIds;

    @Override
    public String toString() {
        return "RoleDto{" +
                "id='" + id + '\'' +
                ", name='" + name + '\'' +
                ", desc='" + desc + '\'' +
                ", resourceIds=" + resourceIds +
                '}';
    }

    public List<String> getResourceIds() {
        return resourceIds;
    }

    public void setResourceIds(List<String> resourceIds) {
        this.resourceIds = resourceIds;
    }

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getDesc() {
        return desc;
    }

    public void setDesc(String desc) {
        this.desc = desc;
    }


}
```



控制器

RoleController.java

```java
package com.lzn.system.controller.admin;

import com.lzn.dto.RoleDto;
import com.lzn.dto.PageDto;
import com.lzn.dto.ResponseDto;
import com.lzn.service.RoleService;
import com.lzn.util.ValidatorUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/admin/role")
public class RoleController {

    public static final String BUSINESS_NAME = "角色";

    @Autowired
    private RoleService roleService;

    @PostMapping("/list")
    public ResponseDto list(@RequestBody PageDto pageDto) {
        ResponseDto responseDto = new ResponseDto();
        roleService.list(pageDto);
        responseDto.setContent(pageDto);
        return responseDto;
    }
    @PostMapping("/save")
    public ResponseDto save(@RequestBody RoleDto roleDto){
        // 保存校验
        ValidatorUtil.require(roleDto.getName(), "角色");
        ValidatorUtil.length(roleDto.getName(), "角色", 1, 50);
        ValidatorUtil.require(roleDto.getDesc(), "描述");
        ValidatorUtil.length(roleDto.getDesc(), "描述", 1, 100);


        ResponseDto responseDto = new ResponseDto();
        roleService.save(roleDto);
        responseDto.setContent(roleDto);
        return responseDto;
    }

    @DeleteMapping("/delete/{id}")
    public ResponseDto delete(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        roleService.delete(id);
        return responseDto;
    }


    /**
     * 保存资源
     * @param roleDto
     */
    @PostMapping("/save-resource")
    public ResponseDto saveResource(@RequestBody RoleDto roleDto) {
        ResponseDto<RoleDto> responseDto = new ResponseDto<>();
        roleService.saveResource(roleDto);
        responseDto.setContent(roleDto);
        return responseDto;
    }


}

```



服务器

RoleService

```java
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.*;
import com.lzn.dto.RoleDto;
import com.lzn.dto.PageDto;
import com.lzn.mapper.RoleMapper;
import com.lzn.mapper.RoleResourceMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;


@Service
public class RoleService {

    @Autowired
    private RoleMapper roleMapper;

    @Autowired
    private RoleResourceMapper roleResourceMapper;

    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        RoleExample roleExample = new RoleExample();


        List<Role> roleList = roleMapper.selectByExample(roleExample);

        PageInfo<Role> pageInfo = new PageInfo<>(roleList);
        pageDto.setTotal(pageInfo.getTotal());

        List<RoleDto> roleDtoList = new ArrayList<>();

        for(int i = 0;i<roleList.size();++i){
            Role role = roleList.get(i);
            RoleDto roleDto = new RoleDto();
            BeanUtils.copyProperties(role, roleDto);
            roleDtoList.add(roleDto);
        }
        pageDto.setList(roleDtoList);

    }

    public void save(RoleDto roleDto){
        Role role = CopyUtil.copy(roleDto, Role.class);
        if(StringUtils.isEmpty(roleDto.getId())){
            this.insert(role);
        } else {
            this.update(role);
        }
    }

    private void insert(Role role){
        role.setId(UuidUtil.getShortUuid());
        roleMapper.insert(role);
    }


    private void update(Role role){
        roleMapper.updateByPrimaryKey(role);
    }

    public void delete(String id) {
        roleMapper.deleteByPrimaryKey(id);
    }


    /**
     * 按角色保存资源
     */
    public void saveResource(RoleDto roleDto) {
        String roleId = roleDto.getId();
        List<String> resourceIds = roleDto.getResourceIds();
        // 清空库中所有的当前角色下的记录
        RoleResourceExample example = new RoleResourceExample();
        example.createCriteria().andRoleIdEqualTo(roleId);
        roleResourceMapper.deleteByExample(example);

        // 保存角色资源
        for (int i = 0; i < resourceIds.size(); i++) {
            RoleResource roleResource = new RoleResource();
            roleResource.setId(UuidUtil.getShortUuid());
            roleResource.setRoleId(roleId);
            roleResource.setResourceId(resourceIds.get(i));
            roleResourceMapper.insert(roleResource);
        }
    }
}

```



## 获取每个角色的资源

role.vue

```vue
<!-- 小节页面 -->
<template>
	<v-app class="ma-3" app>
		<v-dialog v-model="dialog" persistent max-width="300">
			<v-card>
				<v-card-title>
					表单
				</v-card-title>

				<v-card-text>
					<v-col cols="12">
						<v-text-field label="角色" v-model="role.name" required></v-text-field>
					</v-col>
					<v-col cols="12">
						<v-text-field label="描述" v-model="role.desc" required></v-text-field>
					</v-col>
				</v-card-text>
				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialog = false" class="warning">
						取消
					</v-btn>

					<v-btn @click="save()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>

		<!-- 角色资源关联配置 -->
		<v-dialog v-model="diglogRoleResource" persistent max-width="500">
			<v-card>
				<v-card-title>
					角色资源关联配置
				</v-card-title>

				<!-- <v-card-text> -->
				<v-treeview selectable :items="items" v-model="selection" selection-type="leaf" return-object></v-treeview>
				<!-- </v-card-text> -->

				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="diglogRoleResource = false" class="info">
						取消
					</v-btn>

					<v-btn @click="saveResource()" class="warning">
						保存
					</v-btn>

				</v-card-actions>
			</v-card>
		</v-dialog>



		<p class="ma-10">

			<v-btn class="mr-5 mb-5" color="primary" @click="add()">
				<v-icon left small>add</v-icon>
				新增
			</v-btn>

			<v-btn class="mb-5" color="primary" @click="list(1)">
				<v-icon left small>refresh</v-icon>
				刷新
			</v-btn>

		</p>


		<pagination ref="pagination" v-bind:list="list" v-bind:itemCount="5"></pagination>


		<v-container>
			<v-row>
				<v-col cols="12">
					<v-simple-table>
						<thead>
							<tr>
								<th class="primary--text text-h6 text-center">id</th>
								<th class="primary--text text-h6 text-center">角色</th>
								<th class="primary--text text-h6 text-center">描述</th>
								<th class="primary--text  text-h6 text-center">
									操作
								</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="role in roles" class="text-center">

								<td>{{role.id}}</td>
								<td>{{role.name}}</td>
								<td>{{role.desc}}</td>

								<td>
									<v-row align="center" justify="space-around">
										<v-btn x-small fab @click="editResource(role)" class="success">
											<v-icon>lock</v-icon>
										</v-btn>

										<v-btn x-small fab @click="edit(role)" class="primary">
											<v-icon>edit</v-icon>
										</v-btn>

										<v-btn x-small fab @click="del(role.id)" class="warning">
											<v-icon>delete</v-icon>
										</v-btn>
									</v-row>
								</td>
							</tr>
						</tbody>
					</v-simple-table>
				</v-col>
			</v-row>
		</v-container>

	</v-app>
</template>

<script>
	import Pagination from "../../components/pagination.vue";
	export default {
		name: "system-role",
		components: {
			Pagination
		},

		data: function() {
			return {
				role: {},
				roles: [],
				resource: {},
				resources: [],
				// json ----> list
				resourceList: [], /// 【{} {} {} {} {} {} 】

				// 资源树
				resourceStr: "",
				items: [],
				dialog: false,
				diglogRoleResource: false,
				selection: [], // 表示已经选择的数据
				// 勾选上的资源id列表
				resourceIds: [],
			}
		},

		mounted: function() {
			let _this = this;
			_this.$refs.pagination.size = 5;
			_this.list(1);
			// 加载资源树
			_this.loadResource();

		},
		watch: {


			selection: {
				// deep: true  // 可以深度检测到对象的属性值的变化
				deep: true,

				handler() {

					// changedIndex 就是发生改变的位置
					// console.log(this.selection.length)
					let _this = this;

				}

			}

		},
		methods: {
			// 获取所有小节的数据
			list(page) {
				let _this = this;
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/list', {
					page: page,
					size: _this.$refs.pagination.size,
				}).then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.roles = resp.content.list;
					_this.$refs.pagination.render(page, resp.content.total);


				})
			},
			/**
			 * 新增小节
			 */
			add() {
				let _this = this;
				_this.role = {};
				_this.dialog = true;
			},

			/**
			 * 编辑小节
			 */
			edit(role) {
				let _this = this;
				_this.role = $.extend({}, role);
				_this.dialog = true;
			},

			/**
			 * 保存
			 */
			save() {
				let _this = this;

				// 保存校验
				if (1 != 1 ||
					!Validator.require(_this.role.name, "角色") ||
					!Validator.length(_this.role.name, "角色", 1, 50) ||
					!Validator.require(_this.role.desc, "描述") ||
					!Validator.length(_this.role.desc, "描述", 1, 100)
				) {
					return;
				}

				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save', _this.role).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						_this.dialog = false,
							_this.list(1);
						Toast.success("保存成功！");
					} else {
						Toast.warning(resp.message)
					}
				})
			},

			/**
			 * 删除小节
			 */
			del(id) {
				let _this = this;
				Confirm.show("删除角色后不可恢复，确认删除？", function() {
					Loading.show();
					_this.$ajax.delete(process.env.VUE_APP_SERVER + '/system/admin/role/delete/' + id).then((response) => {
						Loading.hide();
						let resp = response.data;
						if (resp.success) {
							_this.list(1);
							Toast.success("删除成功！");
						}
					})
				});
			},

			/**
			 * 角色资源关联
			 */
			editResource(role) {
				let _this = this;
				// console.log("当前角色id", role.id);
				// 清空之前选择的
				_this.selection = [];
				_this.role = $.extend({}, role);
				// 获取每个角色的资源
				_this.listRoleResource();
				_this.diglogRoleResource = true;
			},
			/**
			 * 加载角色资源关联记录
			 */
			listRoleResource() {
				let _this = this;
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/role/list-resource/' + _this.role.id).then((response) => {
					let resp = response.data;
					let resources = resp.content;

					// 勾选查询到的资源：先把树的所有节点清空勾选，再勾选查询到的节点
					_this.selection = resources;
					// for (let i = 0; i < resources.length; i++) {
					// 	let node = _this.zTree.getNodeByParam("id", resources[i]);
					// 	_this.zTree.checkNode(node, true);
					// }
				});
			},


			/**
			 * 资源模态框点击保存
			 */
			saveResource() {
				let _this = this;
				_this.resourceIds = [];

				// 把最底层的子节点插入到资源id数组中
				for (let i = 0; i < _this.selection.length; ++i) {
					_this.resourceIds.push(_this.selection[i].id);
				}

				// js数组对象查找 返回一个对象
				// console.log(_this.selection.find( a => {return a.id == "00"}));
				_this.findAllFathers();
				// console.log(_this.resourceIds);

				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save-resource', {
					id: _this.role.id,
					resourceIds: _this.resourceIds
				}).then((response) => {
					let resp = response.data;
					if (resp.success) {
						_this.diglogRoleResource = false; // 关闭模态框
						Toast.success("保存成功!");
					} else {
						Toast.warning(resp.message);
					}
				});
			},

			/**
			 * 后续遍历所有的节点
			 */
			findAllFathers() {
				let _this = this;
				for (let i = 0; i < _this.items.length; ++i) {
					_this.help1(_this.items[i]);
				}
			},

			help1(item) {
				let _this = this;
				// push parent 

				if (!item.children) {
					// if has no children 
					// console.log(item.id);
				} else {
					for (let i = 0; i < item.children.length; ++i) {

						// if(_this.resourceIds.includes(item.children[i].name)){
						// 	_this.resourceIds.push(item.name);
						// }

						_this.help1(item.children[i]);
					}
					// process parent 
					// console.log(item.id);

					for (let i = 0; i < item.children.length; ++i) {
						if (_this.resourceIds.includes(item.children[i].id)) {
							_this.resourceIds.push(item.id);
							break;
						}
					}

				}
			},

			/**
			 * N叉树后序遍历
			 */



			/**
			 * 加载资源数
			 */
			loadResource() {
				let _this = this;
				Loading.show();
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/resource/load-tree').then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.resources = resp.content;
					_this.items = _this.resources;
					_this.selection = [];
				})
			}
		}
	}
</script>

<style>
</style>

```





批量操作的思路：先将原有的删除，再批量新增

RoleController

```
package com.lzn.system.controller.admin;

import com.lzn.dto.RoleDto;
import com.lzn.dto.PageDto;
import com.lzn.dto.ResponseDto;
import com.lzn.service.RoleService;
import com.lzn.util.ValidatorUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/admin/role")
public class RoleController {

    public static final String BUSINESS_NAME = "角色";

    @Autowired
    private RoleService roleService;

    @PostMapping("/list")
    public ResponseDto list(@RequestBody PageDto pageDto) {
        ResponseDto responseDto = new ResponseDto();
        roleService.list(pageDto);
        responseDto.setContent(pageDto);
        return responseDto;
    }
    @PostMapping("/save")
    public ResponseDto save(@RequestBody RoleDto roleDto){
        // 保存校验
        ValidatorUtil.require(roleDto.getName(), "角色");
        ValidatorUtil.length(roleDto.getName(), "角色", 1, 50);
        ValidatorUtil.require(roleDto.getDesc(), "描述");
        ValidatorUtil.length(roleDto.getDesc(), "描述", 1, 100);


        ResponseDto responseDto = new ResponseDto();
        roleService.save(roleDto);
        responseDto.setContent(roleDto);
        return responseDto;
    }

    @DeleteMapping("/delete/{id}")
    public ResponseDto delete(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        roleService.delete(id);
        return responseDto;
    }


    /**
     * 保存资源
     * @param roleDto
     */
    @PostMapping("/save-resource")
    public ResponseDto saveResource(@RequestBody RoleDto roleDto) {
        ResponseDto<RoleDto> responseDto = new ResponseDto<>();
        roleService.saveResource(roleDto);
        responseDto.setContent(roleDto);
        return responseDto;
    }

    /**
     * 加载已关联的资源
     */
    @GetMapping("/list-resource/{roleId}")
    public ResponseDto listResource(@PathVariable String roleId) {
        ResponseDto responseDto = new ResponseDto<>();
        List<String> resourceIdList = roleService.listResource(roleId);
        responseDto.setContent(resourceIdList);
        return responseDto;
    }

    

}
```



RoleService.java

```java
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.*;
import com.lzn.dto.ResourceDto;
import com.lzn.dto.RoleDto;
import com.lzn.dto.PageDto;
import com.lzn.mapper.ResourceMapper;
import com.lzn.mapper.RoleMapper;
import com.lzn.mapper.RoleResourceMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;


@Service
public class RoleService {

    @Autowired
    private RoleMapper roleMapper;

    @Autowired
    private RoleResourceMapper roleResourceMapper;

    @Autowired
    private ResourceMapper resourceMapper;

    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        RoleExample roleExample = new RoleExample();


        List<Role> roleList = roleMapper.selectByExample(roleExample);

        PageInfo<Role> pageInfo = new PageInfo<>(roleList);
        pageDto.setTotal(pageInfo.getTotal());

        List<RoleDto> roleDtoList = new ArrayList<>();

        for(int i = 0;i<roleList.size();++i){
            Role role = roleList.get(i);
            RoleDto roleDto = new RoleDto();
            BeanUtils.copyProperties(role, roleDto);
            roleDtoList.add(roleDto);
        }
        pageDto.setList(roleDtoList);

    }

    public void save(RoleDto roleDto){
        Role role = CopyUtil.copy(roleDto, Role.class);
        if(StringUtils.isEmpty(roleDto.getId())){
            this.insert(role);
        } else {
            this.update(role);
        }
    }

    private void insert(Role role){
        role.setId(UuidUtil.getShortUuid());
        roleMapper.insert(role);
    }


    private void update(Role role){
        roleMapper.updateByPrimaryKey(role);
    }

    public void delete(String id) {
        roleMapper.deleteByPrimaryKey(id);
    }


    /**
     * 按角色保存资源
     */
    public void saveResource(RoleDto roleDto) {
        String roleId = roleDto.getId();
        List<String> resourceIds = roleDto.getResourceIds();
        // 清空库中所有的当前角色下的记录
        RoleResourceExample example = new RoleResourceExample();
        example.createCriteria().andRoleIdEqualTo(roleId);
        roleResourceMapper.deleteByExample(example);

        // 保存角色资源
        for (int i = 0; i < resourceIds.size(); i++) {
            RoleResource roleResource = new RoleResource();
            roleResource.setId(UuidUtil.getShortUuid());
            roleResource.setRoleId(roleId);
            roleResource.setResourceId(resourceIds.get(i));
            roleResourceMapper.insert(roleResource);
        }
    }

    /**
     * 按角色加载资源
     * @param roleId
     */
    // 找一个资源列表
    public List<ResourceDto> listResource(String roleId) {
        RoleResourceExample example = new RoleResourceExample();
        example.createCriteria().andRoleIdEqualTo(roleId);
        // 每个角色 对应 资源的id
        List<RoleResource> roleResourceList = roleResourceMapper.selectByExample(example);
        List<ResourceDto> resourceIdList = new ArrayList<>();

        for (int i = 0, l = roleResourceList.size(); i < l; i++) {
            String id = roleResourceList.get(i).getResourceId();
            ResourceExample example2 = new ResourceExample();
            example2.createCriteria().andIdEqualTo(id);
            List<Resource> temp = resourceMapper.selectByExample(example2);
            List<ResourceDto> temp2 = CopyUtil.copyList(temp, ResourceDto.class);
            resourceIdList.add(temp2.get(0));
        }
        return resourceIdList;
    }
}

```



## 前端bug

无法正确显示已勾选的角色

前端显示的是最底层的节点



role.vue

```
<!-- 小节页面 -->
<template>
	<v-app class="ma-3" app>
		<v-dialog v-model="dialog" persistent max-width="300">
			<v-card>
				<v-card-title>
					表单
				</v-card-title>

				<v-card-text>
					<v-col cols="12">
						<v-text-field label="角色" v-model="role.name" required></v-text-field>
					</v-col>
					<v-col cols="12">
						<v-text-field label="描述" v-model="role.desc" required></v-text-field>
					</v-col>
				</v-card-text>
				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialog = false" class="warning">
						取消
					</v-btn>

					<v-btn @click="save()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>

		<!-- 角色资源关联配置 -->
		<v-dialog v-model="diglogRoleResource" persistent max-width="500">
			<v-card>
				<v-card-title>
					角色资源关联配置
				</v-card-title>

				<!-- <v-card-text> -->
				<v-treeview selectable :items="items" v-model="selection" selection-type="leaf" return-object></v-treeview>
				<!-- </v-card-text> -->

				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="diglogRoleResource = false" class="info">
						取消
					</v-btn>

					<v-btn @click="saveResource()" class="warning">
						保存
					</v-btn>

				</v-card-actions>
			</v-card>
		</v-dialog>



		<p class="ma-10">

			<v-btn class="mr-5 mb-5" color="primary" @click="add()">
				<v-icon left small>add</v-icon>
				新增
			</v-btn>

			<v-btn class="mb-5" color="primary" @click="list(1)">
				<v-icon left small>refresh</v-icon>
				刷新
			</v-btn>

		</p>


		<pagination ref="pagination" v-bind:list="list" v-bind:itemCount="5"></pagination>


		<v-container>
			<v-row>
				<v-col cols="12">
					<v-simple-table>
						<thead>
							<tr>
								<th class="primary--text text-h6 text-center">id</th>
								<th class="primary--text text-h6 text-center">角色</th>
								<th class="primary--text text-h6 text-center">描述</th>
								<th class="primary--text  text-h6 text-center">
									操作
								</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="role in roles" class="text-center">

								<td>{{role.id}}</td>
								<td>{{role.name}}</td>
								<td>{{role.desc}}</td>

								<td>
									<v-row align="center" justify="space-around">
										<v-btn x-small fab @click="editResource(role)" class="success">
											<v-icon>lock</v-icon>
										</v-btn>

										<v-btn x-small fab @click="edit(role)" class="primary">
											<v-icon>edit</v-icon>
										</v-btn>

										<v-btn x-small fab @click="del(role.id)" class="warning">
											<v-icon>delete</v-icon>
										</v-btn>
									</v-row>
								</td>
							</tr>
						</tbody>
					</v-simple-table>
				</v-col>
			</v-row>
		</v-container>

	</v-app>
</template>

<script>
	import Pagination from "../../components/pagination.vue";
	export default {
		name: "system-role",
		components: {
			Pagination
		},

		data: function() {
			return {
				role: {},
				roles: [],
				resource: {},
				resources: [],
				// json ----> list
				resourceList: [], /// 【{} {} {} {} {} {} 】

				// 资源树
				resourceStr: "",
				items: [],
				dialog: false,
				diglogRoleResource: false,
				selection: [], // 表示已经选择的数据
				// 勾选上的资源id列表
				resourceIds: [],
			}
		},

		mounted: function() {
			let _this = this;
			_this.$refs.pagination.size = 5;
			_this.list(1);
			// 加载资源树
			_this.loadResource();

		},
		watch: {


			selection: {
				// deep: true  // 可以深度检测到对象的属性值的变化
				deep: true,

				handler() {

					// changedIndex 就是发生改变的位置
					// console.log(this.selection.length)
					let _this = this;

				}

			}

		},
		methods: {
			// 获取所有小节的数据
			list(page) {
				let _this = this;
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/list', {
					page: page,
					size: _this.$refs.pagination.size,
				}).then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.roles = resp.content.list;
					_this.$refs.pagination.render(page, resp.content.total);


				})
			},
			/**
			 * 新增小节
			 */
			add() {
				let _this = this;
				_this.role = {};
				_this.dialog = true;
			},

			/**
			 * 编辑小节
			 */
			edit(role) {
				let _this = this;
				_this.role = $.extend({}, role);
				_this.dialog = true;
			},

			/**
			 * 保存
			 */
			save() {
				let _this = this;

				// 保存校验
				if (1 != 1 ||
					!Validator.require(_this.role.name, "角色") ||
					!Validator.length(_this.role.name, "角色", 1, 50) ||
					!Validator.require(_this.role.desc, "描述") ||
					!Validator.length(_this.role.desc, "描述", 1, 100)
				) {
					return;
				}

				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save', _this.role).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						_this.dialog = false,
							_this.list(1);
						Toast.success("保存成功！");
					} else {
						Toast.warning(resp.message)
					}
				})
			},

			/**
			 * 删除小节
			 */
			del(id) {
				let _this = this;
				Confirm.show("删除角色后不可恢复，确认删除？", function() {
					Loading.show();
					_this.$ajax.delete(process.env.VUE_APP_SERVER + '/system/admin/role/delete/' + id).then((response) => {
						Loading.hide();
						let resp = response.data;
						if (resp.success) {
							_this.list(1);
							Toast.success("删除成功！");
						}
					})
				});
			},

			/**
			 * 角色资源关联
			 */
			editResource(role) {
				let _this = this;
				// console.log("当前角色id", role.id);
				// 清空之前选择的
				_this.selection = [];
				_this.role = $.extend({}, role);
				// 获取每个角色的资源
				_this.listRoleResource();
				
				_this.diglogRoleResource = true;
			},
			/**
			 * 加载角色资源关联记录
			 */
			listRoleResource() {
				let _this = this;
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/role/list-resource/' + _this.role.id).then((response) => {
					let resp = response.data;
					let resources = resp.content;
					// 只需要子节点
					let childrenNode = [];
					_this.findAllNodes(resources,childrenNode);
					console.log(childrenNode);
					_this.selection = childrenNode;
				});
			},
			
			/**
			 * 找到所有子节点
			 */
			findAllNodes(resources,childrenNode) {
				let _this = this;
				for(let i = 0;i<_this.items.length;++i) {
					_this.help2(_this.items[i],resources,childrenNode);
				}
			},
			
			help2(item,resources,childrenNode) {
				let _this = this;
				if(!item.children) {
					// 没有孩子
					// 如果有 
					if(resources.find(a => {return a.id == item.id})) {
						childrenNode.push(item);
					}
				} else {
					for(let i = 0;i<item.children.length;++i) {
						_this.help2(item.children[i],resources,childrenNode);
					}
				}
			},


			/**
			 * 资源模态框点击保存
			 */
			saveResource() {
				let _this = this;
				_this.resourceIds = [];

				// 把最底层的子节点插入到资源id数组中
				for (let i = 0; i < _this.selection.length; ++i) {
					_this.resourceIds.push(_this.selection[i].id);
				}

				// js数组对象查找 返回一个对象
				// console.log(_this.selection.find( a => {return a.id == "00"}));
				_this.findAllFathers();
				// console.log(_this.resourceIds);

				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save-resource', {
					id: _this.role.id,
					resourceIds: _this.resourceIds
				}).then((response) => {
					let resp = response.data;
					if (resp.success) {
						_this.diglogRoleResource = false; // 关闭模态框
						Toast.success("保存成功!");
					} else {
						Toast.warning(resp.message);
					}
				});
			},

			/**
			 * 后续遍历所有的节点
			 */
			findAllFathers() {
				let _this = this;
				for (let i = 0; i < _this.items.length; ++i) {
					_this.help1(_this.items[i]);
				}
			},

			help1(item) {
				let _this = this;
				if (!item.children) {
					// 
				} else {
					for (let i = 0; i < item.children.length; ++i) {
						_this.help1(item.children[i]);
					}
					for (let i = 0; i < item.children.length; ++i) {
						if (_this.resourceIds.includes(item.children[i].id)) {
							_this.resourceIds.push(item.id);
							break;
						}
					}
				}
			},

			/**
			 * N叉树后序遍历
			 */



			/**
			 * 加载资源数
			 */
			loadResource() {
				let _this = this;
				Loading.show();
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/resource/load-tree').then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.resources = resp.content;
					_this.items = _this.resources;
					_this.selection = [];
				})
			}
		}
	}
</script>

<style>
</style>

```





# 总结一下：树形菜单技巧

与二叉树的后序遍历相关

```
<v-treeview selectable :items="items" v-model="selection" selection-type="leaf" return-object></v-treeview>
```

items 是指总菜单，要求有children

selection 是选中的，是子节点



pid双向,

 



## 增加用户角色相互关联



数据库

```sql
drop table if exists `role_user`;
create table `role_user` (
  `id` char(8) not null default '' comment 'id',
  `role_id` char(8) not null comment '角色|id',
  `user_id` char(8) not null comment '用户|id',
  primary key (`id`)
) engine=innodb default charset=utf8mb4 comment='角色用户关联';

insert into `role_user` values ('00000000', '00000000', '10000000');

```



mybatis 自动生成

server 自动生成

### 模态框 显示所有用户

role.vue

```vue
<!-- 小节页面 -->
<template>
	<v-app class="ma-3" app>
		<v-dialog v-model="dialog" persistent max-width="300">
			<v-card>
				<v-card-title>
					表单
				</v-card-title>

				<v-card-text>
					<v-col cols="12">
						<v-text-field label="角色" v-model="role.name" required></v-text-field>
					</v-col>
					<v-col cols="12">
						<v-text-field label="描述" v-model="role.desc" required></v-text-field>
					</v-col>
				</v-card-text>
				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialog = false" class="warning">
						取消
					</v-btn>

					<v-btn @click="save()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>

		<!-- 角色资源关联配置 -->
		<v-dialog v-model="diglogRoleResource" persistent max-width="500">
			<v-card>
				<v-card-title>
					角色资源关联配置
				</v-card-title>

				<!-- <v-card-text> -->
				<v-treeview selectable :items="items" v-model="selection" selection-type="leaf" return-object></v-treeview>
				<!-- </v-card-text> -->

				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="diglogRoleResource = false" class="info">
						取消
					</v-btn>

					<v-btn @click="saveResource()" class="warning">
						保存
					</v-btn>

				</v-card-actions>
			</v-card>
		</v-dialog>


   <!--  角色用户关联配置 -->
	 <v-dialog v-model="dialogRoleUser" persistent max-width="800" >
		 <v-card>
			 <v-card-title>
				 角色用户关联配置
			 </v-card-title>
			 
			 <v-row>
				 <v-col cols="12" md="6">
					 <v-simple-table>
					 	<thead>
					 		<tr>

					 			<th class="primary--text text-center text-h6">
					 				用户名称
					 			</th>
					 		</tr>
					 	</thead>
					 	<tbody>
					 		<tr v-for="user in users"   class="text-center">
					 			<td>{{ user.loginName }}</td>
					 		</tr>
					 	</tbody>
					 </v-simple-table>
				 </v-col>
				 
				 <v-col cols="12" md="6">
					 <v-simple-table>
					 	<thead>
					 		<tr>
					 
					 			<th class="primary--text text-center  text-h6">
					 				用户名称
					 			</th>
					 		</tr>
					 	</thead>
					 	<tbody>
					 		<tr v-for="user in roleUsers"  class="text-center">
					 			<td >{{ user.loginName }}</td>
					 		</tr>
					 	</tbody>
					 </v-simple-table>
				 </v-col>
			 </v-row>
			 
			 <v-card-actions>
				 <v-spacer></v-spacer>
				 <v-btn @click="dialogRoleUser = false" class="warning">
					  取消
				 </v-btn>
				 
				 <v-btn @click="saveUser()" class="success">
					 保存
				 </v-btn>
			 </v-card-actions>
		 </v-card>
	 </v-dialog>

		<p class="ma-10">

			<v-btn class="mr-5 mb-5" color="primary" @click="add()">
				<v-icon left small>add</v-icon>
				新增
			</v-btn>

			<v-btn class="mb-5" color="primary" @click="list(1)">
				<v-icon left small>refresh</v-icon>
				刷新
			</v-btn>

		</p>


		<pagination ref="pagination" v-bind:list="list" v-bind:itemCount="5"></pagination>


		<v-container>
			<v-row>
				<v-col cols="12">
					<v-simple-table>
						<thead>
							<tr>
								<th class="primary--text text-h6 text-center">id</th>
								<th class="primary--text text-h6 text-center">角色</th>
								<th class="primary--text text-h6 text-center">描述</th>
								<th class="primary--text  text-h6 text-center">
									操作
								</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="role in roles" class="text-center">

								<td>{{role.id}}</td>
								<td>{{role.name}}</td>
								<td>{{role.desc}}</td>

								<td>
									<v-row align="center" justify="space-around">
										<v-btn x-small fab @click="editUser(role)" class="teal">
											<v-icon>person</v-icon>
										</v-btn>
										
										<v-btn x-small fab @click="editResource(role)" class="success">
											<v-icon>folder</v-icon>
										</v-btn>

										<v-btn x-small fab @click="edit(role)" class="primary">
											<v-icon>edit</v-icon>
										</v-btn>

										<v-btn x-small fab @click="del(role.id)" class="warning">
											<v-icon>delete</v-icon>
										</v-btn>
									</v-row>
								</td>
							</tr>
						</tbody>
					</v-simple-table>
				</v-col>
			</v-row>
		</v-container>

	</v-app>
</template>

<script>
	import Pagination from "../../components/pagination.vue";
	export default {
		name: "system-role",
		components: {
			Pagination
		},

		data: function() {
			return {
				role: {},
				roles: [],
				resource: {},
				resources: [],
				// json ----> list
				resourceList: [], /// 【{} {} {} {} {} {} 】

				// 资源树
				resourceStr: "",
				items: [],
				dialog: false,
				diglogRoleResource: false,
				dialogRoleUser: false,
				selection: [], // 表示已经选择的数据
				// 勾选上的资源id列表
				resourceIds: [],
				
				users: [],
				roleUsers: [],
			}
		},

		mounted: function() {
			let _this = this;
			_this.$refs.pagination.size = 5;
			_this.list(1);
			// 加载资源树
			_this.loadResource();

		},
		watch: {


			selection: {
				// deep: true  // 可以深度检测到对象的属性值的变化
				deep: true,

				handler() {

					// changedIndex 就是发生改变的位置
					// console.log(this.selection.length)
					let _this = this;

				}

			}

		},
		methods: {
			// 获取所有小节的数据
			list(page) {
				let _this = this;
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/list', {
					page: page,
					size: _this.$refs.pagination.size,
				}).then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.roles = resp.content.list;
					_this.$refs.pagination.render(page, resp.content.total);


				})
			},
			/**
			 * 新增小节
			 */
			add() {
				let _this = this;
				_this.role = {};
				_this.dialog = true;
			},

			/**
			 * 编辑小节
			 */
			edit(role) {
				let _this = this;
				_this.role = $.extend({}, role);
				_this.dialog = true;
			},

			/**
			 * 保存
			 */
			save() {
				let _this = this;

				// 保存校验
				if (1 != 1 ||
					!Validator.require(_this.role.name, "角色") ||
					!Validator.length(_this.role.name, "角色", 1, 50) ||
					!Validator.require(_this.role.desc, "描述") ||
					!Validator.length(_this.role.desc, "描述", 1, 100)
				) {
					return;
				}

				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save', _this.role).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						_this.dialog = false,
							_this.list(1);
						Toast.success("保存成功！");
					} else {
						Toast.warning(resp.message)
					}
				})
			},

			/**
			 * 删除小节
			 */
			del(id) {
				let _this = this;
				Confirm.show("删除角色后不可恢复，确认删除？", function() {
					Loading.show();
					_this.$ajax.delete(process.env.VUE_APP_SERVER + '/system/admin/role/delete/' + id).then((response) => {
						Loading.hide();
						let resp = response.data;
						if (resp.success) {
							_this.list(1);
							Toast.success("删除成功！");
						}
					})
				});
			},
			
			
			/**
			 * 编辑角色用户关联
			 */
			editUser(role) {
				let _this = this;
				_this.role = $.extend({}, role);
				// 获取所有的用户
				_this.listUser();
				_this.dialogRoleUser = true;
			},
			
			
			   /**
       * 查询所有用户
       */
      listUser() {
        let _this = this;
        _this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/list', {
          page: 1,
          size: 9999
        }).then((response)=>{
          let resp = response.data;
          if (resp.success) {
            _this.users = resp.content.list;
            // _this.listRoleUser();
          } else {
            Toast.warning(resp.message);
          }
        })
      },

			/**
			 * 角色资源关联
			 */
			editResource(role) {
				let _this = this;
				// console.log("当前角色id", role.id);
				// 清空之前选择的
				_this.selection = [];
				_this.role = $.extend({}, role);
				// 获取每个角色的资源
				_this.listRoleResource();
				
				_this.diglogRoleResource = true;
			},
			/**
			 * 加载角色资源关联记录
			 */
			listRoleResource() {
				let _this = this;
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/role/list-resource/' + _this.role.id).then((response) => {
					let resp = response.data;
					let resources = resp.content;
					// 只需要子节点
					let childrenNode = [];
					_this.findAllNodes(resources,childrenNode);
					console.log(childrenNode);
					_this.selection = childrenNode;
				});
			},
			
			/**
			 * 找到所有子节点
			 */
			findAllNodes(resources,childrenNode) {
				let _this = this;
				for(let i = 0;i<_this.items.length;++i) {
					_this.help2(_this.items[i],resources,childrenNode);
				}
			},
			
			help2(item,resources,childrenNode) {
				let _this = this;
				if(!item.children) {
					// 没有孩子
					// 如果有 
					if(resources.find(a => {return a.id == item.id})) {
						childrenNode.push(item);
					}
				} else {
					for(let i = 0;i<item.children.length;++i) {
						_this.help2(item.children[i],resources,childrenNode);
					}
				}
			},


			/**
			 * 资源模态框点击保存
			 */
			saveResource() {
				let _this = this;
				_this.resourceIds = [];

				// 把最底层的子节点插入到资源id数组中
				for (let i = 0; i < _this.selection.length; ++i) {
					_this.resourceIds.push(_this.selection[i].id);
				}

				// js数组对象查找 返回一个对象
				// console.log(_this.selection.find( a => {return a.id == "00"}));
				_this.findAllFathers();
				// console.log(_this.resourceIds);

				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save-resource', {
					id: _this.role.id,
					resourceIds: _this.resourceIds
				}).then((response) => {
					let resp = response.data;
					if (resp.success) {
						_this.diglogRoleResource = false; // 关闭模态框
						Toast.success("保存成功!");
					} else {
						Toast.warning(resp.message);
					}
				});
			},

			/**
			 * 后续遍历所有的节点
			 */
			findAllFathers() {
				let _this = this;
				for (let i = 0; i < _this.items.length; ++i) {
					_this.help1(_this.items[i]);
				}
			},

			help1(item) {
				let _this = this;
				if (!item.children) {
					// 
				} else {
					for (let i = 0; i < item.children.length; ++i) {
						_this.help1(item.children[i]);
					}
					for (let i = 0; i < item.children.length; ++i) {
						if (_this.resourceIds.includes(item.children[i].id)) {
							_this.resourceIds.push(item.id);
							break;
						}
					}
				}
			},

			/**
			 * N叉树后序遍历
			 */
			
			
			/**
			 * 加载资源数
			 */
			loadResource() {
				let _this = this;
				Loading.show();
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/resource/load-tree').then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.resources = resp.content;
					_this.items = _this.resources;
					_this.selection = [];
				})
			}
			
			
		}
	}
</script>

<style>
</style>

```







tool.js

```js
Tool = {
	/**
	 * 空校验 null或""都返回true
	 */
	isEmpty: function(obj) {
		if ((typeof obj == 'string')) {
			// https://blog.csdn.net/dreamjay1997/article/details/86599404
			return !obj || obj.replace(/\s+/g, "") == ""
		} else {
			return (!obj || JSON.stringify(obj) === "{}" || obj.length === 0);
		}
	},

	/**
	 * 非空校验
	 */
	isNotEmpty: function(obj) {
		return !this.isEmpty(obj);
	},

	/**
	 * 长度校验
	 */
	isLength: function(str, min, max) {
		return $.trim(str).length >= min && $.trim(str).length <= max;
	},

	/**
	 * 时间格式化，date为空时取当前时间
	 */
	dateFormat: function(format, date) {
		let result;
		if (!date) {
			date = new Date();
		}
		const option = {
			"y+": date.getFullYear().toString(), // 年
			"M+": (date.getMonth() + 1).toString(), // 月
			"d+": date.getDate().toString(), // 日
			"h+": date.getHours().toString(), // 时
			"m+": date.getMinutes().toString(), // 分
			"s+": date.getSeconds().toString() // 秒
		};
		for (let i in option) {
			result = new RegExp("(" + i + ")").exec(format);
			if (result) {
				format = format.replace(result[1], (result[1].length == 1) ? (option[i]) : (option[i].padStart(result[1].length,
					"0")))
			}
		}
		return format;
	},


	/**
	 * 10进制转62进制
	 * @param number
	 * @returns {string}
	 * @private
	 */
	_10to62: function(number) {
		let chars = '0123456789abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ';
		let radix = chars.length;
		let arr = [];
		do {
			let mod = number % radix;
			number = (number - mod) / radix;
			arr.unshift(chars[mod]);
		} while (number);
		return arr.join('');
	},
	
	/**
	 * 保存登录用户
	 */
	setLoginUser: function(loginUser) {
		SessionStorage.set(SESSION_KEY_LOGIN_USER, loginUser);
	},
	
	/**
	 * 获取登录用户
	 */
	getLoginUser:function() {
		return SessionStorage.get(SESSION_KEY_LOGIN_USER) || {};
	},
	
	
	  /**
	   * 随机生成[len]长度的[radix]进制数
	   * @param len
	   * @param radix 默认62
	   * @returns {string}
	   */
	  uuid: function (len, radix) {
	    let chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split('');
	    let uuid = [];
	    radix = radix || chars.length;
	
	    for (let i = 0; i < len; i++) {
	      uuid[i] = chars[0 | Math.random() * radix];
	    }
	
	    return uuid.join('');
	  },
		
		 /**
		   * 移除对象数组中的对象
		   * @param array
		   * @param obj
		   * @returns {number}
		   */
		  removeObj: function (array, obj) {
		    let index = -1;
		    for (let i = 0; i < array.length; i++) {
		      if (array[i] === obj) {
		        array.splice(i, 1);
		        index = i;
		        break;
		      }
		    }
		    return index;
		  },


}

```





依赖vue的双向绑定特性，可以将复杂的页面操作变成，简单的数据操作

role.vue

```vue
<!-- 小节页面 -->
<template>
	<v-app class="ma-3" app>
		<v-dialog v-model="dialog" persistent max-width="300">
			<v-card>
				<v-card-title>
					表单
				</v-card-title>

				<v-card-text>
					<v-col cols="12">
						<v-text-field label="角色" v-model="role.name" required></v-text-field>
					</v-col>
					<v-col cols="12">
						<v-text-field label="描述" v-model="role.desc" required></v-text-field>
					</v-col>
				</v-card-text>
				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialog = false" class="warning">
						取消
					</v-btn>

					<v-btn @click="save()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>

		<!-- 角色资源关联配置 -->
		<v-dialog v-model="diglogRoleResource" persistent max-width="500">
			<v-card>
				<v-card-title>
					角色资源关联配置
				</v-card-title>

				<!-- <v-card-text> -->
				<v-treeview selectable :items="items" v-model="selection" selection-type="leaf" return-object></v-treeview>
				<!-- </v-card-text> -->

				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="diglogRoleResource = false" class="info">
						取消
					</v-btn>

					<v-btn @click="saveResource()" class="warning">
						保存
					</v-btn>

				</v-card-actions>
			</v-card>
		</v-dialog>


		<!--  角色用户关联配置 -->
		<v-dialog v-model="dialogRoleUser" persistent max-width="900">
			<v-card>
				<v-card-title>
					角色用户关联配置
				</v-card-title>

				<v-card-text>

					<v-row>
						<v-col cols="12" md="6">
							<v-simple-table>
								<thead>
									<tr>

										<th class="primary--text text-center text-h6">
											用户名称
										</th>
									</tr>
								</thead>
								<tbody>
									<tr v-for="user in users" class="text-center">
										<td>
											<v-row>
												<v-col cols="8">
													{{ user.loginName }}
												</v-col>
												<v-col cols="2">
													<v-icon small @click="addUser(user)" color="blue">add</v-icon>
												</v-col>

											</v-row>
										</td>
									</tr>
								</tbody>
							</v-simple-table>
						</v-col>

						<v-col cols="12" md="6">
							<v-simple-table>
								<thead>
									<tr>

										<th class="primary--text text-center  text-h6">
											角色关联用户
										</th>
									</tr>
								</thead>
								<tbody>
									<tr v-for="user in roleUsers" class="text-center">
										<td>
											<v-row>
												<v-col cols="10">
													{{ user.loginName }}
												</v-col>
												<v-col cols="2">
													<v-icon small @click="deleteUser(user)" color="warning">delete</v-icon>
												</v-col>

											</v-row>
										</td>
									</tr>
								</tbody>
							</v-simple-table>
						</v-col>
					</v-row>
				</v-card-text>

				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialogRoleUser = false" class="warning">
						取消
					</v-btn>

					<v-btn @click="saveUser()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>

		<p class="ma-10">

			<v-btn class="mr-5 mb-5" color="primary" @click="add()">
				<v-icon left small>add</v-icon>
				新增
			</v-btn>

			<v-btn class="mb-5" color="primary" @click="list(1)">
				<v-icon left small>refresh</v-icon>
				刷新
			</v-btn>

		</p>


		<pagination ref="pagination" v-bind:list="list" v-bind:itemCount="5"></pagination>


		<v-container>
			<v-row>
				<v-col cols="12">
					<v-simple-table>
						<thead>
							<tr>
								<th class="primary--text text-h6 text-center">id</th>
								<th class="primary--text text-h6 text-center">角色</th>
								<th class="primary--text text-h6 text-center">描述</th>
								<th class="primary--text  text-h6 text-center">
									操作
								</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="role in roles" class="text-center">

								<td>{{role.id}}</td>
								<td>{{role.name}}</td>
								<td>{{role.desc}}</td>

								<td>
									<v-row align="center" justify="space-around">
										<v-btn x-small fab @click="editUser(role)" class="teal">
											<v-icon>person</v-icon>
										</v-btn>

										<v-btn x-small fab @click="editResource(role)" class="success">
											<v-icon>folder</v-icon>
										</v-btn>

										<v-btn x-small fab @click="edit(role)" class="primary">
											<v-icon>edit</v-icon>
										</v-btn>

										<v-btn x-small fab @click="del(role.id)" class="warning">
											<v-icon>delete</v-icon>
										</v-btn>
									</v-row>
								</td>
							</tr>
						</tbody>
					</v-simple-table>
				</v-col>
			</v-row>
		</v-container>

	</v-app>
</template>

<script>
	import Pagination from "../../components/pagination.vue";
	export default {
		name: "system-role",
		components: {
			Pagination
		},

		data: function() {
			return {
				role: {},
				roles: [],
				resource: {},
				resources: [],
				// json ----> list
				resourceList: [], /// 【{} {} {} {} {} {} 】

				// 资源树
				resourceStr: "",
				items: [],
				dialog: false,
				diglogRoleResource: false,
				dialogRoleUser: false,
				selection: [], // 表示已经选择的数据
				// 勾选上的资源id列表
				resourceIds: [],

				users: [],
				roleUsers: [],
			}
		},

		mounted: function() {
			let _this = this;
			_this.$refs.pagination.size = 5;
			_this.list(1);
			// 加载资源树
			_this.loadResource();

		},
		watch: {


			selection: {
				// deep: true  // 可以深度检测到对象的属性值的变化
				deep: true,

				handler() {

					// changedIndex 就是发生改变的位置
					// console.log(this.selection.length)
					let _this = this;

				}

			}

		},
		methods: {
			// 获取所有小节的数据
			list(page) {
				let _this = this;
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/list', {
					page: page,
					size: _this.$refs.pagination.size,
				}).then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.roles = resp.content.list;
					_this.$refs.pagination.render(page, resp.content.total);


				})
			},
			/**
			 * 新增小节
			 */
			add() {
				let _this = this;
				_this.role = {};
				_this.dialog = true;
			},

			/**
			 * 编辑小节
			 */
			edit(role) {
				let _this = this;
				_this.role = $.extend({}, role);
				_this.dialog = true;
			},

			/**
			 * 保存
			 */
			save() {
				let _this = this;

				// 保存校验
				if (1 != 1 ||
					!Validator.require(_this.role.name, "角色") ||
					!Validator.length(_this.role.name, "角色", 1, 50) ||
					!Validator.require(_this.role.desc, "描述") ||
					!Validator.length(_this.role.desc, "描述", 1, 100)
				) {
					return;
				}

				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save', _this.role).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						_this.dialog = false,
							_this.list(1);
						Toast.success("保存成功！");
					} else {
						Toast.warning(resp.message)
					}
				})
			},

			/**
			 * 删除小节
			 */
			del(id) {
				let _this = this;
				Confirm.show("删除角色后不可恢复，确认删除？", function() {
					Loading.show();
					_this.$ajax.delete(process.env.VUE_APP_SERVER + '/system/admin/role/delete/' + id).then((response) => {
						Loading.hide();
						let resp = response.data;
						if (resp.success) {
							_this.list(1);
							Toast.success("删除成功！");
						}
					})
				});
			},


			/**
			 * 编辑角色用户关联
			 */
			editUser(role) {
				let _this = this;
				_this.role = $.extend({}, role);
				// 获取所有的用户
				_this.listUser();
				_this.dialogRoleUser = true;
			},


			/**
			 * 查询所有用户
			 */
			listUser() {
				let _this = this;
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/list', {
					page: 1,
					size: 9999
				}).then((response) => {
					let resp = response.data;
					if (resp.success) {
						_this.users = resp.content.list;
						// _this.listRoleUser();
					} else {
						Toast.warning(resp.message);
					}
				})
			},


			/**
			 * 角色中增加用户
			 */
			addUser(user) {
				let _this = this;
				// 如果当前要添加的用户在右边已经有了，就不用添加
				let users = _this.roleUsers;
				// users.find(a => {return a == user;})
				// if( ) {
				// 	return ;
				// }
				for (let i = 0; i < users.length; ++i) {
					if (user == users[i]) {
						return;
					}
				}


				_this.roleUsers.push(user);
			},


			/**
			 * 删除角色关联用户
			 */
			deleteUser(user) {
				let _this = this;
				Tool.removeObj(_this.roleUsers, user);
			},

			/**
			 * 角色用户模态框点击【保存】
			 */
			saveUser() {
				let _this = this;
				let users = _this.roleUsers;

				// 保存时，只需要保存用户id，所以使用id数组进行参数传递
				let userIds = [];
				for (let i = 0; i < users.length; i++) {
					userIds.push(users[i].id);
				}
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save-user', {
					id: _this.role.id,
					userIds: userIds
				}).then((response) => {
					console.log("保存角色用户结果：", response);
					let resp = response.data;
					if (resp.success) {
						Toast.success("保存成功!");
						_this.dialogRoleUser = false;
					} else {
						Toast.warning(resp.message);
					}
				})
			},

			/**
			 * 角色资源关联
			 */
			editResource(role) {
				let _this = this;
				// console.log("当前角色id", role.id);
				// 清空之前选择的
				_this.selection = [];
				_this.role = $.extend({}, role);
				// 获取每个角色的资源
				_this.listRoleResource();

				_this.diglogRoleResource = true;
			},
			/**
			 * 加载角色资源关联记录
			 */
			listRoleResource() {
				let _this = this;
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/role/list-resource/' + _this.role.id).then((response) => {
					let resp = response.data;
					let resources = resp.content;
					// 只需要子节点
					let childrenNode = [];
					_this.findAllNodes(resources, childrenNode);
					console.log(childrenNode);
					_this.selection = childrenNode;
				});
			},

			/**
			 * 找到所有子节点
			 */
			findAllNodes(resources, childrenNode) {
				let _this = this;
				for (let i = 0; i < _this.items.length; ++i) {
					_this.help2(_this.items[i], resources, childrenNode);
				}
			},

			help2(item, resources, childrenNode) {
				let _this = this;
				if (!item.children) {
					// 没有孩子
					// 如果有 
					if (resources.find(a => {
							return a.id == item.id
						})) {
						childrenNode.push(item);
					}
				} else {
					for (let i = 0; i < item.children.length; ++i) {
						_this.help2(item.children[i], resources, childrenNode);
					}
				}
			},


			/**
			 * 资源模态框点击保存
			 */
			saveResource() {
				let _this = this;
				_this.resourceIds = [];

				// 把最底层的子节点插入到资源id数组中
				for (let i = 0; i < _this.selection.length; ++i) {
					_this.resourceIds.push(_this.selection[i].id);
				}

				// js数组对象查找 返回一个对象
				// console.log(_this.selection.find( a => {return a.id == "00"}));
				_this.findAllFathers();
				// console.log(_this.resourceIds);

				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save-resource', {
					id: _this.role.id,
					resourceIds: _this.resourceIds
				}).then((response) => {
					let resp = response.data;
					if (resp.success) {
						_this.diglogRoleResource = false; // 关闭模态框
						Toast.success("保存成功!");
					} else {
						Toast.warning(resp.message);
					}
				});
			},

			/**
			 * 后续遍历所有的节点
			 */
			findAllFathers() {
				let _this = this;
				for (let i = 0; i < _this.items.length; ++i) {
					_this.help1(_this.items[i]);
				}
			},

			help1(item) {
				let _this = this;
				if (!item.children) {
					// 
				} else {
					for (let i = 0; i < item.children.length; ++i) {
						_this.help1(item.children[i]);
					}
					for (let i = 0; i < item.children.length; ++i) {
						if (_this.resourceIds.includes(item.children[i].id)) {
							_this.resourceIds.push(item.id);
							break;
						}
					}
				}
			},

			/**
			 * N叉树后序遍历
			 */


			/**
			 * 加载资源数
			 */
			loadResource() {
				let _this = this;
				Loading.show();
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/resource/load-tree').then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.resources = resp.content;
					_this.items = _this.resources;
					_this.selection = [];
				})
			}


		}
	}
</script>

<style>
</style>

```





后端

roleDto.java

```java
package com.lzn.dto;


import java.util.List;

public class RoleDto {

    /**
     * id
     */
    private String id;

    /**
     * 角色
     */
    private String name;

    /**
     * 描述
     */
    private String desc;

    @Override
    public String toString() {
        return "RoleDto{" +
                "id='" + id + '\'' +
                ", name='" + name + '\'' +
                ", desc='" + desc + '\'' +
                ", userIds=" + userIds +
                ", resourceIds=" + resourceIds +
                '}';
    }

    public List<String> getUserIds() {
        return userIds;
    }

    public void setUserIds(List<String> userIds) {
        this.userIds = userIds;
    }

    private List<String> userIds;

    /**
     * 资源id
     * @return
     */
    private List<String> resourceIds;

    public List<String> getResourceIds() {
        return resourceIds;
    }

    public void setResourceIds(List<String> resourceIds) {
        this.resourceIds = resourceIds;
    }

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getDesc() {
        return desc;
    }

    public void setDesc(String desc) {
        this.desc = desc;
    }


}
```



RoleController.java

```
package com.lzn.system.controller.admin;

import com.lzn.dto.ResourceDto;
import com.lzn.dto.RoleDto;
import com.lzn.dto.PageDto;
import com.lzn.dto.ResponseDto;
import com.lzn.service.RoleService;
import com.lzn.util.ValidatorUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import javax.xml.ws.Response;
import java.util.List;

@RestController
@RequestMapping("/admin/role")
public class RoleController {

    public static final String BUSINESS_NAME = "角色";

    @Autowired
    private RoleService roleService;

    @PostMapping("/list")
    public ResponseDto list(@RequestBody PageDto pageDto) {
        ResponseDto responseDto = new ResponseDto();
        roleService.list(pageDto);
        responseDto.setContent(pageDto);
        return responseDto;
    }
    @PostMapping("/save")
    public ResponseDto save(@RequestBody RoleDto roleDto){
        // 保存校验
        ValidatorUtil.require(roleDto.getName(), "角色");
        ValidatorUtil.length(roleDto.getName(), "角色", 1, 50);
        ValidatorUtil.require(roleDto.getDesc(), "描述");
        ValidatorUtil.length(roleDto.getDesc(), "描述", 1, 100);


        ResponseDto responseDto = new ResponseDto();
        roleService.save(roleDto);
        responseDto.setContent(roleDto);
        return responseDto;
    }

    @DeleteMapping("/delete/{id}")
    public ResponseDto delete(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        roleService.delete(id);
        return responseDto;
    }


    /**
     * 保存资源
     * @param roleDto
     */
    @PostMapping("/save-resource")
    public ResponseDto saveResource(@RequestBody RoleDto roleDto) {
        ResponseDto<RoleDto> responseDto = new ResponseDto<>();
        roleService.saveResource(roleDto);
        responseDto.setContent(roleDto);
        return responseDto;
    }

    /**
     * 加载已关联的资源
     */
    @GetMapping("/list-resource/{roleId}")
    public ResponseDto listResource(@PathVariable String roleId) {
        ResponseDto responseDto = new ResponseDto<>();
        List<ResourceDto> resourceIdList = roleService.listResource(roleId);
        responseDto.setContent(resourceIdList);
        return responseDto;
    }

    /**
     * 保存用户
     * @param roleDto
     */
    @PostMapping("/save-user")
    public ResponseDto saveUser(@RequestBody RoleDto roleDto) {
        ResponseDto<RoleDto> responseDto = new ResponseDto<>();
        roleService.saveUser(roleDto);
        responseDto.setContent(roleDto);
        return responseDto;
    }

}
```





RoleService.java

```
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.*;
import com.lzn.dto.ResourceDto;
import com.lzn.dto.RoleDto;
import com.lzn.dto.PageDto;
import com.lzn.mapper.*;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;


@Service
public class RoleService {

    @Autowired
    private RoleMapper roleMapper;

    @Autowired
    private RoleResourceMapper roleResourceMapper;

    @Autowired
    private ResourceMapper resourceMapper;

    @Autowired
    private RoleUserMapper roleUserMapper;
    

    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        RoleExample roleExample = new RoleExample();


        List<Role> roleList = roleMapper.selectByExample(roleExample);

        PageInfo<Role> pageInfo = new PageInfo<>(roleList);
        pageDto.setTotal(pageInfo.getTotal());

        List<RoleDto> roleDtoList = new ArrayList<>();

        for(int i = 0;i<roleList.size();++i){
            Role role = roleList.get(i);
            RoleDto roleDto = new RoleDto();
            BeanUtils.copyProperties(role, roleDto);
            roleDtoList.add(roleDto);
        }
        pageDto.setList(roleDtoList);

    }

    public void save(RoleDto roleDto){
        Role role = CopyUtil.copy(roleDto, Role.class);
        if(StringUtils.isEmpty(roleDto.getId())){
            this.insert(role);
        } else {
            this.update(role);
        }
    }

    private void insert(Role role){
        role.setId(UuidUtil.getShortUuid());
        roleMapper.insert(role);
    }


    private void update(Role role){
        roleMapper.updateByPrimaryKey(role);
    }

    public void delete(String id) {
        roleMapper.deleteByPrimaryKey(id);
    }


    /**
     * 按角色保存资源
     */
    public void saveResource(RoleDto roleDto) {
        String roleId = roleDto.getId();
        List<String> resourceIds = roleDto.getResourceIds();
        // 清空库中所有的当前角色下的记录
        RoleResourceExample example = new RoleResourceExample();
        example.createCriteria().andRoleIdEqualTo(roleId);
        roleResourceMapper.deleteByExample(example);

        // 保存角色资源
        for (int i = 0; i < resourceIds.size(); i++) {
            RoleResource roleResource = new RoleResource();
            roleResource.setId(UuidUtil.getShortUuid());
            roleResource.setRoleId(roleId);
            roleResource.setResourceId(resourceIds.get(i));
            roleResourceMapper.insert(roleResource);
        }
    }

    /**
     * 按角色加载资源
     * @param roleId
     */
    // 找一个资源列表
    public List<ResourceDto> listResource(String roleId) {
        RoleResourceExample example = new RoleResourceExample();
        example.createCriteria().andRoleIdEqualTo(roleId);
        // 每个角色 对应 资源的id
        List<RoleResource> roleResourceList = roleResourceMapper.selectByExample(example);
        List<ResourceDto> resourceIdList = new ArrayList<>();

        for (int i = 0, l = roleResourceList.size(); i < l; i++) {
            String id = roleResourceList.get(i).getResourceId();
            ResourceExample example2 = new ResourceExample();
            example2.createCriteria().andIdEqualTo(id);
            List<Resource> temp = resourceMapper.selectByExample(example2);
            List<ResourceDto> temp2 = CopyUtil.copyList(temp, ResourceDto.class);
            resourceIdList.add(temp2.get(0));
        }
        return resourceIdList;
    }

    /**
     * 按角色保存用户
     */
    public void saveUser(RoleDto roleDto) {
        String roleId = roleDto.getId();
        List<String> userIdList = roleDto.getUserIds();
        // 清空库中所有的当前角色下的记录
        RoleUserExample example = new RoleUserExample();
        example.createCriteria().andRoleIdEqualTo(roleId);
        roleUserMapper.deleteByExample(example);

        // 保存角色用户
        for (int i = 0; i < userIdList.size(); i++) {
            RoleUser roleUser = new RoleUser();
            roleUser.setId(UuidUtil.getShortUuid());
            roleUser.setRoleId(roleId);
            roleUser.setUserId(userIdList.get(i));
            roleUserMapper.insert(roleUser);
        }
    }

}
```





## 按照角色加载用户

前端

role.vue

```vue
<!-- 小节页面 -->
<template>
	<v-app class="ma-3" app>
		<v-dialog v-model="dialog" persistent max-width="300">
			<v-card>
				<v-card-title>
					表单
				</v-card-title>

				<v-card-text>
					<v-col cols="12">
						<v-text-field label="角色" v-model="role.name" required></v-text-field>
					</v-col>
					<v-col cols="12">
						<v-text-field label="描述" v-model="role.desc" required></v-text-field>
					</v-col>
				</v-card-text>
				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialog = false" class="warning">
						取消
					</v-btn>

					<v-btn @click="save()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>

		<!-- 角色资源关联配置 -->
		<v-dialog v-model="diglogRoleResource" persistent max-width="500">
			<v-card>
				<v-card-title>
					角色资源关联配置
				</v-card-title>

				<!-- <v-card-text> -->
				<v-treeview selectable :items="items" v-model="selection" selection-type="leaf" return-object></v-treeview>
				<!-- </v-card-text> -->

				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="diglogRoleResource = false" class="info">
						取消
					</v-btn>

					<v-btn @click="saveResource()" class="warning">
						保存
					</v-btn>

				</v-card-actions>
			</v-card>
		</v-dialog>


		<!--  角色用户关联配置 -->
		<v-dialog v-model="dialogRoleUser" persistent max-width="900">
			<v-card>
				<v-card-title>
					角色用户关联配置
				</v-card-title>

				<v-card-text>

					<v-row>
						<v-col cols="12" md="6">
							<v-simple-table>
								<thead>
									<tr>

										<th class="primary--text text-center text-h6">
											用户名称
										</th>
									</tr>
								</thead>
								<tbody>
									<tr v-for="user in users" class="text-center">
										<td>
											<v-row>
												<v-col cols="8">
													{{ user.loginName }}
												</v-col>
												<v-col cols="2">
													<v-icon small @click="addUser(user)" color="blue">add</v-icon>
												</v-col>

											</v-row>
										</td>
									</tr>
								</tbody>
							</v-simple-table>
						</v-col>

						<v-col cols="12" md="6">
							<v-simple-table>
								<thead>
									<tr>

										<th class="primary--text text-center  text-h6">
											角色关联用户
										</th>
									</tr>
								</thead>
								<tbody>
									<tr v-for="user in roleUsers" class="text-center">
										<td>
											<v-row>
												<v-col cols="10">
													{{ user.loginName }}
												</v-col>
												<v-col cols="2">
													<v-icon small @click="deleteUser(user)" color="warning">delete</v-icon>
												</v-col>

											</v-row>
										</td>
									</tr>
								</tbody>
							</v-simple-table>
						</v-col>
					</v-row>
				</v-card-text>

				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialogRoleUser = false" class="warning">
						取消
					</v-btn>

					<v-btn @click="saveUser()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>

		<p class="ma-10">

			<v-btn class="mr-5 mb-5" color="primary" @click="add()">
				<v-icon left small>add</v-icon>
				新增
			</v-btn>

			<v-btn class="mb-5" color="primary" @click="list(1)">
				<v-icon left small>refresh</v-icon>
				刷新
			</v-btn>

		</p>


		<pagination ref="pagination" v-bind:list="list" v-bind:itemCount="5"></pagination>


		<v-container>
			<v-row>
				<v-col cols="12">
					<v-simple-table>
						<thead>
							<tr>
								<th class="primary--text text-h6 text-center">id</th>
								<th class="primary--text text-h6 text-center">角色</th>
								<th class="primary--text text-h6 text-center">描述</th>
								<th class="primary--text  text-h6 text-center">
									操作
								</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="role in roles" class="text-center">

								<td>{{role.id}}</td>
								<td>{{role.name}}</td>
								<td>{{role.desc}}</td>

								<td>
									<v-row align="center" justify="space-around">
										<v-btn x-small fab @click="editUser(role)" class="teal">
											<v-icon>person</v-icon>
										</v-btn>

										<v-btn x-small fab @click="editResource(role)" class="success">
											<v-icon>folder</v-icon>
										</v-btn>

										<v-btn x-small fab @click="edit(role)" class="primary">
											<v-icon>edit</v-icon>
										</v-btn>

										<v-btn x-small fab @click="del(role.id)" class="warning">
											<v-icon>delete</v-icon>
										</v-btn>
									</v-row>
								</td>
							</tr>
						</tbody>
					</v-simple-table>
				</v-col>
			</v-row>
		</v-container>

	</v-app>
</template>

<script>
	import Pagination from "../../components/pagination.vue";
	export default {
		name: "system-role",
		components: {
			Pagination
		},

		data: function() {
			return {
				role: {},
				roles: [],
				resource: {},
				resources: [],
				// json ----> list
				resourceList: [], /// 【{} {} {} {} {} {} 】

				// 资源树
				resourceStr: "",
				items: [],
				dialog: false,
				diglogRoleResource: false,
				dialogRoleUser: false,
				selection: [], // 表示已经选择的数据
				// 勾选上的资源id列表
				resourceIds: [],

				users: [],
				roleUsers: [],
			}
		},

		mounted: function() {
			let _this = this;
			_this.$refs.pagination.size = 5;
			_this.list(1);
			// 加载资源树
			_this.loadResource();

		},
		watch: {


			selection: {
				// deep: true  // 可以深度检测到对象的属性值的变化
				deep: true,

				handler() {

					// changedIndex 就是发生改变的位置
					// console.log(this.selection.length)
					let _this = this;

				}

			}

		},
		methods: {
			// 获取所有小节的数据
			list(page) {
				let _this = this;
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/list', {
					page: page,
					size: _this.$refs.pagination.size,
				}).then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.roles = resp.content.list;
					_this.$refs.pagination.render(page, resp.content.total);


				})
			},
			/**
			 * 新增小节
			 */
			add() {
				let _this = this;
				_this.role = {};
				_this.dialog = true;
			},

			/**
			 * 编辑小节
			 */
			edit(role) {
				let _this = this;
				_this.role = $.extend({}, role);
				_this.dialog = true;
			},

			/**
			 * 保存
			 */
			save() {
				let _this = this;

				// 保存校验
				if (1 != 1 ||
					!Validator.require(_this.role.name, "角色") ||
					!Validator.length(_this.role.name, "角色", 1, 50) ||
					!Validator.require(_this.role.desc, "描述") ||
					!Validator.length(_this.role.desc, "描述", 1, 100)
				) {
					return;
				}

				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save', _this.role).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						_this.dialog = false,
							_this.list(1);
						Toast.success("保存成功！");
					} else {
						Toast.warning(resp.message)
					}
				})
			},

			/**
			 * 删除小节
			 */
			del(id) {
				let _this = this;
				Confirm.show("删除角色后不可恢复，确认删除？", function() {
					Loading.show();
					_this.$ajax.delete(process.env.VUE_APP_SERVER + '/system/admin/role/delete/' + id).then((response) => {
						Loading.hide();
						let resp = response.data;
						if (resp.success) {
							_this.list(1);
							Toast.success("删除成功！");
						}
					})
				});
			},


			/**
			 * 编辑角色用户关联
			 */
			editUser(role) {
				let _this = this;
				_this.role = $.extend({}, role);
				// 获取所有的用户
				_this.listUser();
				_this.dialogRoleUser = true;
			},


			/**
			 * 查询所有用户
			 */
			listUser() {
				let _this = this;
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/list', {
					page: 1,
					size: 9999
				}).then((response) => {
					let resp = response.data;
					if (resp.success) {
						_this.users = resp.content.list;
						_this.listRoleUser();
					} else {
						Toast.warning(resp.message);
					}
				})
			},

      /**
       * 加载角色用户
       */
      listRoleUser() {
        let _this = this;
        _this.roleUsers = [];
        _this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/role/list-user/' + _this.role.id).then((res)=>{
          let response = res.data;
          let userIds = response.content;

          // 根据加载到用户ID，到【所有用户数组：users】中查找用户对象，用于列表显示
          for (let i = 0; i < userIds.length; i++) {
            for (let j = 0; j < _this.users.length; j++) {
              if (userIds[i] === _this.users[j].id) {
                _this.roleUsers.push(_this.users[j]);
              }
            }
          }
        });
      },

			/**
			 * 角色中增加用户
			 */
			addUser(user) {
				let _this = this;
				// 如果当前要添加的用户在右边已经有了，就不用添加
				let users = _this.roleUsers;
				// users.find(a => {return a == user;})
				// if( ) {
				// 	return ;
				// }
				for (let i = 0; i < users.length; ++i) {
					if (user == users[i]) {
						return;
					}
				}


				_this.roleUsers.push(user);
			},


			/**
			 * 删除角色关联用户
			 */
			deleteUser(user) {
				let _this = this;
				Tool.removeObj(_this.roleUsers, user);
			},

			/**
			 * 角色用户模态框点击【保存】
			 */
			saveUser() {
				let _this = this;
				let users = _this.roleUsers;

				// 保存时，只需要保存用户id，所以使用id数组进行参数传递
				let userIds = [];
				for (let i = 0; i < users.length; i++) {
					userIds.push(users[i].id);
				}
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save-user', {
					id: _this.role.id,
					userIds: userIds
				}).then((response) => {
					console.log("保存角色用户结果：", response);
					let resp = response.data;
					if (resp.success) {
						Toast.success("保存成功!");
						_this.dialogRoleUser = false;
					} else {
						Toast.warning(resp.message);
					}
				})
			},

			/**
			 * 角色资源关联
			 */
			editResource(role) {
				let _this = this;
				// console.log("当前角色id", role.id);
				// 清空之前选择的
				_this.selection = [];
				_this.role = $.extend({}, role);
				// 获取每个角色的资源
				_this.listRoleResource();

				_this.diglogRoleResource = true;
			},
			/**
			 * 加载角色资源关联记录
			 */
			listRoleResource() {
				let _this = this;
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/role/list-resource/' + _this.role.id).then((response) => {
					let resp = response.data;
					let resources = resp.content;
					// 只需要子节点
					let childrenNode = [];
					_this.findAllNodes(resources, childrenNode);
					console.log(childrenNode);
					_this.selection = childrenNode;
				});
			},

			/**
			 * 找到所有子节点
			 */
			findAllNodes(resources, childrenNode) {
				let _this = this;
				for (let i = 0; i < _this.items.length; ++i) {
					_this.help2(_this.items[i], resources, childrenNode);
				}
			},

			help2(item, resources, childrenNode) {
				let _this = this;
				if (!item.children) {
					// 没有孩子
					// 如果有 
					if (resources.find(a => {
							return a.id == item.id
						})) {
						childrenNode.push(item);
					}
				} else {
					for (let i = 0; i < item.children.length; ++i) {
						_this.help2(item.children[i], resources, childrenNode);
					}
				}
			},


			/**
			 * 资源模态框点击保存
			 */
			saveResource() {
				let _this = this;
				_this.resourceIds = [];

				// 把最底层的子节点插入到资源id数组中
				for (let i = 0; i < _this.selection.length; ++i) {
					_this.resourceIds.push(_this.selection[i].id);
				}

				// js数组对象查找 返回一个对象
				// console.log(_this.selection.find( a => {return a.id == "00"}));
				_this.findAllFathers();
				// console.log(_this.resourceIds);

				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/role/save-resource', {
					id: _this.role.id,
					resourceIds: _this.resourceIds
				}).then((response) => {
					let resp = response.data;
					if (resp.success) {
						_this.diglogRoleResource = false; // 关闭模态框
						Toast.success("保存成功!");
					} else {
						Toast.warning(resp.message);
					}
				});
			},

			/**
			 * 后续遍历所有的节点
			 */
			findAllFathers() {
				let _this = this;
				for (let i = 0; i < _this.items.length; ++i) {
					_this.help1(_this.items[i]);
				}
			},

			help1(item) {
				let _this = this;
				if (!item.children) {
					// 
				} else {
					for (let i = 0; i < item.children.length; ++i) {
						_this.help1(item.children[i]);
					}
					for (let i = 0; i < item.children.length; ++i) {
						if (_this.resourceIds.includes(item.children[i].id)) {
							_this.resourceIds.push(item.id);
							break;
						}
					}
				}
			},

			/**
			 * N叉树后序遍历
			 */


			/**
			 * 加载资源数
			 */
			loadResource() {
				let _this = this;
				Loading.show();
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/resource/load-tree').then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.resources = resp.content;
					_this.items = _this.resources;
					_this.selection = [];
				})
			}


		}
	}
</script>

<style>
</style>

```



后端

```java
package com.lzn.system.controller.admin;

import com.lzn.dto.ResourceDto;
import com.lzn.dto.RoleDto;
import com.lzn.dto.PageDto;
import com.lzn.dto.ResponseDto;
import com.lzn.service.RoleService;
import com.lzn.util.ValidatorUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import javax.xml.ws.Response;
import java.util.List;

@RestController
@RequestMapping("/admin/role")
public class RoleController {

    public static final String BUSINESS_NAME = "角色";

    @Autowired
    private RoleService roleService;

    @PostMapping("/list")
    public ResponseDto list(@RequestBody PageDto pageDto) {
        ResponseDto responseDto = new ResponseDto();
        roleService.list(pageDto);
        responseDto.setContent(pageDto);
        return responseDto;
    }
    @PostMapping("/save")
    public ResponseDto save(@RequestBody RoleDto roleDto){
        // 保存校验
        ValidatorUtil.require(roleDto.getName(), "角色");
        ValidatorUtil.length(roleDto.getName(), "角色", 1, 50);
        ValidatorUtil.require(roleDto.getDesc(), "描述");
        ValidatorUtil.length(roleDto.getDesc(), "描述", 1, 100);


        ResponseDto responseDto = new ResponseDto();
        roleService.save(roleDto);
        responseDto.setContent(roleDto);
        return responseDto;
    }

    @DeleteMapping("/delete/{id}")
    public ResponseDto delete(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        roleService.delete(id);
        return responseDto;
    }


    /**
     * 保存资源
     * @param roleDto
     */
    @PostMapping("/save-resource")
    public ResponseDto saveResource(@RequestBody RoleDto roleDto) {
        ResponseDto<RoleDto> responseDto = new ResponseDto<>();
        roleService.saveResource(roleDto);
        responseDto.setContent(roleDto);
        return responseDto;
    }

    /**
     * 加载已关联的资源
     */
    @GetMapping("/list-resource/{roleId}")
    public ResponseDto listResource(@PathVariable String roleId) {
        ResponseDto responseDto = new ResponseDto<>();
        List<ResourceDto> resourceIdList = roleService.listResource(roleId);
        responseDto.setContent(resourceIdList);
        return responseDto;
    }

    /**
     * 保存用户
     * @param roleDto
     */
    @PostMapping("/save-user")
    public ResponseDto saveUser(@RequestBody RoleDto roleDto) {
        ResponseDto<RoleDto> responseDto = new ResponseDto<>();
        roleService.saveUser(roleDto);
        responseDto.setContent(roleDto);
        return responseDto;
    }

    /**
     * 加载用户
     * @param roleId
     */
    @GetMapping("/list-user/{roleId}")
    public ResponseDto listUser(@PathVariable String roleId) {
        ResponseDto responseDto = new ResponseDto<>();
        List<String> userIdList = roleService.listUser(roleId);
        responseDto.setContent(userIdList);
        return responseDto;
    }
}

```



```
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.*;
import com.lzn.dto.ResourceDto;
import com.lzn.dto.RoleDto;
import com.lzn.dto.PageDto;
import com.lzn.mapper.*;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;


@Service
public class RoleService {

    @Autowired
    private RoleMapper roleMapper;

    @Autowired
    private RoleResourceMapper roleResourceMapper;

    @Autowired
    private ResourceMapper resourceMapper;

    @Autowired
    private RoleUserMapper roleUserMapper;


    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        RoleExample roleExample = new RoleExample();


        List<Role> roleList = roleMapper.selectByExample(roleExample);

        PageInfo<Role> pageInfo = new PageInfo<>(roleList);
        pageDto.setTotal(pageInfo.getTotal());

        List<RoleDto> roleDtoList = new ArrayList<>();

        for(int i = 0;i<roleList.size();++i){
            Role role = roleList.get(i);
            RoleDto roleDto = new RoleDto();
            BeanUtils.copyProperties(role, roleDto);
            roleDtoList.add(roleDto);
        }
        pageDto.setList(roleDtoList);

    }

    public void save(RoleDto roleDto){
        Role role = CopyUtil.copy(roleDto, Role.class);
        if(StringUtils.isEmpty(roleDto.getId())){
            this.insert(role);
        } else {
            this.update(role);
        }
    }

    private void insert(Role role){
        role.setId(UuidUtil.getShortUuid());
        roleMapper.insert(role);
    }


    private void update(Role role){
        roleMapper.updateByPrimaryKey(role);
    }

    public void delete(String id) {
        roleMapper.deleteByPrimaryKey(id);
    }


    /**
     * 按角色保存资源
     */
    public void saveResource(RoleDto roleDto) {
        String roleId = roleDto.getId();
        List<String> resourceIds = roleDto.getResourceIds();
        // 清空库中所有的当前角色下的记录
        RoleResourceExample example = new RoleResourceExample();
        example.createCriteria().andRoleIdEqualTo(roleId);
        roleResourceMapper.deleteByExample(example);

        // 保存角色资源
        for (int i = 0; i < resourceIds.size(); i++) {
            RoleResource roleResource = new RoleResource();
            roleResource.setId(UuidUtil.getShortUuid());
            roleResource.setRoleId(roleId);
            roleResource.setResourceId(resourceIds.get(i));
            roleResourceMapper.insert(roleResource);
        }
    }

    /**
     * 按角色加载资源
     * @param roleId
     */
    // 找一个资源列表
    public List<ResourceDto> listResource(String roleId) {
        RoleResourceExample example = new RoleResourceExample();
        example.createCriteria().andRoleIdEqualTo(roleId);
        // 每个角色 对应 资源的id
        List<RoleResource> roleResourceList = roleResourceMapper.selectByExample(example);
        List<ResourceDto> resourceIdList = new ArrayList<>();

        for (int i = 0, l = roleResourceList.size(); i < l; i++) {
            String id = roleResourceList.get(i).getResourceId();
            ResourceExample example2 = new ResourceExample();
            example2.createCriteria().andIdEqualTo(id);
            List<Resource> temp = resourceMapper.selectByExample(example2);
            List<ResourceDto> temp2 = CopyUtil.copyList(temp, ResourceDto.class);
            resourceIdList.add(temp2.get(0));
        }
        return resourceIdList;
    }

    /**
     * 按角色保存用户
     */
    public void saveUser(RoleDto roleDto) {
        String roleId = roleDto.getId();
        List<String> userIdList = roleDto.getUserIds();
        // 清空库中所有的当前角色下的记录
        RoleUserExample example = new RoleUserExample();
        example.createCriteria().andRoleIdEqualTo(roleId);
        roleUserMapper.deleteByExample(example);

        // 保存角色用户
        for (int i = 0; i < userIdList.size(); i++) {
            RoleUser roleUser = new RoleUser();
            roleUser.setId(UuidUtil.getShortUuid());
            roleUser.setRoleId(roleId);
            roleUser.setUserId(userIdList.get(i));
            roleUserMapper.insert(roleUser);
        }
    }

    /**
     * 按角色加载用户
     * @param roleId
     */
    public List<String> listUser(String roleId) {
        RoleUserExample example = new RoleUserExample();
        example.createCriteria().andRoleIdEqualTo(roleId);
        List<RoleUser> roleUserList = roleUserMapper.selectByExample(example);
        List<String> userIdList = new ArrayList<>();                                       
        for (int i = 0, l = roleUserList.size(); i < l; i++) {
            userIdList.add(roleUserList.get(i).getUserId());
        }
        return userIdList;
    }
}
```





#  登录时获取资源权限

## 读取当前登录用户所属的角色的所有资源

LoginUserDto.java

```java
package com.lzn.dto;
import java.util.HashSet;
import java.util.List;

public class LoginUserDto {

    /**
     * id
     */
    private String id;

    /**
     * 登陆名
     */
    private String loginName;

    /**
     * 昵称
     */
    private String name;

    /**
     * 登录凭证
     */
    private String token;

    /**
     * 所有资源，用于前端界面控制
     */
    private List<ResourceDto> resources;

    /**
     * 所有资源中的请求，用于后端接口拦截
     */
    private HashSet<String> requests;

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getLoginName() {
        return loginName;
    }

    public void setLoginName(String loginName) {
        this.loginName = loginName;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getToken() {
        return token;
    }

    public void setToken(String token) {
        this.token = token;
    }

    public List<ResourceDto> getResources() {
        return resources;
    }

    public void setResources(List<ResourceDto> resources) {
        this.resources = resources;
    }

    public HashSet<String> getRequests() {
        return requests;
    }

    public void setRequests(HashSet<String> requests) {
        this.requests = requests;
    }

    @Override
    public String toString() {
        final StringBuffer sb = new StringBuffer("LoginUserDto{");
        sb.append("id='").append(id).append('\'');
        sb.append(", loginName='").append(loginName).append('\'');
        sb.append(", name='").append(name).append('\'');
        sb.append(", token='").append(token).append('\'');
        sb.append(", resources=").append(resources);
        sb.append(", requests=").append(requests);
        sb.append('}');
        return sb.toString();
    }

}
```



增加自定义mapper  my mapper

MyUserMapper.xml

```
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.lzn.mapper.my.MyUserMapper" >

    <!-- 一个用户可以属于多个角色，配置的资源可能重复，所以用distinct去重 -->
    <select id="findResources" resultType="com.lzn.dto.ResourceDto">
        select distinct r.id, r.`name`, r.page, r.request, r.parent
        from role_user ru, role_resource rr, resource r
        where ru.user_id = #{userId}
        and ru.role_id = rr.role_id
        and rr.resource_id = r.id
        order by r.id asc
    </select>

</mapper>
```



server mapper my

```
package com.lzn.mapper.my;

import com.lzn.dto.ResourceDto;
import org.apache.ibatis.annotations.Param;

import java.util.List;

public interface MyUserMapper {

    List<ResourceDto> findResources(@Param("userId") String userId);

}
```



\

service

```
package com.lzn.service;

import com.alibaba.fastjson.JSON;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.User;
import com.lzn.domain.UserExample;
import com.lzn.domain.Test;
import com.lzn.domain.TestExample;
import com.lzn.dto.LoginUserDto;
import com.lzn.dto.ResourceDto;
import com.lzn.dto.UserDto;
import com.lzn.dto.PageDto;
import com.lzn.exception.BusinessException;
import com.lzn.exception.BusinessExceptionCode;
import com.lzn.mapper.UserMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.mapper.my.MyUserMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.CollectionUtils;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;


@Service
public class UserService {

    private static final Logger LOG =
            LoggerFactory.getLogger(UserService.class);

    @Autowired
    private UserMapper userMapper;

    @Autowired
    private MyUserMapper myUserMapper;


    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        UserExample userExample = new UserExample();


        List<User> userList = userMapper.selectByExample(userExample);

        PageInfo<User> pageInfo = new PageInfo<>(userList);
        pageDto.setTotal(pageInfo.getTotal());

        List<UserDto> userDtoList = new ArrayList<>();

        for(int i = 0;i<userList.size();++i){
            User user = userList.get(i);
            UserDto userDto = new UserDto();
            BeanUtils.copyProperties(user, userDto);
            userDtoList.add(userDto);
        }
        pageDto.setList(userDtoList);

    }

    public void save(UserDto userDto){

        User user = CopyUtil.copy(userDto, User.class);
        if(StringUtils.isEmpty(userDto.getId())){
            this.insert(user);
        } else {
            this.update(user);
        }
    }

    /**
     * 新增
     */
    private void insert(User user) {
        user.setId(UuidUtil.getShortUuid());
        User userDb = this.selectByLoginName(user.getLoginName());
        if (userDb != null) {
            throw new BusinessException(BusinessExceptionCode.USER_LOGIN_NAME_EXIST);
        }
        userMapper.insert(user);
    }



    private void update(User user){
        user.setPassword(null);
        userMapper.updateByPrimaryKeySelective(user);
    }

    public void delete(String id) {
        userMapper.deleteByPrimaryKey(id);
    }

    /**
     * 根据登录名查询用户信息
     * @param loginName
     * @return
     */
    public User selectByLoginName(String loginName) {
        UserExample userExample = new UserExample();
        userExample.createCriteria().andLoginNameEqualTo(loginName);
        List<User> userList = userMapper.selectByExample(userExample);
        if (CollectionUtils.isEmpty(userList)) {
            return null;
        } else {
            return userList.get(0);
        }
    }

    /**
     * 重置密码
     * @param userDto
     */
    public void savePassword(UserDto userDto) {
        User user = new User();
        user.setId(userDto.getId());
        user.setPassword(userDto.getPassword());
        userMapper.updateByPrimaryKeySelective(user);
    }

    public LoginUserDto login(UserDto userDto) {
        User user = selectByLoginName(userDto.getLoginName());
        if ( user == null ) {
            // 用户名不存在
            LOG.error("用户名不存在");
            throw new BusinessException(BusinessExceptionCode.LOGIN_USER_ERROR);
        } else {
            if ( user.getPassword().equals(userDto.getPassword())) {
                // 登录成功
                LoginUserDto loginUserDto = CopyUtil.copy(user, LoginUserDto.class);
                // 为登录用户读取权限
                setAuth(loginUserDto);
                return loginUserDto;
            } else {
                // 密码不对
                LOG.error("密码错误");
                throw new BusinessException(BusinessExceptionCode.LOGIN_USER_ERROR);
            }
        }
    }


    /**
     * 为登录用户读取权限
     */
    private void setAuth(LoginUserDto loginUserDto) {
        List<ResourceDto> resourceDtoList = myUserMapper.findResources(loginUserDto.getId());
        loginUserDto.setResources(resourceDtoList);

        // 整理所有有权限的请求，用于接口拦截
        HashSet<String> requestSet = new HashSet<>();
        if (!CollectionUtils.isEmpty(resourceDtoList)) {
            for (int i = 0, l = resourceDtoList.size(); i < l; i++) {
                ResourceDto resourceDto = resourceDtoList.get(i);
                String arrayString = resourceDto.getRequest();
                List<String> requestList = JSON.parseArray(arrayString, String.class);
                if (!CollectionUtils.isEmpty(requestList)) {
                    requestSet.addAll(requestList);
                }
            }
        }
        LOG.info("有权限的请求：{}", requestSet);
        loginUserDto.setRequests(requestSet);
    }
    
    
}
```





关于user的权限设置比较细，每个请求接口都可以单独控制，关于Resource的权限设置，比较粗，所有接口用同一个request控制





# 权限拦截功能开发

## 前端界面权限拦截

## 后端界面权限拦截

tool.js

```js
Tool = {
	/**
	 * 空校验 null或""都返回true
	 */
	isEmpty: function(obj) {
		if ((typeof obj == 'string')) {
			// https://blog.csdn.net/dreamjay1997/article/details/86599404
			return !obj || obj.replace(/\s+/g, "") == ""
		} else {
			return (!obj || JSON.stringify(obj) === "{}" || obj.length === 0);
		}
	},

	/**
	 * 非空校验
	 */
	isNotEmpty: function(obj) {
		return !this.isEmpty(obj);
	},

	/**
	 * 长度校验
	 */
	isLength: function(str, min, max) {
		return $.trim(str).length >= min && $.trim(str).length <= max;
	},

	/**
	 * 时间格式化，date为空时取当前时间
	 */
	dateFormat: function(format, date) {
		let result;
		if (!date) {
			date = new Date();
		}
		const option = {
			"y+": date.getFullYear().toString(), // 年
			"M+": (date.getMonth() + 1).toString(), // 月
			"d+": date.getDate().toString(), // 日
			"h+": date.getHours().toString(), // 时
			"m+": date.getMinutes().toString(), // 分
			"s+": date.getSeconds().toString() // 秒
		};
		for (let i in option) {
			result = new RegExp("(" + i + ")").exec(format);
			if (result) {
				format = format.replace(result[1], (result[1].length == 1) ? (option[i]) : (option[i].padStart(result[1].length,
					"0")))
			}
		}
		return format;
	},


	/**
	 * 10进制转62进制
	 * @param number
	 * @returns {string}
	 * @private
	 */
	_10to62: function(number) {
		let chars = '0123456789abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ';
		let radix = chars.length;
		let arr = [];
		do {
			let mod = number % radix;
			number = (number - mod) / radix;
			arr.unshift(chars[mod]);
		} while (number);
		return arr.join('');
	},

	/**
	 * 保存登录用户
	 */
	setLoginUser: function(loginUser) {
		SessionStorage.set(SESSION_KEY_LOGIN_USER, loginUser);
	},

	/**
	 * 获取登录用户
	 */
	getLoginUser: function() {
		return SessionStorage.get(SESSION_KEY_LOGIN_USER) || {};
	},


	/**
	 * 随机生成[len]长度的[radix]进制数
	 * @param len
	 * @param radix 默认62
	 * @returns {string}
	 */
	uuid: function(len, radix) {
		let chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split('');
		let uuid = [];
		radix = radix || chars.length;

		for (let i = 0; i < len; i++) {
			uuid[i] = chars[0 | Math.random() * radix];
		}

		return uuid.join('');
	},

	/**
	 * 移除对象数组中的对象
	 * @param array
	 * @param obj
	 * @returns {number}
	 */
	removeObj: function(array, obj) {
		let index = -1;
		for (let i = 0; i < array.length; i++) {
			if (array[i] === obj) {
				array.splice(i, 1);
				index = i;
				break;
			}
		}
		return index;
	},

	/**
	 * 查找是否有权限
	 * @param id 资源id
	 */
	hasResource: function(id) {
		let _this = this;
		let resources = _this.getLoginUser().resources;
		if (_this.isEmpty(resources)) {
			return false;
		}
		for (let i = 0; i < resources.length; i++) {
			if (id === resources[i].id) {
				return true;
			}
		}
		return false;
	}
 
}

```







navbar.vue

```vue
<template>
	<nav>
		<v-app-bar app color="#438EB9">

			<v-app-bar-nav-icon @click="drawer = !drawer"></v-app-bar-nav-icon>

			<v-toolbar-title class="text-uppercase">
				<span class="font-weight-bold">在线视频</span>
				<span>系统</span>
			</v-toolbar-title>

			<!-- text 透明度设置， color 改变按钮内部文字颜色 -->
			<!-- 尽可能多的占用空间 grid -->
			<v-spacer></v-spacer>
			<v-menu offset-y>
				<template v-slot:activator="{ on, attrs }">
					<v-btn text v-bind="attrs" v-on="on" class="font-weight-bold">
						菜单
					</v-btn>
				</template>

				<!-- 			<v-list>
					<v-list-item v-for="(item, i) in links" :key="i" :to="item.route" active-class="border">
						<v-list-item-title>{{item.text}}</v-list-item-title>
					</v-list-item>
				</v-list> -->
			</v-menu>

			<v-btn text @click="logout()">
				<span class="font-weight-bold">退出</span>
				<v-icon>exit_to_app</v-icon>
			</v-btn>
		</v-app-bar>

		<v-navigation-drawer v-model="drawer" app color="#F8F8F8">
			<!-- 对应了菜单先写死 -->
			<v-list>

				<v-list-group prepend-icon="settings" color="blue" no-action=""  v-show="hasResources('01')">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>系统管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/system/user" v-show="hasResources('0101')"> 
						<v-list-item-content >
							<v-list-item-title>用户管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/system/role" v-show="hasResources('0103')">
						<v-list-item-content>
							<v-list-item-title>角色管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>
					
					<v-list-item to="/system/resource"  v-show="hasResources('0102')">
						<v-list-item-content>
							<v-list-item-title>资源管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>
					
					
					

				</v-list-group>


				<v-list-group prepend-icon="apps" color="blue" no-action="" v-show="hasResources('02')">
					<template v-slot:activator>
						<v-list-item-content >
							<v-list-item-title>业务管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/business/course" v-show="hasResources('0202')">
						<v-list-item-content>
							<v-list-item-title>课程管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/business/teacher" v-show="hasResources('0203')">
						<v-list-item-content >
							<v-list-item-title>讲师管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/business/category" v-show="hasResources('0201')">
						<v-list-item-content >
							<v-list-item-title>分类管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

				</v-list-group>

				<!-- :value="true" 就是展开了 -->
				<v-list-group prepend-icon="folder" color="blue" no-action="" v-show="hasResources('03')">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>文件管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/file/file"  v-show="hasResources('0301')">
						<v-list-item-content>
							<v-list-item-title>文件管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

				</v-list-group>




			</v-list>

		</v-navigation-drawer>
	</nav>
</template>

<script>
	export default {
		data() {
			return {
				drawer: true,
				link: '/welcome',
				loginUser: {},
			}
		},

		mounted: function() {
			let _this = this;
			_this.loginUser = Tool.getLoginUser();
		},

		methods: {
			// 获取权限
			hasResources(id) {
				return Tool.hasResource(id);
			},
			// 退出
			logout() {
				let _this = this;
				Loading.show();
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/user/logout/' + _this.loginUser.token).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						Tool.setLoginUser(null);
						_this.$router.push("/login")
					} else {
						Toast.warning(resp.message)
					}
				});
			},
		}
	}
</script>

<style scoped>
</style>

```





user.vue

```vue
<!-- 小节页面 -->
<template>
	<v-app class="ma-3" app>
		<v-dialog v-model="dialog" persistent max-width="300">
			<v-card>
				<v-card-title>
					表单
				</v-card-title>

				<v-card-text>
					<v-col cols="12">
						<v-text-field label="登陆名" v-if="user.id" disabled v-model="user.loginName"></v-text-field>
						<v-text-field label="登陆名" v-if="!user.id" v-model="user.loginName"></v-text-field>
					</v-col>
					<v-col cols="12">
						<v-text-field label="昵称" v-model="user.name" required></v-text-field>
					</v-col>
					<v-col cols="12">
						<v-text-field v-if="user.id" disabled label="密码" type="password" v-model="user.password"></v-text-field>
						<v-text-field v-if="!user.id" label="密码" type="password" v-model="user.password" required></v-text-field>
					</v-col>
				</v-card-text>
				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialog = false" clas="info">
						取消
					</v-btn>

					<v-btn @click="save()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>


		<v-dialog v-model="dialogPassword" persistent max-width="300">
			<v-card>
				<v-card-title>
					修改密码
				</v-card-title>

				<v-card-text>
					<v-col cols="12">
						<v-text-field label="密码" type="password" v-model="user.password" required></v-text-field>
					</v-col>
				</v-card-text>
				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialogPassword = false" clas="info">
						取消
					</v-btn>

					<v-btn @click="savePassword()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>


		<p class="ma-10">

			<v-btn v-show="hasResource('010101')" class="mr-5 mb-5" color="primary" @click="add()">
				<v-icon left small>add</v-icon>
				新增
			</v-btn>

			<v-btn class="mb-5" color="primary" @click="list(1)">
				<v-icon left small>refresh</v-icon>
				刷新
			</v-btn>

		</p>


		<pagination ref="pagination" v-bind:list="list" v-bind:itemCount="5"></pagination>


		<v-container>
			<v-row>
				<v-col cols="12">
					<v-simple-table>
						<thead>
							<tr>
								<th class="primary--text text-h6 text-center">id</th>
								<th class="primary--text text-h6 text-center">登陆名</th>
								<th class="primary--text text-h6 text-center">昵称</th>
								<th class="primary--text text-h6 text-center">密码</th>
								<th class="primary--text  text-h6 text-center">
									操作
								</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="user in users" class="text-center">

								<td>{{user.id}}</td>
								<td>{{user.loginName}}</td>
								<td>{{user.name}}</td>
								<td>{{user.password}}</td>

								<td>
									<v-row align="center" justify="space-around">
										<v-btn v-show="hasResource('010101') " x-small fab @click="edit(user)" class="primary">
											<v-icon>edit</v-icon>
										</v-btn>
										<v-btn v-show="hasResource('010103') " x-small fab @click="editPassword(user)" class="info">
											<v-icon>lock</v-icon>
										</v-btn>

										<v-btn v-show="hasResource('010102') " x-small fab @click="del(user.id)" class="warning">
											<v-icon>delete</v-icon>
										</v-btn>
									</v-row>
								</td>
							</tr>
						</tbody>
					</v-simple-table>
				</v-col>
			</v-row>
		</v-container>

	</v-app>
</template>

<script>
	import Pagination from "../../components/pagination.vue";
	export default {
		name: "system-user",
		components: {
			Pagination
		},

		data: function() {
			return {
				user: {},
				users: [],

				dialog: false,
				dialogPassword: false,
			}
		},

		mounted: function() {
			let _this = this;
			_this.$refs.pagination.size = 5;
			_this.list(1);

		},

		methods: {
			// 获取权限
			hasResource(id){
				return Tool.hasResource(id);
			},
			// 获取所有小节的 数据
			list(page) {
				let _this = this;
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/list', {
					page: page,
					size: _this.$refs.pagination.size,
				}).then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.users = resp.content.list;
					_this.$refs.pagination.render(page, resp.content.total);

				})
			},
			/**
			 * 新增小节
			 */
			add() {
				let _this = this;
				_this.user = {};
				_this.dialog = true;
			},

			/**
			 * 编辑小节
			 */
			edit(user) {
				let _this = this;
				_this.user = $.extend({}, user);
				_this.dialog = true;
			},

			/**
			 * 保存
			 */
			save() {
				let _this = this;

				// 保存校验
				if (1 != 1 ||
					!Validator.require(_this.user.loginName, "登陆名") ||
					!Validator.length(_this.user.loginName, "登陆名", 1, 50) ||
					!Validator.length(_this.user.name, "昵称", 1, 50) ||
					!Validator.require(_this.user.password, "密码")
				) {
					return;
				}

				_this.user.password = hex_md5(_this.user.password + KEY);

				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/save', _this.user).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						_this.dialog = false,
							_this.list(1);
						Toast.success("保存成功！");
					} else {
						Toast.warning(resp.message)
					}
				})
			},

			/**
			 * 删除小节
			 */
			del(id) {
				let _this = this;
				Confirm.show("删除用户后不可恢复，确认删除？", function() {
					Loading.show();
					_this.$ajax.delete(process.env.VUE_APP_SERVER + '/system/admin/user/delete/' + id).then((response) => {
						Loading.hide();
						let resp = response.data;
						if (resp.success) {
							_this.list(1);
							Toast.success("删除成功！");
						}
					})
				});
			},

			/**
			 * 
			 * 修改密码
			 */

			editPassword(user) {
				let _this = this;
				_this.user = $.extend({}, user);
				_this.dialogPassword = true;
			},

			/**
			 * 保存密码
			 */
			savePassword() {
				let _this = this;

				// 保存校验
				if (1 != 1 ||
					!Validator.require(_this.user.loginName, "登陆名") ||
					!Validator.length(_this.user.loginName, "登陆名", 1, 50) ||
					!Validator.length(_this.user.name, "昵称", 1, 50) ||
					!Validator.require(_this.user.password, "密码")
				) {
					return;
				}

				_this.user.password = hex_md5(_this.user.password + KEY);

				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/save-password', _this.user).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						_this.dialogPassword = false,
							_this.list(1);
						Toast.success("保存成功！");
					} else {
						Toast.warning(resp.message)
					}
				})
			}
		}
	}
</script>

<style>
</style>

```



如果一个页面的所有按钮是统一控制的，那么只需要控制菜单就可以了，不需要给每个按钮加权限控制代码 比如讲师



对用户管理，这里进行了细粒度的权限控制

## 路由权限判断

控制菜单不够，直接在当前窗口输入url，还是可以访问到的，这还是没有进行权限控制。

navbar.vue

```vue
<template>
	<nav>
		<v-app-bar app color="#438EB9">

			<v-app-bar-nav-icon @click="drawer = !drawer"></v-app-bar-nav-icon>

			<v-toolbar-title class="text-uppercase">
				<span class="font-weight-bold">在线视频</span>
				<span>系统</span>
			</v-toolbar-title>

			<!-- text 透明度设置， color 改变按钮内部文字颜色 -->
			<!-- 尽可能多的占用空间 grid -->
			<v-spacer></v-spacer>
			<v-menu offset-y>
				<template v-slot:activator="{ on, attrs }">
					<v-btn text v-bind="attrs" v-on="on" class="font-weight-bold">
						菜单
					</v-btn>
				</template>

				<!-- 			<v-list>
					<v-list-item v-for="(item, i) in links" :key="i" :to="item.route" active-class="border">
						<v-list-item-title>{{item.text}}</v-list-item-title>
					</v-list-item>
				</v-list> -->
			</v-menu>

			<v-btn text @click="logout()">
				<span class="font-weight-bold">退出</span>
				<v-icon>exit_to_app</v-icon>
			</v-btn>
		</v-app-bar>

		<v-navigation-drawer v-model="drawer" app color="#F8F8F8">
			<!-- 对应了菜单先写死 -->
			<v-list>

				<v-list-group prepend-icon="settings" color="blue" no-action="" v-show="hasResources('01')">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>系统管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/system/user" v-show="hasResources('0101')">
						<v-list-item-content>
							<v-list-item-title>用户管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/system/role" v-show="hasResources('0103')">
						<v-list-item-content>
							<v-list-item-title>角色管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/system/resource" v-show="hasResources('0102')">
						<v-list-item-content>
							<v-list-item-title>资源管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>




				</v-list-group>


				<v-list-group prepend-icon="apps" color="blue" no-action="" v-show="hasResources('02')">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>业务管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/business/course" v-show="hasResources('0202')">
						<v-list-item-content>
							<v-list-item-title>课程管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/business/teacher" v-show="hasResources('0203')">
						<v-list-item-content>
							<v-list-item-title>讲师管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/business/category" v-show="hasResources('0201')">
						<v-list-item-content>
							<v-list-item-title>分类管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

				</v-list-group>

				<!-- :value="true" 就是展开了 -->
				<v-list-group prepend-icon="folder" color="blue" no-action="" v-show="hasResources('03')">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>文件管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/file/file" v-show="hasResources('0301')">
						<v-list-item-content>
							<v-list-item-title>文件管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

				</v-list-group>




			</v-list>

		</v-navigation-drawer>
	</nav>
</template>

<script>
	export default {
		data() {
			return {
				drawer: true,
				link: '/welcome',
				loginUser: {},
			}
		},

		mounted: function() {
			let _this = this;
			_this.loginUser = Tool.getLoginUser();

			if (!_this.hasResourceRouter(_this.$route.name)) {
				_this.$router.push("/login");
			}
		},

		methods: {
			// 获取权限
			hasResources(id) {
				return Tool.hasResource(id);
			},
			/**
			 * 查找是否有权限
			 * @param router
			 */
			hasResourceRouter(router) {
				let _this = this;
				let resources = Tool.getLoginUser().resources;
				if (Tool.isEmpty(resources)) {
					return false;
				}
				for (let i = 0; i < resources.length; i++) {
					if (router === resources[i].page) {
						return true;
					}
				}
				return false;
			},

			// 退出
			logout() {
				let _this = this;
				Loading.show();
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/user/logout/' + _this.loginUser.token).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						Tool.setLoginUser(null);
						_this.$router.push("/login")
					} else {
						Toast.warning(resp.message)
					}
				});
			},
		}
	}
</script>

<style scoped>
</style>

```





## 后端接口权限判断

在做登录功能时，对接口做了登录校验，否则容易被绕开登录，直接调用后端接口，这里同样需要对接口做权限拦截

gateway 没有引用server模块，所以没用loginUserDto类，这里转成了JSONobject进行操作

比如资源的保存： path = system/admin/resource/save

配置的request = system/admin/resource

那么path.contain(request) 就是true

gateway

```java
package com.lzn.gateway.filter;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.cloud.gateway.filter.GatewayFilter;
import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.core.Ordered;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

import javax.annotation.Resource;

@Component
public class LoginAdminGatewayFilter implements GatewayFilter, Ordered {

    private static final Logger LOG = LoggerFactory.getLogger(LoginAdminGatewayFilter.class);

    @Resource
    private RedisTemplate redisTemplate;

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String path = exchange.getRequest().getURI().getPath();

        // 请求地址中不包含/admin/的，不是控台请求，不需要拦截
        if (!path.contains("/admin/")) {
            return chain.filter(exchange);
        }
        if (path.contains("/system/admin/user/login")
                || path.contains("/system/admin/user/logout")
                || path.contains("/system/admin/kaptcha")) {
            LOG.info("不需要控台登录验证：{}", path);
            return chain.filter(exchange);
        }
        //获取header的token参数
        String token = exchange.getRequest().getHeaders().getFirst("token");
        LOG.info("控台登录验证开始，token：{}", token);
        if (token == null || token.isEmpty()) {
            LOG.info( "token为空，请求被拦截" );
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        }
        Object object = redisTemplate.opsForValue().get(token);
        if (object == null) {
            LOG.warn( "token无效，请求被拦截" );
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        } else {
            LOG.info("已登录：{}", object);

            // 增加权限校验，gateway里没有LoginUserDto，所以全部用JSON操作
            LOG.info("接口权限校验，请求地址：{}", path);
            boolean exist = false;
            JSONObject loginUserDto = JSON.parseObject(String.valueOf(object));
            JSONArray requests = loginUserDto.getJSONArray("requests");
            // 遍历所有【权限请求】，判断当前请求的地址是否在【权限请求】里
            for (int i = 0, l = requests.size(); i < l; i++) {
                String request = (String) requests.get(i);
                if (path.contains(request)) {
                    exist = true;
                    break;
                }
            }
            if (exist) {
                LOG.info("权限校验通过");
            } else {
                LOG.warn("权限校验未通过");
                exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
                return exchange.getResponse().setComplete();
            }

            return chain.filter(exchange);
        }
    }

    @Override
    public int getOrder()
    {
        return 1;
    }
}
```





前端的权限控制比后端麻烦点，需要细粒度，但是后端可以通过过滤器进行设置

