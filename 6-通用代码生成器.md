---
typora-root-url: /images
---



# 通用代码生成器

# 原理介绍

FreeMarker时一款模板引擎，通过模板生成文件，包括html页面，excel等，

利用fm来制作前后端代码生成器，提高开发效率

 目标就是2分钟之内完成单表的增删改查 包含前后端代码

## 集成freemarker模板引擎

freemarker 和 thymeleaf 两种模板引擎， 前者推出的时间早，后者是spring官方推荐的

两者的代码风格不同：

freemarker：逻辑主要写再自定义标签中,

thymeleaf:逻辑主要卸载标签属性中，web开发时可读性好一点，随着版本不断更新，

两者性能正常使用没什么区别，不用纠结

根目录下pom.xml

```
<!--          freemarker-->
         <dependency>
            <groupId>org.freemarker</groupId>
            <artifactId>freemarker</artifactId>
            <version>2.3.30</version>
         </dependency>
```





新增generator子模块，代码生成器专用，并添加freemarker jar 依赖

```
    <dependencies>
<!--        freemarker模板引擎-->
        <dependency>
            <groupId>org.freemarker</groupId>
            <artifactId>freemarker</artifactId>
        </dependency>
    </dependencies>
```



子模块里面

新建包

com.lzn.generator.test

添加模板文件test.ftl和启动文件testutil.java

.ftl是约定的模板后缀名，也可以改成其他名字



test.utl

```java
package com.lzn.generator.test;
public class Test {
    /**
    * ID
    */
    private String id;
}
```

test.java 是生成出来的类

TestUtil.java

```java
import freemarker.template.Configuration;
import freemarker.template.DefaultObjectWrapper;
import freemarker.template.Template;
import freemarker.template.TemplateException;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;

public class TestUtil {

    static String ftlPath = "generator\\src\\main\\java\\com\\course\\generator\\test\\";
    static String toPath = "generator\\src\\main\\java\\com\\course\\generator\\test\\";

    public static void main(String[] args) throws IOException, TemplateException {
        Configuration cfg = new Configuration(Configuration.VERSION_2_3_29);
        cfg.setDirectoryForTemplateLoading(new File(ftlPath));
        cfg.setObjectWrapper(new DefaultObjectWrapper(Configuration.VERSION_2_3_29));
        Template temp = cfg.getTemplate("test.ftl");

        FileWriter fw = new FileWriter(toPath + "Test.java");
        BufferedWriter bw = new BufferedWriter(fw);
        temp.process(null, bw);
        bw.flush();
        fw.close();
    }
```

Test.java文件可以不用删除，freemarker生成文件会自动覆盖。

# controller层和service层代码生成

## 小节表持久层代码生成

数据库

```sql
-- 小节
drop table if exists `section`;
create table `section` (
  `id` char(8) not null default '' comment 'id',
  `title` varchar(50) not null comment '标题',
  `course_id` char(8) comment '课程|course.id',
  `chapter_id` char(8) comment '大章|chapter.id',
  `video` varchar(200) comment '视频',
  `time` int comment '时长|单位秒',
  `charge` char(1) comment '收费|C 收费；F 免费',
  `sort` int comment '顺序',
  `created_at` datetime(3) comment '创建时间',
  `updated_at` datetime(3) comment '修改时间',
  primary key (`id`)
) engine=innodb default charset=utf8mb4 comment='小节';

insert into `section` (id, title, course_id, chapter_id, video, time, charge, sort, created_at, updated_at)
values ('00000001', '测试小节01', '00000001', '00000000', '', 500, 'f', 1, now(), now());

```



## 生成持久层代码

修改generatorConfig.xml

## 生成service代码 代码构造器

制作freemarker工具类，将通用代码提取成公共方法

ftlPath是统一放模板的地方，这个属性值一般不会变，所以可以直接放到工具类里



我们会用代码生成器生成controller， service dto vue 的代码，

这些代码的文件路径都不一样，toPath是会变化的，所以把toPath变成入参



```
package com.lzn.generator.server;

import com.lzn.generator.util.FreemarkerUtil;
import freemarker.template.TemplateException;

import java.io.IOException;

public class ServerGenerator {
    static String toPath = "generator\\src\\main\\java\\com\\lzn\\generator\\server\\";
    public static void main(String[] args) throws IOException, TemplateException {
        FreemarkerUtil.initConfig("test.ftl");
        FreemarkerUtil.generator(toPath + "Test.java");
    }
}
```



目录结构如下：

![](/7.png)





新建service模板

ctrl + r 替换 replace



freemarkerUtil.java

```
package com.lzn.generator.util;

import freemarker.template.Configuration;
import freemarker.template.DefaultObjectWrapper;
import freemarker.template.Template;
import freemarker.template.TemplateException;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.util.Map;

public class FreemarkerUtil {
    static String ftlPath = "generator\\src\\main\\java\\com\\lzn\\generator\\ftl\\";
    static Template temp;
    public static void initConfig(String ftlName) throws IOException {
        Configuration cfg = new Configuration(Configuration.VERSION_2_3_29);
        cfg.setDirectoryForTemplateLoading(new File(ftlPath));
        cfg.setObjectWrapper(new DefaultObjectWrapper(Configuration.VERSION_2_3_29));
        temp = cfg.getTemplate(ftlName);
    }

    public static void generator(String fileName , Map<String, String> map) throws IOException, TemplateException {

        FileWriter fw = new FileWriter(fileName);
        BufferedWriter bw = new BufferedWriter(fw);
        temp.process(map, bw);
        bw.flush();
        fw.close();
    }
}
```

ftl service.ftl

```java
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.${Domain};
import com.lzn.domain.${Domain}Example;
import com.lzn.domain.Test;
import com.lzn.domain.TestExample;
import com.lzn.dto.${Domain}Dto;
import com.lzn.dto.PageDto;
import com.lzn.mapper.${Domain}Mapper;
import com.lzn.mapper.TestMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;


@Service
public class ${Domain}Service {

    @Autowired
    private ${Domain}Mapper ${domain}Mapper;


    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        ${Domain}Example ${domain}Example = new ${Domain}Example();
        List<${Domain}> ${domain}List = ${domain}Mapper.selectByExample(${domain}Example);

        PageInfo<${Domain}> pageInfo = new PageInfo<>(${domain}List);
        pageDto.setTotal(pageInfo.getTotal());

        List<${Domain}Dto> ${domain}DtoList = new ArrayList<>();

        for(int i = 0;i<${domain}List.size();++i){
            ${Domain} ${domain} = ${domain}List.get(i);
            ${Domain}Dto ${domain}Dto = new ${Domain}Dto();
            BeanUtils.copyProperties(${domain}, ${domain}Dto);
            ${domain}DtoList.add(${domain}Dto);
        }
        pageDto.setList(${domain}DtoList);

    }

    public void save(${Domain}Dto ${domain}Dto){
        ${Domain} ${domain} = CopyUtil.copy(${domain}Dto, ${Domain}.class);
        if(StringUtils.isEmpty(${domain}Dto.getId())){
            this.insert(${domain});
        } else {
            this.update(${domain});
        }
    }

    private void insert(${Domain} ${domain}){
        ${domain}.setId(UuidUtil.getShortUuid());
        ${domain}Mapper.insert(${domain});
    }


    private void update(${Domain} ${domain}){
        ${domain}Mapper.updateByPrimaryKey(${domain});
    }

    public void delete(String id) {
        ${domain}Mapper.deleteByPrimaryKey(id);
    }
}

```



generator server

```
package com.lzn.generator.server;

import com.lzn.generator.util.FreemarkerUtil;
import freemarker.template.TemplateException;
import java.util.*;

import java.io.IOException;

public class ServerGenerator {
    static String toServicePath = "server\\src\\main\\java\\com\\lzn\\service\\";
    public static void main(String[] args) throws IOException, TemplateException {
        String Domain = "Section";
        String domain = "section";
        Map<String, String> map = new HashMap<>();
        map.put("Domain", Domain);
        map.put("domain", domain);
        FreemarkerUtil.initConfig("service.ftl");
        FreemarkerUtil.generator(toServicePath + Domain + "Service.java" ,
                map);
    }
}
```

sectiondto由section domain拷贝过来

