---
typora-root-url: /images
---

# 核心业务功能开发

# 课程大章小节关联

## 课程管理页面美化

public static image demo-course.jpg



目标代码

```html
	<div class="thumbnail search-thumbnail">
																<img class="media-object" data-src="holder.js/100px200?theme=gray" />
																<div class="caption">
																	<div class="clearfix">
																		<span class="pull-right label label-grey info-label">Tokyo</span>
																	</div>

																	<h3 class="search-title">
																		<a href="#" class="blue">Thumbnail label</a>
																	</h3>
																	<p>Cras justo odio, dapibus ac facilisis in, egestas eget quam ...</p>
																</div>
															</div>
```





course.vue

注释掉table

加入

```vue

    <div class="row">
      <div v-for="course in courses" class="col-md-4">
        <div class="thumbnail search-thumbnail">
          <img
            v-show="!course.image"
            class="media-object"
            src="/static/image/demo-course.jpg"
          />
          <img
            v-show="course.image"
            class="media-object"
            v-bind:src="course.image"
          />

          <div class="caption">
            <div class="clearfix">
              <span class="pull-right label label-grey info-label">{{
                COURSE_LEVEL | optionKV(course.level)
              }}</span>
              <span class="pull-right label label-grey info-label">{{
                COURSE_CHARGE | optionKV(course.charge)
              }}</span>
              <span class="pull-right label label-grey info-label"
                >{{ COURSE_STATUS | optionKV(course.status) }}}</span
              >
            </div>

            <h3 class="search-title">
              <a href="#" class="blue">{{ course.name }} </a>
            </h3>
            <p>
              {{ course.summary }}
            </p>
            <p>
              <button v-on:click="edit(course)" class="btn btn-xs btn-info">
                <i class="ace-icon fa fa-pencil bigger-120"></i>
              </button>
              <button v-on:click="del(course.id)" class="btn btn-xs btn-danger">
                <i class="ace-icon fa fa-trash-o bigger-120"></i>
              </button>
            </p>
          </div>
        </div>
      </div>
    </div>
```





scoped : style下的样式只应用于当前组件，防止互相污染

```js

<style scoped>
.caption h3 {
  font-size: 30px;
}
</style>
```



```js

    <div class="row">
      <div v-for="course in courses" class="col-md-4">
        <div class="thumbnail search-thumbnail">
          <img
            v-show="!course.image"
            class="media-object"
            src="/static/image/demo-course.jpg"
          />
          <img
            v-show="course.image"
            class="media-object"
            v-bind:src="course.image"
          />

          <div class="caption">
            <div class="clearfix">
              <span class="pull-right label label-primary info-label">{{
                COURSE_LEVEL | optionKV(course.level)
              }}</span>
              <span class="pull-right label label-primary info-label">{{
                COURSE_CHARGE | optionKV(course.charge)
              }}</span>
              <span class="pull-right label label-primary info-label">{{
                COURSE_STATUS | optionKV(course.status)
              }}</span>
            </div>

            <h3 class="search-title">
              <a href="#" class="blue">{{ course.name }} </a>
            </h3>

            <p>
              <span class="blue bolder bigger-150"
                >{{ course.price }}&nbsp;<i class="fa fa-rmb"></i
              ></span>
            </p>

            <p>
              {{ course.summary }}
            </p>

            <p>
              <span class="badge badge-info"> {{ course.id }} </span>
              <span class="badge badge-info">排序:{{ course.sort }} </span>
              <span class="badge badge-info">时长:{{ course.time }} </span>
            </p>
            <p>
              <button
                v-on:click="edit(course)"
                class="btn btn-white btn-xs btn-info btn-round"
              >
                <!-- <i class="ace-icon fa fa-pencil bigger-120"></i> -->
                编辑
              </button>
              <button
                v-on:click="del(course.id)"
                class="btn btn-white btn-xs btn-warning btn-round"
              >
                <!-- <i class="ace-icon fa fa-trash-o bigger-120"></i> -->
                删除
              </button>
            </p>
          </div>
        </div>
      </div>
    </div>
```



但是存在问题

没法自适应



## 课程管理与大章管理互相跳转

完成功能：

在课程列表中增加 大章 按钮，点击会跳转到大章页面，并且筛选出当前课程下所有的大章，大章页面增加显示课程名称，并有可以返回课程管理页面



public static js

session-storage.js

```js
SESSION_KEY_COURSE = "SESSION_KEY_COURSE"; // 课程管理页面点击章管理时，保存课程信息
SESSION_KEY_CHAPTER = "SESSION_KEY_CHAPTER"; // 章管理页面点击节管理时，保存章信息
SESSION_KEY_LOGIN_USER = "SESSION_KEY_LOGIN_USER"; // 登录信息

SessionStorage = {
    get: function (key) {
        let v = sessionStorage.getItem(key);
        if (v && typeof(v) !== "undefined" && v !== "undefined") {
            return JSON.parse(v);
        }
    },
    set: function (key, data) {
        sessionStorage.setItem(key, JSON.stringify(data));
    },
    remove: function (key) {
        sessionStorage.removeItem(key);
    },
    clearAll: function () {
        sessionStorage.clear();
    }
};
```





local-storage.js

```js
LOCAL_KEY_REMEMBER_USER = "LOCAL_KEY_REMEMBER_USER"; // 记住我

LocalStorage = {
    get: function (key) {
        let v = localStorage.getItem(key);
        if (v && typeof(v) !== "undefined" && v !== "undefined") {
            return JSON.parse(v);
        }
    },
    set: function (key, data) {
        localStorage.setItem(key, JSON.stringify(data));
    },
    remove: function (key) {
        localStorage.removeItem(key);
    },
    clearAll: function () {
        localStorage.clear();
    }
};

```





说明：

sessionStorage是会话缓存，浏览器窗口关闭了，就没有了 ，

localStorage是本地缓存，浏览器关闭后，下次再打开还能读到

自带的只能操作字符串，但是我们经常要放对象数据，所以封装一下



course.vue 



```vue
     <button v-on:click="toChapter(course)" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-edit"></i>
        大章
      </button>
```



组件（页面）间传输数据可以用h5原生的localStorage sessionStorage

也可以用js 全局变量，

也可以用vuex store，但是后两者在页面刷新时会丢失数据，所以推荐用h5原生的





index.html先导入

```
   <!--  h5缓存  -->
    <script src="<%= BASE_URL %>static/js/session-storage.js"></script>
    <script src="<%= BASE_URL %>static/js/local-storage.js"></script>
```





chapter.vue

```vue
  data: function () {
    return {
      // 映射表单数据
      chapter: {},
      chapters: [],
      course: {},
    };
  },

  // 页面初始化加载方法
  mounted: function () {
    // this.$parent.activeSidebar('business-chapter-sidebar');
    let _this = this;
    _this.$refs.pagination.size = 5;
    let course = SessionStorage.get("course") || {} ;
    if ( Tool.isEmpty(course) ) {
      _this.$router.push("/welcome");
    }
    _this.course = course.name;
    _this.list(1);
  },
```





简单的跳转可以用router-link 类似a标签，如果是有其他的操作，可以写个click方法，比如前面完成的，从课程跳转到大章，需要先缓存课程信息，所以写click方法

```vue
 <router-link to = "/business/course" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-arrow-left"></i>
        返回课程
      </router-link>
```







chapter.vue

```vue
<template>
  <div>
    <h3> {{course.name}} </h3>
    <p>
      <router-link to = "/business/course" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-arrow-left"></i>
        返回课程
      </router-link>
      <button v-on:click="add()" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-edit"></i>
        新增
      </button>
      &nbsp;
      <button v-on:click="list(1)" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-refresh"></i>
        刷新
      </button>
    </p>

    <pagination ref="pagination" v-bind:list="list"></pagination>

    <table id="simple-table" class="table table-bordered table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>名称</th>
          <th>课程ID</th>
          <th>操作</th>
        </tr>
      </thead>

      <tbody>
        <tr v-for="chapter in chapters">
          <td>{{ chapter.id }}</td>
          <td>{{ chapter.name }}</td>
          <td>{{ chapter.courseId }}</td>
          <td>
            <div class="hidden-sm hidden-xs btn-group">
              <button v-on:click="edit(chapter)" class="btn btn-xs btn-info">
                <i class="ace-icon fa fa-pencil bigger-120"></i>
              </button>
              <button
                v-on:click="del(chapter.id)"
                class="btn btn-xs btn-danger"
              >
                <i class="ace-icon fa fa-trash-o bigger-120"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- 模态框 -->
    <div id="form-modal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title">表单</h4>
          </div>
          <div class="modal-body">
            <!-- 表单 -->
            <form class="form-horizontal">
              <div class="form-group">
                <label for="name" class="col-sm-2 control-label">名称</label>
                <div class="col-sm-10">
                  <input
                    v-model="chapter.name"
                    type="text"
                    class="form-control"
                    id="name"
                    placeholder="名称"
                  />
                </div>
              </div>
              <div class="form-group">
                <label for="courseID" class="col-sm-2 control-label"
                  >课程</label
                >
                <div class="col-sm-10">
                  <p class="form-control-static">{{course.name}}</p>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              取消
            </button>
            <button v-on:click="save()" type="button" class="btn btn-primary">
              保存
            </button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>

    <!-- /.modal -->
  </div>
</template>>


<script>
import Pagination from "../../components/pagination.vue";

export default {
  name: "chapter",
  components: { Pagination },

  data: function () {
    return {
      // 映射表单数据
      chapter: {},
      chapters: [],
      course: {},
    };
  },

  // 页面初始化加载方法
  mounted: function () {
    // this.$parent.activeSidebar('business-chapter-sidebar');
    let _this = this;
    _this.$refs.pagination.size = 5;
    let course = SessionStorage.get("course") || {} ;
    if ( Tool.isEmpty(course) ) {
      _this.$router.push("/welcome");
    }
    _this.course = course;
    _this.list(1);
  },
  methods: {
    // 编辑大章
    edit(chapter) {
      let _this = this;
      // _this.chapter = chapter;
      _this.chapter = $.extend({}, chapter);
      // 禁止点击空白的地方关闭
      $(".modal").modal({
        backdrop: "static",
      });
      $("#form-modal").modal("show");
    },
    // 删除大章
    del(id) {
      let _this = this;

      Confirm.show("删除大章后不可恢复，确认删除？", function () {
        Loading.show();
        _this.$ajax
          .delete(process.env.VUE_APP_SERVER + "/business/admin/chapter/delete/" + id)
          .then((response) => {
            Loading.hide();
            let resp = response.data;
            if (resp.success) {
              _this.list(1);
              Toast.success("删除成功！");
            }
          });
      });
    },
    // 新增大章
    add() {
      let _this = this;
      // 禁止点击空白的地方关闭
      _this.chapter = {};
      $(".modal").modal({
        backdrop: "static",
      });
      $("#form-modal").modal("show");
    },

    // 获取所有大章的数据
    list(page) {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(process.env.VUE_APP_SERVER + "/business/admin/chapter/list", {
          page: page,
          //  跟组子组件获取  size应该有一个默认的参数
          size: _this.$refs.pagination.size,
          courseId: _this.course.id
        })
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          _this.chapters = resp.content.list;
          _this.$refs.pagination.render(page, resp.content.total);
        });
    },

    // 保存大章的数据
    save(page) {
      let _this = this;
      // 保存校验 非空检验和长度检验
      if (
        !Validator.require(_this.chapter.name, "名称") ||
        // !Validator.require(_this.chapter.courseId, '课程ID') || 
        !Validator.length(_this.chapter.courseId, "课程ID", 1, 8)
      ) {
        return;
      }

      _this.chapter.courseId = _this.course.id;

      

      Loading.show();
      _this.$ajax
        .post(
          process.env.VUE_APP_SERVER + "/business/admin/chapter/save",
          _this.chapter
        )
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          if (resp.success) {
            // 关闭模态框
            $("#form-modal").modal("hide");
            _this.list(1);
            Toast.success("保存成功");
          } else {
            Toast.warning(resp.message);
          }
        });
    },
  },
};
</script>
```





chapterPageDto

```
package com.lzn.dto;

public class ChapterPateDto extends PageDto {
    private String courseId;

    public String getCourseId() {
        return courseId;
    }

    public void setCourseId(String courseId) {
        this.courseId = courseId;
    }

    @Override
    public String toString() {
        return "ChapterPateDto{" +
                "courseId='" + courseId + '\'' +
                ", page=" + page +
                ", size=" + size +
                ", total=" + total +
                ", list=" + list +
                '}';
    }
}
```





chapterController

```
    @PostMapping("/list")
    // requestBody --- json 默认是表单
    public ResponseDto list(@RequestBody ChapterPateDto chapterPateDto) {
        ResponseDto responseDto = new ResponseDto();
        chapterService.list(chapterPateDto);
        responseDto.setContent(chapterPateDto);
//        return pageDto;
        return responseDto;
    }
```





经验：

service层的查询条件写的松一点，灵活一点，service层可能被多个controller调用，也可能被其他service调用，每个调用的查询条件可能不一样

chapterService.java

```
  public void list(ChapterPageDto chapterPageDto) {
        PageHelper.startPage(chapterPageDto.getPage(), chapterPageDto.getSize());
        ChapterExample chapterExample = new ChapterExample();
        ChapterExample.Criteria criteria = chapterExample.createCriteria();
        if (!StringUtils.isEmpty(chapterPageDto.getCourseId())) {
            criteria.andCourseIdEqualTo(chapterPageDto.getCourseId());
        }
        List<Chapter> chapterList = chapterMapper.selectByExample(chapterExample);
        PageInfo<Chapter> pageInfo = new PageInfo<>(chapterList);
        chapterPageDto.setTotal(pageInfo.getTotal());
        List<ChapterDto> chapterDtoList = CopyUtil.copyList(chapterList, ChapterDto.class);
        chapterPageDto.setList(chapterDtoList);
    }
```



service宽松一点，controller就要严格一点

chapterController.java



```
@PostMapping("/list")
// requestBody --- json 默认是表单
public ResponseDto list(@RequestBody ChapterPageDto chapterPageDto) {
    ResponseDto responseDto = new ResponseDto();
    ValidatorUtil.require(chapterPageDto.getCourseId(), "课程ID");
    chapterService.list(chapterPageDto);
    responseDto.setContent(chapterPageDto);
    return responseDto;
}
```





## 大章管理与小节管理互相跳转



chapter.vue

```vue
<template>
  <div>
    <h4 class="lighter">
      <i
        class="ace-icon fa fa-hand-o-right icon-animated-hand-pointer blue"
      ></i>
      <router-link to="/business/course" class="pink">
        {{ course.name }}
      </router-link>
    </h4>

    <hr />
    <p>
      <router-link
        to="/business/course"
        class="btn btn-white btn-default btn-round"
      >
        <i class="ace-icon fa fa-arrow-left"></i>
        返回课程
      </router-link>
      <button v-on:click="add()" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-edit"></i>
        新增
      </button>
      &nbsp;
      <button v-on:click="list(1)" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-refresh"></i>
        刷新
      </button>
    </p>

    <pagination ref="pagination" v-bind:list="list"></pagination>

    <table id="simple-table" class="table table-bordered table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>名称</th>
          <th>操作</th>
        </tr>
      </thead>

      <tbody>
        <tr v-for="chapter in chapters">
          <td>{{ chapter.id }}</td>
          <td>{{ chapter.name }}</td>
          <td>
            <div class="hidden-sm hidden-xs btn-group">
              <button
                v-on:click="toSection(chapter)"
                class="btn btn-white btn-xs btn-info btn-round"
              >
                小节</button
              >&nbsp;
              <button
                v-on:click="edit(chapter)"
                class="btn btn-white btn-xs btn-info btn-round"
              >
                编辑</button
              >&nbsp;
              <button
                v-on:click="del(chapter.id)"
                class="btn btn-white btn-xs btn-warning btn-round"
              >
                删除
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- 模态框 -->
    <div id="form-modal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title">表单</h4>
          </div>
          <div class="modal-body">
            <!-- 表单 -->
            <form class="form-horizontal">
              <div class="form-group">
                <label for="name" class="col-sm-2 control-label">名称</label>
                <div class="col-sm-10">
                  <input
                    v-model="chapter.name"
                    type="text"
                    class="form-control"
                    id="name"
                    placeholder="名称"
                  />
                </div>
              </div>
              <div class="form-group">
                <label for="courseID" class="col-sm-2 control-label"
                  >课程</label
                >
                <div class="col-sm-10">
                  <p class="form-control-static">{{ course.name }}</p>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              取消
            </button>
            <button v-on:click="save()" type="button" class="btn btn-primary">
              保存
            </button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>

    <!-- /.modal -->
  </div>
</template>>


<script>
import Pagination from "../../components/pagination.vue";

export default {
  name: "chapter",
  components: { Pagination },

  data: function () {
    return {
      // 映射表单数据
      chapter: {},
      chapters: [],
      course: {},
    };
  },

  // 页面初始化加载方法
  mounted: function () {
    // this.$parent.activeSidebar('business-chapter-sidebar');
    let _this = this;
    _this.$refs.pagination.size = 5;
    let course = SessionStorage.get("course") || {};
    if (Tool.isEmpty(course)) {
      _this.$router.push("/welcome");
    }
    _this.course = course;
    _this.list(1);
  },
  methods: {
    // 编辑大章
    edit(chapter) {
      let _this = this;
      // _this.chapter = chapter;
      _this.chapter = $.extend({}, chapter);
      // 禁止点击空白的地方关闭
      $(".modal").modal({
        backdrop: "static",
      });
      $("#form-modal").modal("show");
    },
    // 删除大章
    del(id) {
      let _this = this;

      Confirm.show("删除大章后不可恢复，确认删除？", function () {
        Loading.show();
        _this.$ajax
          .delete(
            process.env.VUE_APP_SERVER + "/business/admin/chapter/delete/" + id
          )
          .then((response) => {
            Loading.hide();
            let resp = response.data;
            if (resp.success) {
              _this.list(1);
              Toast.success("删除成功！");
            }
          });
      });
    },
    // 新增大章
    add() {
      let _this = this;
      // 禁止点击空白的地方关闭
      _this.chapter = {};
      $(".modal").modal({
        backdrop: "static",
      });
      $("#form-modal").modal("show");
    },

    // 获取所有大章的数据
    list(page) {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(process.env.VUE_APP_SERVER + "/business/admin/chapter/list", {
          page: page,
          //  跟组子组件获取  size应该有一个默认的参数
          size: _this.$refs.pagination.size,
          courseId: _this.course.id,
        })
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          _this.chapters = resp.content.list;
          _this.$refs.pagination.render(page, resp.content.total);
        });
    },

    // 保存大章的数据
    save(page) {
      let _this = this;
      // 保存校验 非空检验和长度检验
      if (
        !Validator.require(_this.chapter.name, "名称") ||
        // !Validator.require(_this.chapter.courseId, '课程ID') ||
        !Validator.length(_this.chapter.courseId, "课程ID", 1, 8)
      ) {
        return;
      }

      _this.chapter.courseId = _this.course.id;

      Loading.show();
      _this.$ajax
        .post(
          process.env.VUE_APP_SERVER + "/business/admin/chapter/save",
          _this.chapter
        )
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          if (resp.success) {
            // 关闭模态框
            $("#form-modal").modal("hide");
            _this.list(1);
            Toast.success("保存成功");
          } else {
            Toast.warning(resp.message);
          }
        });
    },

    /**
     * 点击【小节】
     */
    toSection(chapter) {
      let _this = this;
      SessionStorage.set("chapter", chapter);
      _this.$router.push("/business/section");
    },
  },
};
</script>
```



section.vue

```vue
<template>
  <div>
    <h4 class="lighter">
      <i
        class="ace-icon fa fa-hand-o-right icon-animated-hand-pointer blue"
      ></i>
      <router-link to="/business/course" class="pink">
        {{ course.name }} </router-link
      >：
      <i
        class="ace-icon fa fa-hand-o-right icon-animated-hand-pointer blue"
      ></i>
      <router-link to="/business/chapter" class="pink">
        {{ chapter.name }}
      </router-link>
    </h4>
    <hr />
    <p>
      <button v-on:click="add()" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-edit"></i>
        新增
      </button>
      &nbsp;
      <button v-on:click="list(1)" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-refresh"></i>
        刷新
      </button>
    </p>

    <pagination ref="pagination" v-bind:list="list"></pagination>

    <table id="simple-table" class="table table-bordered table-hover">
      <thead>
        <tr>
          <th>id</th>
          <th>标题</th>
          <th>视频</th>
          <th>时长</th>
          <th>收费</th>
          <th>顺序</th>
          <th>操作</th>
        </tr>
      </thead>

      <tbody>
        <tr v-for="section in sections">
          <td>{{ section.id }}</td>
          <td>{{ section.title }}</td>
          <td>{{ section.video }}</td>
          <td>{{ section.time }}</td>
          <td>{{ SECTION_CHARGE | optionKV(section.charge) }}</td>
          <td>{{ section.sort }}</td>

          <td>
            <div class="hidden-sm hidden-xs btn-group">
              <button v-on:click="edit(section)" class="btn btn-xs btn-info">
                <i class="ace-icon fa fa-pencil bigger-120"></i>
              </button>
              <button
                v-on:click="del(section.id)"
                class="btn btn-xs btn-danger"
              >
                <i class="ace-icon fa fa-trash-o bigger-120"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- 模态框 -->
    <div id="form-modal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title">表单</h4>
          </div>
          <div class="modal-body">
            <!-- 表单 -->

            <form class="form-horizontal">
              <div class="form-group">
                <label for="title" class="col-sm-2 control-label">标题</label>
                <div class="col-sm-10">
                  <input
                    v-model="section.title"
                    type="text"
                    class="form-control"
                    id="name"
                    placeholder="标题"
                  />
                </div>
              </div>
              <div class="form-group">
                <label for="courseId" class="col-sm-2 control-label"
                  >课程</label
                >
                <div class="col-sm-10">
                  <p class="form-control-static">{{ course.name }}</p>
                </div>
              </div>
              <div class="form-group">
                <label for="chapterId" class="col-sm-2 control-label"
                  >大章</label
                >
                <div class="col-sm-10">
                  <p class="form-control-static">{{ chapter.name }}</p>
                </div>
              </div>
              <div class="form-group">
                <label for="video" class="col-sm-2 control-label">视频</label>
                <div class="col-sm-10">
                  <input
                    v-model="section.video"
                    type="text"
                    class="form-control"
                    id="name"
                    placeholder="视频"
                  />
                </div>
              </div>
              <div class="form-group">
                <label for="time" class="col-sm-2 control-label">时长</label>
                <div class="col-sm-10">
                  <input
                    v-model="section.time"
                    type="text"
                    class="form-control"
                    id="name"
                    placeholder="时长"
                  />
                </div>
              </div>
              <div class="form-group">
                <label for="charge" class="col-sm-2 control-label">收费</label>
                <div class="col-sm-10">
                  <select v-model="section.charge" class="form-control">
                    <option v-for="o in SECTION_CHARGE" v-bind:value="o.key">
                      {{ o.value }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label for="sort" class="col-sm-2 control-label">顺序</label>
                <div class="col-sm-10">
                  <input
                    v-model="section.sort"
                    type="text"
                    class="form-control"
                    id="name"
                    placeholder="顺序"
                  />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              取消
            </button>
            <button v-on:click="save()" type="button" class="btn btn-primary">
              保存
            </button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>

    <!-- /.modal -->
  </div>
</template>>


<script>
import Pagination from "../../components/pagination.vue";

export default {
  name: "business-section",
  components: { Pagination },

  data: function () {
    return {
      // 映射表单数据
      section: {},
      sections: [],
      SECTION_CHARGE: SECTION_CHARGE,
      course: {},
      chapter: {},
    };
  },

  // 页面初始化加载方法
  mounted: function () {
    // this.$parent.activeSidebar('business-section-sidebar');
    let _this = this;
    _this.$refs.pagination.size = 5;
    let course = SessionStorage.get("course") || {};
    let chapter = SessionStorage.get("chapter") || {};
    if (Tool.isEmpty(course) || Tool.isEmpty(chapter)) {
      _this.$router.push("/welcome");
    }
    _this.course = course;
    _this.chapter = chapter;
    _this.list(1);
  },
  methods: {
    // 编辑小节
    edit(section) {
      let _this = this;
      // _this.section = section;
      _this.section = $.extend({}, section);
      // 禁止点击空白的地方关闭
      $(".modal").modal({
        backdrop: "static",
      });
      $("#form-modal").modal("show");
    },
    // 删除小节
    del(id) {
      let _this = this;

      Confirm.show("删除小节后不可恢复，确认删除？", function () {
        Loading.show();
        _this.$ajax
          .delete(
            process.env.VUE_APP_SERVER + "/business/admin/section/delete/" + id
          )
          .then((response) => {
            Loading.hide();
            let resp = response.data;
            if (resp.success) {
              _this.list(1);
              Toast.success("删除成功！");
            }
          });
      });
    },
    // 新增小节
    add() {
      let _this = this;
      // 禁止点击空白的地方关闭
      _this.section = {};
      $(".modal").modal({
        backdrop: "static",
      });
      $("#form-modal").modal("show");
    },

    // 获取所有小节的数据
    list(page) {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(process.env.VUE_APP_SERVER + "/business/admin/section/list", {
          page: page,
          //  跟组子组件获取  size应该有一个默认的参数
          size: _this.$refs.pagination.size,
          courseId: _this.course.id,
          chapterId: _this.chapter.id
        })
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          _this.sections = resp.content.list;
          _this.$refs.pagination.render(page, resp.content.total);
        });
    },

    // 保存小节的数据
    save(page) {
      let _this = this;
      // 保存校验
      if (
        1 != 1 ||
        !Validator.require(_this.section.title, "标题") ||
        !Validator.length(_this.section.title, "标题", 1, 50) ||
        !Validator.length(_this.section.video, "视频", 1, 200)
      ) {
        return;
      }

      _this.section.courseId = _this.course.id;
      _this.section.chapterId = _this.chapter.id;

      Loading.show();
      _this.$ajax
        .post(
          process.env.VUE_APP_SERVER + "/business/admin/section/save",
          _this.section
        )
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          if (resp.success) {
            // 关闭模态框
            $("#form-modal").modal("hide");
            _this.list(1);
            Toast.success("保存成功");
          } else {
            Toast.warning(resp.message);
          }
        });
    },
  },
};
</script>
```



后端新增加dto

SectionPageDto.java

```java
package com.lzn.dto;

public class SectionPageDto extends PageDto {
    private String courseId;

    private String chapterId;

    public String getChapterId() {
        return chapterId;
    }

    public void setChapterId(String chapterId) {
        this.chapterId = chapterId;
    }

    public String getCourseId() {
        return courseId;
    }

    @Override
    public String toString() {
        return "SectionPageDto{" +
                "courseId='" + courseId + '\'' +
                ", chapterId='" + chapterId + '\'' +
                ", page=" + page +
                ", size=" + size +
                ", total=" + total +
                ", list=" + list +
                '}';
    }

    public void setCourseId(String courseId) {
        this.courseId = courseId;
    }

}

```





SectionController.java

```java
package com.lzn.business.controller.admin;

import com.lzn.dto.SectionDto;
import com.lzn.dto.PageDto;
import com.lzn.dto.ResponseDto;
import com.lzn.dto.SectionPageDto;
import com.lzn.service.SectionService;
import com.lzn.util.ValidatorUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/admin/section")
public class SectionController {

    public static final String BUSINESS_NAME = "小节";

    @Autowired
    private SectionService sectionService;

    @PostMapping("/list")
    public ResponseDto list(@RequestBody SectionPageDto pageDto) {
        ResponseDto responseDto = new ResponseDto();
        // 控制器要严格一点 ， 服务层要宽松一点 ，先对课程id和大章进行验证
        ValidatorUtil.require(pageDto.getChapterId(), "大章id");
        ValidatorUtil.require(pageDto.getCourseId(), "课程ID");
        sectionService.list(pageDto);
        responseDto.setContent(pageDto);
        return responseDto;
    }

    @PostMapping("/save")
    public ResponseDto save(@RequestBody SectionDto sectionDto){
        // 保存校验
        ValidatorUtil.require(sectionDto.getTitle(), "标题");
        ValidatorUtil.length(sectionDto.getTitle(), "标题", 1, 50);
        ValidatorUtil.length(sectionDto.getVideo(), "视频", 1, 200);


        ResponseDto responseDto = new ResponseDto();
        sectionService.save(sectionDto);
        responseDto.setContent(sectionDto);
        return responseDto;
    }

    @DeleteMapping("/delete/{id}")
    public ResponseDto delete(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        sectionService.delete(id);
        return responseDto;
    }
}

```

SectionService.java

```java

package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.Section;
import com.lzn.domain.SectionExample;
import com.lzn.domain.Test;
import com.lzn.domain.TestExample;
import com.lzn.dto.SectionDto;
import com.lzn.dto.PageDto;
import com.lzn.dto.SectionPageDto;
import com.lzn.mapper.SectionMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;

    import java.util.Date;

@Service
public class SectionService {

    @Autowired
    private SectionMapper sectionMapper;


    public void list(SectionPageDto sectionPageDto) {
        PageHelper.startPage(sectionPageDto.getPage(), sectionPageDto.getSize());
        SectionExample sectionExample = new SectionExample();
        SectionExample.Criteria criteria = sectionExample.createCriteria();
        if (!StringUtils.isEmpty(sectionPageDto.getCourseId())) {
            criteria.andCourseIdEqualTo(sectionPageDto.getCourseId());
        }
        if (!StringUtils.isEmpty(sectionPageDto.getChapterId())) {
            criteria.andChapterIdEqualTo(sectionPageDto.getChapterId());
        }
        sectionExample.setOrderByClause("sort asc");
        List<Section> sectionList = sectionMapper.selectByExample(sectionExample);
        PageInfo<Section> pageInfo = new PageInfo<>(sectionList);
        sectionPageDto.setTotal(pageInfo.getTotal());
        List<SectionDto> sectionDtoList = CopyUtil.copyList(sectionList, SectionDto.class);
        sectionPageDto.setList(sectionDtoList);
    }


    public void save(SectionDto sectionDto){
        Section section = CopyUtil.copy(sectionDto, Section.class);
        if(StringUtils.isEmpty(sectionDto.getId())){
            this.insert(section);
        } else {
            this.update(section);
        }
    }

    private void insert(Section section){
            Date now = new Date();
            section.setCreatedAt(now);
            section.setUpdatedAt(now);
        section.setId(UuidUtil.getShortUuid());
        sectionMapper.insert(section);
    }


    private void update(Section section){
        section.setUpdatedAt(new Date());
        sectionMapper.updateByPrimaryKey(section);
    }

    public void delete(String id) {
        sectionMapper.deleteByPrimaryKey(id);
    }
}

```



criteria类似于写where语句



# 课程时长的保存和显示



## 保存节时，更新课程总时长



时长，不应该是手动输入的，后续在介绍视频文件上传时，会介绍到怎么自动获取视频时长



将该小节所属的课程，下面所有的小节的时长全部累加，就是课程的总时长

update course c set `time` = (select sum(`time`) from `section` where course_id = '000000001') where c.id = '00001'



自定义的mapper和自动生成的mapper分开存放

MyCourseMapper.xml

```
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.lzn.mapper.my.MyCourseMapper" >
    <update id="updateTime">
        update course c set `time` = (select sum(`time`) from `section` where course_id = #{courseId})
        where c.id = #{courseId}
    </update>
</mapper>

```



server my 



```
package com.lzn.mapper.my;

import org.apache.ibatis.annotations.Param;

public interface MyCourseMapper {
    int updateTime(@Param("courseId") String courseId);
}
```





实现

SectionServer不要直接调用course的mapper 而是调用平级的CourseService



```
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.Course;
import com.lzn.domain.CourseExample;
import com.lzn.domain.Test;
import com.lzn.domain.TestExample;
import com.lzn.dto.CourseDto;
import com.lzn.dto.PageDto;
import com.lzn.mapper.CourseMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.mapper.my.MyCourseMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;

    import java.util.Date;

@Service
public class CourseService {
    private static final Logger LOG = LoggerFactory.getLogger(CourseService.class);

    @Autowired
    private CourseMapper courseMapper;

    @Autowired
    private MyCourseMapper myCourseMapper;


    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        CourseExample courseExample = new CourseExample();

        courseExample.setOrderByClause("sort asc");

        List<Course> courseList = courseMapper.selectByExample(courseExample);

        PageInfo<Course> pageInfo = new PageInfo<>(courseList);
        pageDto.setTotal(pageInfo.getTotal());

        List<CourseDto> courseDtoList = new ArrayList<>();

        for(int i = 0;i<courseList.size();++i){
            Course course = courseList.get(i);
            CourseDto courseDto = new CourseDto();
            BeanUtils.copyProperties(course, courseDto);
            courseDtoList.add(courseDto);
        }
        pageDto.setList(courseDtoList);

    }

    public void save(CourseDto courseDto){
        Course course = CopyUtil.copy(courseDto, Course.class);
        if(StringUtils.isEmpty(courseDto.getId())){
            this.insert(course);
        } else {
            this.update(course);
        }
    }

    private void insert(Course course){
            Date now = new Date();
            course.setCreatedAt(now);
            course.setUpdatedAt(now);
        course.setId(UuidUtil.getShortUuid());
        courseMapper.insert(course);
    }


    private void update(Course course){
        course.setUpdatedAt(new Date());
        courseMapper.updateByPrimaryKey(course);
    }

    public void delete(String id) {
        courseMapper.deleteByPrimaryKey(id);
    }

    /**
     * 更新课程时长
     * @param courseId
     * @return
     */
    public void updateTime(String courseId) {
        LOG.info("更新课程时长：{}", courseId);
        myCourseMapper.updateTime(courseId);
    }


}
```





```
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.Section;
import com.lzn.domain.SectionExample;
import com.lzn.domain.Test;
import com.lzn.domain.TestExample;
import com.lzn.dto.SectionDto;
import com.lzn.dto.PageDto;
import com.lzn.dto.SectionPageDto;
import com.lzn.mapper.SectionMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;

    import java.util.Date;

@Service
public class SectionService {

    @Autowired
    private SectionMapper sectionMapper;

    @Autowired
    private CourseService courseService;


    public void list(SectionPageDto sectionPageDto) {

        PageHelper.startPage(sectionPageDto.getPage(), sectionPageDto.getSize());
        SectionExample sectionExample = new SectionExample();
        SectionExample.Criteria criteria = sectionExample.createCriteria();
        if (!StringUtils.isEmpty(sectionPageDto.getCourseId())) {
            criteria.andCourseIdEqualTo(sectionPageDto.getCourseId());
        }
        if (!StringUtils.isEmpty(sectionPageDto.getChapterId())) {
            criteria.andChapterIdEqualTo(sectionPageDto.getChapterId());
        }

        sectionExample.setOrderByClause("sort asc");
        // 查找


        List<Section> sectionList = sectionMapper.selectByExample(sectionExample);

        PageInfo<Section> pageInfo = new PageInfo<>(sectionList);
        sectionPageDto.setTotal(pageInfo.getTotal());

        List<SectionDto> sectionDtoList = CopyUtil.copyList(sectionList, SectionDto.class);
        sectionPageDto.setList(sectionDtoList);

    }

    public void save(SectionDto sectionDto){
        Section section = CopyUtil.copy(sectionDto, Section.class);
        if(StringUtils.isEmpty(sectionDto.getId())){
            this.insert(section);
        } else {
            this.update(section);
        }
        courseService.updateTime(sectionDto.getCourseId());
    }

    private void insert(Section section){
            Date now = new Date();
            section.setCreatedAt(now);
            section.setUpdatedAt(now);
        section.setId(UuidUtil.getShortUuid());
        sectionMapper.insert(section);
    }


    private void update(Section section){
        section.setUpdatedAt(new Date());
        sectionMapper.updateByPrimaryKey(section);
    }

    public void delete(String id) {
        sectionMapper.deleteByPrimaryKey(id);
    }
}
```





server 模块

属性文件

```
# 网关 配置 数据库配置
# 数据库名称
spring.datasource.url=jdbc:mysql://192.168.56.101:3306/course?characterEncoding=UTF8&autoReconnect=true
# 数据库名称
spring.datasource.username=root
# 数据库密码
spring.datasource.password=123456
# 数据库驱动
spring.datasource.driver-class-name=com.mysql.jdbc.Driver

# mybatis 路径
mybatis.mapper-locations=classpath:/mapper/**/*.xml

# 日志输出级别
logging.level.com.lzn.mapper=trace
```





## 增加事务处理

一次操作会更新或修改多张表，一般为了保证数据一致，需要增加事务处理

server config

```
package com.lzn.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.transaction.annotation.EnableTransactionManagement;

@EnableTransactionManagement
@Configuration
public class TransactionManagementConfig {
   
}
```





sectionService.java

```
@Transactional
public void save(SectionDto sectionDto){
    Section section = CopyUtil.copy(sectionDto, Section.class);
    if(StringUtils.isEmpty(sectionDto.getId())){
        this.insert(section);
    } else {
        this.update(section);
    }
    courseService.updateTime(sectionDto.getCourseId());
}
```



自定义一异常一般可以选择RuntimeException，这样抛出异常 事务可以回滚

@Transactional(rollbackFor=Exception.class)那就啥异常都可以了

同一个类的内部方法互相调用，methodA调用methodB，methodB事务不起作用，

Spring的事务处理是利用aop生成动态代理类，内部方法调用时，不经过代理类，所以事务不生效



## 增加时长格式化filter



filter.js

```js
/**
 * 数组过滤器 例如：{{SECTION_CHARGE | optionKV(section.charge)}}
 * @param object 例如：{CHARGE:{key:"C", value:"收费"},FREE:{key:"F", value:"免费"}}
 * @param key 例如：C
 * @returns {string} 例如：收费
 */
let optionKV = (object, key) =>  {
    if (!object || !key) {
        return "";
    } else {
        let result = "";
        for(let enums in object){
            if (key === object[enums]["key"]) {
                result = object[enums]["value"];
            }
        }
        return result;
    }
};
/**
 * 数组过滤器 例如：{{CHARGE | optionKVArray(section.charge)}}
 * @param list 例如：[{key:"C", value:"收费"},{key:"F", value:"免费"}]
 * @param key 例如：C
 * @returns {string} 例如：收费
 */
let optionKVArray = (list, key) =>  {
    if (!list || !key) {
        return "";
    } else {
        let result = "";
        for (let i = 0; i < list.length; i++) {
            if (key === list[i]["key"]) {
                result = list[i]["value"];
            }
        }
        return result;
    }
};



/**
 * 时长格式化
 * @param value 例如：36000
 * @returns {string} 例如：10:00:00
 */
let formatSecond = (value) => {
    value = value || 0;
    let second = parseInt(value, 10); // 秒
    let minute = 0; // 分
    let hour = 0; // 小时
    if (second > 60) {
        // 当大于60秒时，才需要做转换
        minute = Math.floor(second / 60);
        second = Math.floor(second % 60);
        if (minute > 60) {
            hour = Math.floor(minute / 60);
            minute = Math.floor(minute % 60);
        }
    } else {
        // 小于60秒时，直接显示，不需要处理
    }
    let result = "" + PrefixInteger(second, 2) + "";
    // 拼上分钟
    result = "" + PrefixInteger(minute, 2) + ":" + result;
    // 拼上小时
    result = "" + PrefixInteger(hour, 2) + ":" + result;
    return result;
};



/**
 * 格式化指定长度，前面补0
 */
function PrefixInteger(num, length) {
    return (Array(length).join('0') + num).slice(-length);
}


export default {
    optionKV,
    formatSecond
}
```





类似这样处理

```
           <span class="badge badge-info">时长:{{ course.time| formatSecond }} </span
```



# 分类功能开发

## 分类表设计和基本代码生成



```sql
-- 分类
drop table if exists `category`;
create table `category` (
  `id` char(8) not null default '' comment 'id',
  `parent` char(8) not null default '' comment '父id',
  `name` varchar(50) not null comment '名称',
  `sort` int comment '顺序',
  primary key (`id`)
) engine=innodb default charset=utf8mb4 comment='分类';

insert into `category` (id, parent, name, sort) values ('00000100', '00000000', '前端技术', 100);
insert into `category` (id, parent, name, sort) values ('00000101', '00000100', 'html/css', 101);
insert into `category` (id, parent, name, sort) values ('00000102', '00000100', 'javascript', 102);
insert into `category` (id, parent, name, sort) values ('00000103', '00000100', 'vue.js', 103);
insert into `category` (id, parent, name, sort) values ('00000104', '00000100', 'react.js', 104);
insert into `category` (id, parent, name, sort) values ('00000105', '00000100', 'angular', 105);
insert into `category` (id, parent, name, sort) values ('00000106', '00000100', 'node.js', 106);
insert into `category` (id, parent, name, sort) values ('00000107', '00000100', 'jquery', 107);
insert into `category` (id, parent, name, sort) values ('00000108', '00000100', '小程序', 108);
insert into `category` (id, parent, name, sort) values ('00000200', '00000000', '后端技术', 200);
insert into `category` (id, parent, name, sort) values ('00000201', '00000200', 'java', 201);
insert into `category` (id, parent, name, sort) values ('00000202', '00000200', 'springboot', 202);
insert into `category` (id, parent, name, sort) values ('00000203', '00000200', 'spring cloud', 203);
insert into `category` (id, parent, name, sort) values ('00000204', '00000200', 'ssm', 204);
insert into `category` (id, parent, name, sort) values ('00000205', '00000200', 'python', 205);
insert into `category` (id, parent, name, sort) values ('00000206', '00000200', '爬虫', 206);
insert into `category` (id, parent, name, sort) values ('00000300', '00000000', '移动开发', 300);
insert into `category` (id, parent, name, sort) values ('00000301', '00000300', 'android', 301);
insert into `category` (id, parent, name, sort) values ('00000302', '00000300', 'ios', 302);
insert into `category` (id, parent, name, sort) values ('00000303', '00000300', 'react native', 303);
insert into `category` (id, parent, name, sort) values ('00000304', '00000300', 'ionic', 304);
insert into `category` (id, parent, name, sort) values ('00000400', '00000000', '前沿技术', 400);
insert into `category` (id, parent, name, sort) values ('00000401', '00000400', '微服务', 401);
insert into `category` (id, parent, name, sort) values ('00000402', '00000400', '区块链', 402);
insert into `category` (id, parent, name, sort) values ('00000403', '00000400', '机器学习', 403);
insert into `category` (id, parent, name, sort) values ('00000404', '00000400', '深度学习', 404);
insert into `category` (id, parent, name, sort) values ('00000405', '00000400', '数据分析&挖掘', 405);
insert into `category` (id, parent, name, sort) values ('00000500', '00000000', '云计算&大数据', 500);
insert into `category` (id, parent, name, sort) values ('00000501', '00000500', '大数据', 501);
insert into `category` (id, parent, name, sort) values ('00000502', '00000500', 'hadoop', 502);
insert into `category` (id, parent, name, sort) values ('00000503', '00000500', 'spark', 503);
insert into `category` (id, parent, name, sort) values ('00000504', '00000500', 'hbase', 504);
insert into `category` (id, parent, name, sort) values ('00000505', '00000500', '阿里云', 505);
insert into `category` (id, parent, name, sort) values ('00000506', '00000500', 'docker', 506);
insert into `category` (id, parent, name, sort) values ('00000507', '00000500', 'kubernetes', 507);
insert into `category` (id, parent, name, sort) values ('00000600', '00000000', '运维&测试', 600);
insert into `category` (id, parent, name, sort) values ('00000601', '00000600', '运维', 601);
insert into `category` (id, parent, name, sort) values ('00000602', '00000600', '自动化运维', 602);
insert into `category` (id, parent, name, sort) values ('00000603', '00000600', '中间件', 603);
insert into `category` (id, parent, name, sort) values ('00000604', '00000600', 'linux', 604);
insert into `category` (id, parent, name, sort) values ('00000605', '00000600', '测试', 605);
insert into `category` (id, parent, name, sort) values ('00000606', '00000600', '自动化测试', 606);
insert into `category` (id, parent, name, sort) values ('00000700', '00000000', '数据库', 700);
insert into `category` (id, parent, name, sort) values ('00000701', '00000700', 'mysql', 701);
insert into `category` (id, parent, name, sort) values ('00000702', '00000700', 'redis', 702);
insert into `category` (id, parent, name, sort) values ('00000703', '00000700', 'mongodb', 703);

```





generatorConfig.xml

去掉注释

生成持久层



vue 生成器



service生成器





修改admin.vue

增加一个菜单

```vue
       <li class="active" id="business-category-sidebar">
                <router-link to="/business/category">
                  <i class="menu-icon fa fa-caret-right"></i>
                  分类管理
                </router-link>

                <b class="arrow"></b>
              </li>
              <li class="active" id="business-course-sidebar">
                <router-link to="/business/course">
                  <i class="menu-icon fa fa-caret-right"></i>
                  课程管理
                </router-link>

                <b class="arrow"></b>
              </li>
```



路由修改

router.js

```js
import Vue from 'vue'
import Router from 'vue-router'
import Login from './views/login.vue'
import Admin from './views/admin.vue'
import Welcome from './views/admin/welcome.vue'
import Chapter from './views/admin/chapter.vue'
import Section from './views/admin/section.vue'
import Course from './views/admin/course.vue'
import Category from './views/admin/category.vue'

Vue.use(Router);

export default new Router(
    {
        mode: 'history', // history hash 推荐使用history hash 的话前面由前缀，url形式不美观，history推荐使用，路由前面只有以恶搞#
        base: process.env.BASE_URL,
        routes: [{
            path: '*',
            redirect: "/login",
        }, {
            path: "/login",
            component: Login
        }, {
            path: "/",
            name: "admin", 
            // name属性后面会用到
            component: Admin,
            children: [{
                path: 'welcome',
                name: 'welcome',
                component: Welcome
            }, {
                path: 'business/category',
                name: 'business/category',
                component: Category
            }, {
                path: 'business/course',
                name: 'business/course',
                component: Course
            }, {
                path: 'business/chapter',
                name: 'business/chapter',
                component: Chapter
            }, {
                path: 'business/section',
                name: 'business/section',
                component: Section
            }]
        }]
    }

)
```





## 分类二级列表查询与显示

做成左右两个表格，左边是一级分类，右边是二级分类，点击一级分类，显示对应的二级分类

分类总数不多，不需要分页，一次查询全部数据，由前端来处理显示

categoryService.java

增加

```java
    // 查询全部数据
    public List<CategoryDto> all(){
        CategoryExample categoryExample = new CategoryExample();
        categoryExample.setOrderByClause("sort asc");
        List<Category> categoryList = categoryMapper.selectByExample(categoryExample);
        List<CategoryDto> categoryDtoList = CopyUtil.copyList(categoryList, CategoryDto.class);
        return categoryDtoList;

    }

```





categorycontroller

```
@PostMapping("/all")
public ResponseDto all() {
    ResponseDto responseDto = new ResponseDto();
    responseDto.setContent(categoryService.all());
    return responseDto;
}
```





动态class

使用v-bind:class=json表达式，key就是样式，value是boolean

为true的时候，表示key的样式生效

可以和原生的class并存



material color https://www.materialpalette.com/colors

category.vue

```vue
<template>
  <div>
    <div class="row">
      <div class="col-md-6">
        <p>
          <button
            v-on:click="add()"
            class="btn btn-white btn-default btn-round"
          >
            <i class="ace-icon fa fa-edit"></i>
            新增
          </button>
          &nbsp;
          <button
            v-on:click="all()"
            class="btn btn-white btn-default btn-round"
          >
            <i class="ace-icon fa fa-refresh"></i>
            刷新
          </button>
        </p>

        <table id="simple-table" class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>id</th>
              <th>名称</th>
              <th>顺序</th>
              <th>操作</th>
            </tr>
          </thead>

          <tbody>
            <tr v-for="category in level1" v-on:click="onClickLevel1(category)"  v-bind:class="{'active' : category.id === active.id}">
              <td>{{ category.id }}</td>
              <td>{{ category.name }}</td>
              <td>{{ category.sort }}</td>
              <td>
                <div class="hidden-sm hidden-xs btn-group">
                  <button
                    v-on:click="edit(category)"
                    class="btn btn-xs btn-info"
                  >
                    <i class="ace-icon fa fa-pencil bigger-120"></i>
                  </button>
                  <button
                    v-on:click="del(category.id)"
                    class="btn btn-xs btn-danger"
                  >
                    <i class="ace-icon fa fa-trash-o bigger-120"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="col-md-6">
        <p>
          <button
            v-on:click="add()"
            class="btn btn-white btn-default btn-round"
          >
            <i class="ace-icon fa fa-edit"></i>
            新增
          </button>
        </p>

        <table id="simple-table" class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>id</th>
              <th>名称</th>
              <th>顺序</th>
              <th>操作</th>
            </tr>
          </thead>

          <tbody>
            <tr v-for="category in level2">
              <td>{{ category.id }}</td>
              <td>{{ category.name }}</td>
              <td>{{ category.sort }}</td>
              <td>
                <div class="hidden-sm hidden-xs btn-group">
                  <button
                    v-on:click="edit(category)"
                    class="btn btn-xs btn-info"
                  >
                    <i class="ace-icon fa fa-pencil bigger-120"></i>
                  </button>
                  <button
                    v-on:click="del(category.id)"
                    class="btn btn-xs btn-danger"
                  >
                    <i class="ace-icon fa fa-trash-o bigger-120"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="form-modal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title">表单</h4>
          </div>
          <div class="modal-body">
            <form class="form-horizontal">
              <div class="form-group">
                <label class="col-sm-2 control-label">父id</label>
                <div class="col-sm-10">
                  <input v-model="category.parent" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">名称</label>
                <div class="col-sm-10">
                  <input v-model="category.name" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">顺序</label>
                <div class="col-sm-10">
                  <input v-model="category.sort" class="form-control" />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              取消
            </button>
            <button v-on:click="save()" type="button" class="btn btn-primary">
              保存
            </button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
  </div>
</template>

<script>
import Pagination from "../../components/pagination";
export default {
  components: { Pagination },
  name: "business-category",
  data: function () {
    return {
      category: {},
      categorys: [],
      level1: [],
      level2: [],
      active: {},
    };
  },
  mounted: function () {
    let _this = this;
    // _this.$refs.pagination.size = 5;
    _this.all();
    // sidebar激活样式方法一
    // this.$parent.activeSidebar("business-category-sidebar");
  },
  methods: {
    /**点击显示二级分类 */
    onClickLevel1(category) {
      let _this = this;
      _this.level2 = category.children;
      _this.active = category;
    },
    /**
     * 点击【新增】
     */
    add() {
      let _this = this;
      _this.category = {};
      $("#form-modal").modal("show");
    },

    /**
     * 点击【编辑】
     */
    edit(category) {
      let _this = this;
      _this.category = $.extend({}, category);
      $("#form-modal").modal("show");
    },

    /**
     * 列表查询 查询全部
     */
    all() {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(process.env.VUE_APP_SERVER + "/business/admin/category/all")
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          _this.categorys = resp.content;
          // 将所有记录格式化成树形结构

          _this.level1 = [];

          for (let i = 0; i < _this.categorys.length; i++) {
            let c = _this.categorys[i];
            if (c.parent === "00000000") {
              _this.level1.push(c);
              for (let j = 0; j < _this.categorys.length; j++) {
                let child = _this.categorys[j];
                if (child.parent === c.id) {
                  if (Tool.isEmpty(c.children)) {
                    c.children = [];
                  }
                  c.children.push(child);
                }
              }
            }
          }
        });
    },

    /**
     * 点击【保存】
     */
    save() {
      let _this = this;

      // 保存校验
      if (
        1 != 1 ||
        !Validator.require(_this.category.parent, "父id") ||
        !Validator.require(_this.category.name, "名称") ||
        !Validator.length(_this.category.name, "名称", 1, 50)
      ) {
        return;
      }

      Loading.show();
      _this.$ajax
        .post(
          process.env.VUE_APP_SERVER + "/business/admin/category/save",
          _this.category
        )
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          if (resp.success) {
            $("#form-modal").modal("hide");
            _this.all();
            Toast.success("保存成功！");
          } else {
            Toast.warning(resp.message);
          }
        });
    },

    /**
     * 点击【删除】
     */
    del(id) {
      let _this = this;
      Confirm.show("删除分类后不可恢复，确认删除？", function () {
        Loading.show();
        _this.$ajax
          .delete(
            process.env.VUE_APP_SERVER + "/business/admin/category/delete/" + id
          )
          .then((response) => {
            Loading.hide();
            let resp = response.data;
            if (resp.success) {
              _this.all();
              Toast.success("删除成功！");
            }
          });
      });
    },
  },
};
</script>

<style scoped>
  .active td {
    background-color: #d4e157 !important;
  }
</style>
```



## 分类的CRUD

有一个小bug 以后解决，crud二级分类时候，没有马上刷新出来，会用到另外的小知识点



category.vue

```vue
<template>
  <div>
    <div class="row">
      <div class="col-md-6">
        <p>
          <button
            v-on:click="add1()"
            class="btn btn-white btn-default btn-round"
          >
            <i class="ace-icon fa fa-edit"></i>
            新增一级
          </button>
          &nbsp;
          <button
            v-on:click="all()"
            class="btn btn-white btn-default btn-round"
          >
            <i class="ace-icon fa fa-refresh"></i>
            刷新
          </button>
        </p>

        <table id="simple-table" class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>id</th>
              <th>名称</th>
              <th>顺序</th>
              <th>操作</th>
            </tr>
          </thead>

          <tbody>
            <tr v-for="category in level1" v-on:click="onClickLevel1(category)"  v-bind:class="{'active' : category.id === active.id}">
              <td>{{ category.id }}</td>
              <td>{{ category.name }}</td>
              <td>{{ category.sort }}</td>
              <td>
                <div class="hidden-sm hidden-xs btn-group">
                  <button
                    v-on:click="edit(category)"
                    class="btn btn-xs btn-info"
                  >
                    <i class="ace-icon fa fa-pencil bigger-120"></i>
                  </button>
                  <button
                    v-on:click="del(category.id)"
                    class="btn btn-xs btn-danger"
                  >
                    <i class="ace-icon fa fa-trash-o bigger-120"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="col-md-6">
        <p>
          <button
            v-on:click="add2()"
            class="btn btn-white btn-default btn-round"
          >
            <i class="ace-icon fa fa-edit"></i>
            新增二级
          </button>
        </p>

        <table id="simple-table" class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>id</th>
              <th>名称</th>
              <th>顺序</th>
              <th>操作</th>
            </tr>
          </thead>

          <tbody>
            <tr v-for="category in level2">
              <td>{{ category.id }}</td>
              <td>{{ category.name }}</td>
              <td>{{ category.sort }}</td>
              <td>
                <div class="hidden-sm hidden-xs btn-group">
                  <button
                    v-on:click="edit(category)"
                    class="btn btn-xs btn-info"
                  >
                    <i class="ace-icon fa fa-pencil bigger-120"></i>
                  </button>
                  <button
                    v-on:click="del(category.id)"
                    class="btn btn-xs btn-danger"
                  >
                    <i class="ace-icon fa fa-trash-o bigger-120"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="form-modal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title">表单</h4>
          </div>
          <div class="modal-body">
            <form class="form-horizontal">
              <div class="form-group">
                <label class="col-sm-2 control-label">父分类</label>
                <div class="col-sm-10">
                  <p class="">{{active.name || "无"}} </p>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">名称</label>
                <div class="col-sm-10">
                  <input v-model="category.name" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">顺序</label>
                <div class="col-sm-10">
                  <input v-model="category.sort" class="form-control" />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              取消
            </button>
            <button v-on:click="save()" type="button" class="btn btn-primary">
              保存
            </button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
  </div>
</template>

<script>
import Pagination from "../../components/pagination";
export default {
  components: { Pagination },
  name: "business-category",
  data: function () {
    return {
      category: {},
      categorys: [],
      level1: [],
      level2: [],
      active: {},
    };
  },
  mounted: function () {
    let _this = this;
    // _this.$refs.pagination.size = 5;
    _this.all();
    // sidebar激活样式方法一
    // this.$parent.activeSidebar("business-category-sidebar");
  },
  methods: {
    /**点击显示二级分类 */
    onClickLevel1(category) {
      let _this = this;
      _this.level2 = category.children;
      _this.active = category;
    },
    /**
     * 点击【新增】
     */
    add() {
      let _this = this;
      _this.category = {};
      $("#form-modal").modal("show");
    },

    /**新增一级 */
    add1() {
      let _this = this;
      _this.active = {};
      _this.level2 = [];
      _this.category = {
        parent: "00000000"
      };
       $("#form-modal").modal("show");
    },  
     /**
       * 点击【新增二级】
       */
      add2() {
        let _this = this;
        if (Tool.isEmpty(_this.active)) {
          Toast.warning("请先点击一级分类");
          return;
        }
        _this.category = {
          parent: _this.active.id
        };
        $(".modal").modal("show");
      },
    /**
     * 点击【编辑】
     */
    edit(category) {
      let _this = this;
      _this.category = $.extend({}, category);
      $("#form-modal").modal("show");
    },

    /**
     * 列表查询 查询全部
     */
    all() {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(process.env.VUE_APP_SERVER + "/business/admin/category/all")
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          _this.categorys = resp.content;
          // 将所有记录格式化成树形结构

          _this.level1 = [];

          for (let i = 0; i < _this.categorys.length; i++) {
            let c = _this.categorys[i];
            if (c.parent === "00000000") {
              _this.level1.push(c);
              for (let j = 0; j < _this.categorys.length; j++) {
                let child = _this.categorys[j];
                if (child.parent === c.id) {
                  if (Tool.isEmpty(c.children)) {
                    c.children = [];
                  }
                  c.children.push(child);
                }
              }
            }
          }
        });
    },

    /**
     * 点击【保存】
     */
    save() {
      let _this = this;

      // 保存校验
      if (
        1 != 1 ||
        !Validator.require(_this.category.parent, "父id") ||
        !Validator.require(_this.category.name, "名称") ||
        !Validator.length(_this.category.name, "名称", 1, 50)
      ) {
        return;
      }

      Loading.show();
      _this.$ajax
        .post(
          process.env.VUE_APP_SERVER + "/business/admin/category/save",
          _this.category
        )
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          if (resp.success) {
            $("#form-modal").modal("hide");
            _this.all();
            Toast.success("保存成功！");
          } else {
            Toast.warning(resp.message);
          }
        });
    },

    /**
     * 点击【删除】
     */
    del(id) {
      let _this = this;
      Confirm.show("删除分类后不可恢复，确认删除？", function () {
        Loading.show();
        _this.$ajax
          .delete(
            process.env.VUE_APP_SERVER + "/business/admin/category/delete/" + id
          )
          .then((response) => {
            Loading.hide();
            let resp = response.data;
            if (resp.success) {
              _this.all();
              Toast.success("删除成功！");
            }
          });
      });
    },
  },
};
</script>

<style scoped>
  .active td {
    background-color: #d4e157 !important;
  }
</style>
```



categoryService.java

```
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.Category;
import com.lzn.domain.CategoryExample;
import com.lzn.dto.CategoryDto;
import com.lzn.dto.PageDto;
import com.lzn.mapper.CategoryMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import java.util.List;


@Service
public class CategoryService {

    @Autowired
    private CategoryMapper categoryMapper;


    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        CategoryExample categoryExample = new CategoryExample();

        categoryExample.setOrderByClause("sort asc");

        List<Category> categoryList = categoryMapper.selectByExample(categoryExample);

        PageInfo<Category> pageInfo = new PageInfo<>(categoryList);
        pageDto.setTotal(pageInfo.getTotal());

        List<CategoryDto> categoryDtoList = CopyUtil.copyList(categoryList, CategoryDto.class);

//        for(int i = 0;i<categoryList.size();++i){
//            Category category = categoryList.get(i);
//            CategoryDto categoryDto = new CategoryDto();
//            BeanUtils.copyProperties(category, categoryDto);
//            categoryDtoList.add(categoryDto);
//        }
        pageDto.setList(categoryDtoList);

    }

    // 查询全部数据
    public List<CategoryDto> all(){
        CategoryExample categoryExample = new CategoryExample();
        categoryExample.setOrderByClause("sort asc");
        List<Category> categoryList = categoryMapper.selectByExample(categoryExample);
        List<CategoryDto> categoryDtoList = CopyUtil.copyList(categoryList, CategoryDto.class);
        return categoryDtoList;

    }

    public void save(CategoryDto categoryDto){
        Category category = CopyUtil.copy(categoryDto, Category.class);
        if(StringUtils.isEmpty(categoryDto.getId())){
            this.insert(category);
        } else {
            this.update(category);
        }
    }

    private void insert(Category category){
        category.setId(UuidUtil.getShortUuid());
        categoryMapper.insert(category);
    }


    private void update(Category category){
        categoryMapper.updateByPrimaryKey(category);
    }

    /**
     * 删除
     */
    @Transactional
    public void delete(String id) {
        deleteChildren(id);
        categoryMapper.deleteByPrimaryKey(id);
    }

    /**
     * 删除子分类
     * @param id
     */
    public void deleteChildren(String id) {
        Category category = categoryMapper.selectByPrimaryKey(id);
        if ("00000000".equals(category.getParent())) {
            // 如果是一级分类，需要删除其下的二级分类
            CategoryExample example = new CategoryExample();
            example.createCriteria().andParentEqualTo(category.getId());
            categoryMapper.deleteByExample(example);
        }
    }
}
```





修改category.vue

```vue
<template>
  <div>
    <div class="row">
      <div class="col-md-6">
        <p>
          <button
            v-on:click="add1()"
            class="btn btn-white btn-default btn-round"
          >
            <i class="ace-icon fa fa-edit"></i>
            新增一级
          </button>
          &nbsp;
          <button
            v-on:click="all()"
            class="btn btn-white btn-default btn-round"
          >
            <i class="ace-icon fa fa-refresh"></i>
            刷新
          </button>
        </p>

        <table id="simple-table" class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>id</th>
              <th>名称</th>
              <th>顺序</th>
              <th>操作</th>
            </tr>
          </thead>

          <tbody>
            <tr v-for="category in level1" v-on:click="onClickLevel1(category)"  v-bind:class="{'active' : category.id === active.id}">
              <td>{{ category.id }}</td>
              <td>{{ category.name }}</td>
              <td>{{ category.sort }}</td>
              <td>
                <div class="hidden-sm hidden-xs btn-group">
                  <button
                    v-on:click="edit(category)"
                    class="btn btn-xs btn-info"
                  >
                    <i class="ace-icon fa fa-pencil bigger-120"></i>
                  </button>
                  <button
                    v-on:click="del(category.id)"
                    class="btn btn-xs btn-danger"
                  >
                    <i class="ace-icon fa fa-trash-o bigger-120"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="col-md-6">
        <p>
          <button
            v-on:click="add2()"
            class="btn btn-white btn-default btn-round"
          >
            <i class="ace-icon fa fa-edit"></i>
            新增二级
          </button>
        </p>

        <table id="simple-table" class="table table-bordered table-hover">
          <thead>
            <tr>
              <th>id</th>
              <th>名称</th>
              <th>顺序</th>
              <th>操作</th>
            </tr>
          </thead>

          <tbody>
            <tr v-for="category in level2">
              <td>{{ category.id }}</td>
              <td>{{ category.name }}</td>
              <td>{{ category.sort }}</td>
              <td>
                <div class="hidden-sm hidden-xs btn-group">
                  <button
                    v-on:click="edit(category)"
                    class="btn btn-xs btn-info"
                  >
                    <i class="ace-icon fa fa-pencil bigger-120"></i>
                  </button>
                  <button
                    v-on:click="del(category.id)"
                    class="btn btn-xs btn-danger"
                  >
                    <i class="ace-icon fa fa-trash-o bigger-120"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="form-modal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title">表单</h4>
          </div>
          <div class="modal-body">
            <form class="form-horizontal">
              <div class="form-group">
                <label class="col-sm-2 control-label">父分类</label>
                <div class="col-sm-10">
                  <p class="">{{active.name || "无"}} </p>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">名称</label>
                <div class="col-sm-10">
                  <input v-model="category.name" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">顺序</label>
                <div class="col-sm-10">
                  <input v-model="category.sort" class="form-control" />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              取消
            </button>
            <button v-on:click="save()" type="button" class="btn btn-primary">
              保存
            </button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
  </div>
</template>

<script>
import Pagination from "../../components/pagination";
export default {
  components: { Pagination },
  name: "business-category",
  data: function () {
    return {
      category: {},
      categorys: [],
      level1: [],
      level2: [],
      active: {},
    };
  },
  mounted: function () {
    let _this = this;
    // _this.$refs.pagination.size = 5;
    _this.all();
    // sidebar激活样式方法一
    // this.$parent.activeSidebar("business-category-sidebar");
  },
  methods: {
    /**点击显示二级分类 */
    onClickLevel1(category) {
      let _this = this;
      _this.level2 = category.children;
      _this.active = category;
    },
    /**
     * 点击【新增】
     */
    add() {
      let _this = this;
      _this.category = {};
      $("#form-modal").modal("show");
    },

    /**新增一级 */
    add1() {
      let _this = this;
      _this.active = {};
      _this.level2 = [];
      _this.category = {
        parent: "00000000"
      };
       $("#form-modal").modal("show");
    },  
     /**
       * 点击【新增二级】
       */
      add2() {
        let _this = this;
        if (Tool.isEmpty(_this.active)) {
          Toast.warning("请先点击一级分类");
          return;
        }
        _this.category = {
          parent: _this.active.id
        };
        $(".modal").modal("show");
      },
    /**
     * 点击【编辑】
     */
    edit(category) {
      let _this = this;
      _this.category = $.extend({}, category);
      $("#form-modal").modal("show");
    },

    /**
     * 列表查询 查询全部
     */
    all() {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(process.env.VUE_APP_SERVER + "/business/admin/category/all")
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          _this.categorys = resp.content;
          // 将所有记录格式化成树形结构

          _this.level1 = [];

          for (let i = 0; i < _this.categorys.length; i++) {
            let c = _this.categorys[i];
            if (c.parent === "00000000") {
              _this.level1.push(c);
              for (let j = 0; j < _this.categorys.length; j++) {
                let child = _this.categorys[j];
                if (child.parent === c.id) {
                  if (Tool.isEmpty(c.children)) {
                    c.children = [];
                  }
                  c.children.push(child);
                }
              }
            }
          }
          _this.level2 = [];
          // 对当前一级分类中选中的表格触发一次点击事件，以刷新二级菜单列表
          // 注意：界面的渲染需要等vue绑定好变量后才做，所以加延时100ms
          setTimeout(function () {
            $("tr.active").trigger("click");
          }, 100);
        })
    },

    /**
     * 点击【保存】
     */
    save() {
      let _this = this;

      // 保存校验
      if (
        1 != 1 ||
        !Validator.require(_this.category.parent, "父id") ||
        !Validator.require(_this.category.name, "名称") ||
        !Validator.length(_this.category.name, "名称", 1, 50)
      ) {
        return;
      }

      Loading.show();
      _this.$ajax
        .post(
          process.env.VUE_APP_SERVER + "/business/admin/category/save",
          _this.category
        )
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          if (resp.success) {
            $("#form-modal").modal("hide");
            _this.all();
            Toast.success("保存成功！");
          } else {
            Toast.warning(resp.message);
          }
        });
    },

    /**
     * 点击【删除】
     */
    del(id) {
      let _this = this;
      Confirm.show("删除分类后不可恢复，确认删除？", function () {
        Loading.show();
        _this.$ajax
          .delete(
            process.env.VUE_APP_SERVER + "/business/admin/category/delete/" + id
          )
          .then((response) => {
            Loading.hide();
            let resp = response.data;
            if (resp.success) {
              _this.all();
              Toast.success("删除成功！");
            }
          });
      });
    },
  },
};
</script>

<style scoped>
  .active td {
    background-color: #d4e157 !important;
  }
</style>
```

小技巧：

当界面又用了vue 和 jquery特别是第三方插件时候，

当觉得代码没问题i，但是效果没有出来的时候，就可以加一个小延时看看

# 课程和分类关联保存和显示

 ## 集成树型展示插件zTree

zTree是jquery插件，用于展示树形结构数据，分类数据有两层结构，可用树形结构展示



下载ztree_v3 放在public里面

index.html

```
    <!--  zTree jquery树插件  -->
    <link rel="stylesheet" href="<%= BASE_URL %>zTree_v3/css/zTreeStyle/zTreeStyle.css" type="text/css">

```



```
    <!--  zTree jquery树插件  -->
    <script src="<%= BASE_URL %>zTree_v3/js/jquery.ztree.core.min.js"></script>
    <script src="<%= BASE_URL %>zTree_v3/js/jquery.ztree.excheck.min.js"></script>

```



功能设计：

新增课程的时候，同时选择这门课程属于哪个分类 并且一门课程可以属于多个分类

course.vue

```vue
<template>
  <div>
    <p>
      <button v-on:click="add()" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-edit"></i>
        新增
      </button>
      &nbsp;
      <button v-on:click="list(1)" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-refresh"></i>
        刷新
      </button>
    </p>

    <pagination
      ref="pagination"
      v-bind:list="list"
      v-bind:itemCount="8"
    ></pagination>

    <div class="row">
      <div v-for="course in courses" class="col-md-4">
        <div class="thumbnail search-thumbnail">
          <img
            v-show="!course.image"
            class="media-object"
            src="/static/image/demo-course.jpg"
          />
          <img
            v-show="course.image"
            class="media-object"
            v-bind:src="course.image"
          />

          <div class="caption">
            <div class="clearfix">
              <span class="pull-right label label-primary info-label">{{
                COURSE_LEVEL | optionKV(course.level)
              }}</span>
              <span class="pull-right label label-primary info-label">{{
                COURSE_CHARGE | optionKV(course.charge)
              }}</span>
              <span class="pull-right label label-primary info-label">{{
                COURSE_STATUS | optionKV(course.status)
              }}</span>
            </div>

            <h3 class="search-title">
              <a href="#" class="blue">{{ course.name }} </a>
            </h3>

            <p>
              <span class="blue bolder bigger-150"
                >{{ course.price }}&nbsp;<i class="fa fa-rmb"></i
              ></span>
            </p>

            <p>
              {{ course.summary }}
            </p>

            <p>
              <span class="badge badge-info"> {{ course.id }} </span>
              <span class="badge badge-info">排序:{{ course.sort }} </span>
              <span class="badge badge-info"
                >时长:{{ course.time | formatSecond }}
              </span>
            </p>
            <p>
              <button
                v-on:click="toChapter(course)"
                class="btn btn-white btn-xs btn-default btn-round"
              >
                <i class="ace-icon fa fa-edit"></i>
                大章
              </button>
              <button
                v-on:click="edit(course)"
                class="btn btn-white btn-xs btn-info btn-round"
              >
                <!-- <i class="ace-icon fa fa-pencil bigger-120"></i> -->
                编辑
              </button>
              <button
                v-on:click="del(course.id)"
                class="btn btn-white btn-xs btn-warning btn-round"
              >
                <!-- <i class="ace-icon fa fa-trash-o bigger-120"></i> -->
                删除
              </button>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- <table id="simple-table" class="table table-bordered table-hover">
      <thead>
        <tr>
          <th>id</th>
          <th>名称</th>
          <th>概述</th>
          <th>时长</th>
          <th>价格（元）</th>
          <th>封面</th>
          <th>级别</th>
          <th>收费</th>
          <th>状态</th>
          <th>报名数</th>
          <th>顺序</th>
          <th>操作</th>
        </tr>
      </thead>

      <tbody>
        <tr v-for="course in courses">
          <td>{{ course.id }}</td>
          <td>{{ course.name }}</td>
          <td>{{ course.summary }}</td>
          <td>{{ course.time }}</td>
          <td>{{ course.price }}</td>
          <td>{{ course.image }}</td>
          <td>{{ COURSE_LEVEL | optionKV(course.level) }}</td>
          <td>{{ COURSE_CHARGE | optionKV(course.charge) }}</td>
          <td>{{ COURSE_STATUS | optionKV(course.status) }}</td>
          <td>{{ course.enroll }}</td>
          <td>{{ course.sort }}</td>
          <td>
            <div class="hidden-sm hidden-xs btn-group">
              <button v-on:click="edit(course)" class="btn btn-xs btn-info">
                <i class="ace-icon fa fa-pencil bigger-120"></i>
              </button>
              <button v-on:click="del(course.id)" class="btn btn-xs btn-danger">
                <i class="ace-icon fa fa-trash-o bigger-120"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table> -->

    <div id="form-modal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title">表单</h4>
          </div>
          <div class="modal-body">
            <form class="form-horizontal">
              <div class="form-group">
                <label class="col-sm-2 control-label"> 分类 </label>
                <div class="col-sm-10">
                  <ul id="tree" class="ztree"></ul>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">名称</label>
                <div class="col-sm-10">
                  <input v-model="course.name" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">概述</label>
                <div class="col-sm-10">
                  <input v-model="course.summary" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">时长</label>
                <div class="col-sm-10">
                  <input v-model="course.time" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">价格</label>
                <div class="col-sm-10">
                  <input v-model="course.price" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">封面</label>
                <div class="col-sm-10">
                  <input v-model="course.image" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">级别</label>
                <div class="col-sm-10">
                  <select v-model="course.level" class="form-control">
                    <option v-for="o in COURSE_LEVEL" v-bind:value="o.key">
                      {{ o.value }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">收费</label>
                <div class="col-sm-10">
                  <select v-model="course.charge" class="form-control">
                    <option v-for="o in COURSE_CHARGE" v-bind:value="o.key">
                      {{ o.value }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">状态</label>
                <div class="col-sm-10">
                  <select v-model="course.status" class="form-control">
                    <option v-for="o in COURSE_STATUS" v-bind:value="o.key">
                      {{ o.value }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">报名数</label>
                <div class="col-sm-10">
                  <input v-model="course.enroll" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">顺序</label>
                <div class="col-sm-10">
                  <input v-model="course.sort" class="form-control" />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              取消
            </button>
            <button v-on:click="save()" type="button" class="btn btn-primary">
              保存
            </button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
  </div>
</template>

<script>
import Pagination from "../../components/pagination";
export default {
  components: { Pagination },
  name: "business-course",
  data: function () {
    return {
      course: {},
      courses: [],
      COURSE_LEVEL: COURSE_LEVEL,
      COURSE_CHARGE: COURSE_CHARGE,
      COURSE_STATUS: COURSE_STATUS,
    };
  },
  mounted: function () {
    let _this = this;
    _this.$refs.pagination.size = 5;
    _this.initTree();
    _this.list(1);

    // sidebar激活样式方法一
    // this.$parent.activeSidebar("business-course-sidebar");
  },
  methods: {
    initTree() {
      let _this = this;
      let setting = {
        check: {
          enable: true,
        },
        data: {
          simpleData: {
            enable: true,
          },
        },
      };

      let zNodes = [
        { id: 1, pId: 0, name: "随意勾选 1", open: true },
        { id: 11, pId: 1, name: "随意勾选 1-1", open: true },
        { id: 111, pId: 11, name: "随意勾选 1-1-1" },
        { id: 112, pId: 11, name: "随意勾选 1-1-2" },
        { id: 12, pId: 1, name: "随意勾选 1-2", open: true },
        { id: 121, pId: 12, name: "随意勾选 1-2-1" },
        { id: 122, pId: 12, name: "随意勾选 1-2-2" },
        { id: 2, pId: 0, name: "随意勾选 2", checked: true, open: true },
        { id: 21, pId: 2, name: "随意勾选 2-1" },
        { id: 22, pId: 2, name: "随意勾选 2-2", open: true },
        { id: 221, pId: 22, name: "随意勾选 2-2-1", checked: true },
        { id: 222, pId: 22, name: "随意勾选 2-2-2" },
        { id: 23, pId: 2, name: "随意勾选 2-3" },
      ];
      $.fn.zTree.init($("#tree"), setting, zNodes);
    },
    /**
     * ,点击【新增】
     */
    add() {
      let _this = this;
      _this.course = {};
      $("#form-modal").modal("show");
    },

    /**
     * 点击【编辑】
     */
    edit(course) {
      let _this = this;
      _this.course = $.extend({}, course);
      $("#form-modal").modal("show");
    },
    /**
     * 点击【大章】
     */
    toChapter(course) {
      let _this = this;
      SessionStorage.set("course", course);
      _this.$router.push("/business/chapter");
    },

    /**
     * 列表查询
     */
    list(page) {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(process.env.VUE_APP_SERVER + "/business/admin/course/list", {
          page: page,
          size: _this.$refs.pagination.size,
        })
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          _this.courses = resp.content.list;
          _this.$refs.pagination.render(page, resp.content.total);
        });
    },

    /**
     * 点击【保存】
     */
    save() {
      let _this = this;

      // 保存校验
      if (
        1 != 1 ||
        !Validator.require(_this.course.name, "名称") ||
        !Validator.length(_this.course.name, "名称", 1, 50) ||
        !Validator.length(_this.course.summary, "概述", 1, 2000) ||
        !Validator.length(_this.course.image, "封面", 1, 100)
      ) {
        return;
      }

      Loading.show();
      _this.$ajax
        .post(
          process.env.VUE_APP_SERVER + "/business/admin/course/save",
          _this.course
        )
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          if (resp.success) {
            $("#form-modal").modal("hide");
            _this.list(1);
            Toast.success("保存成功！");
          } else {
            Toast.warning(resp.message);
          }
        });
    },

    /**
     * 点击【删除】
     */
    del(id) {
      let _this = this;
      Confirm.show("删除课程后不可恢复，确认删除？", function () {
        Loading.show();
        _this.$ajax
          .delete(
            process.env.VUE_APP_SERVER + "/business/admin/course/delete/" + id
          )
          .then((response) => {
            Loading.hide();
            let resp = response.data;
            if (resp.success) {
              _this.list(1);
              Toast.success("删除成功！");
            }
          });
      });
    },
  },
};
</script>

<style scoped>
.caption h3 {
  font-size: 30px;
}
</style>
```



分类表 id parent name



修改完  couse.vue 获取所有的分类

```
<template>
  <div>
    <p>
      <button v-on:click="add()" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-edit"></i>
        新增
      </button>
      &nbsp;
      <button v-on:click="list(1)" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-refresh"></i>
        刷新
      </button>
    </p>

    <pagination
      ref="pagination"
      v-bind:list="list"
      v-bind:itemCount="8"
    ></pagination>

    <div class="row">
      <div v-for="course in courses" class="col-md-4">
        <div class="thumbnail search-thumbnail">
          <img
            v-show="!course.image"
            class="media-object"
            src="/static/image/demo-course.jpg"
          />
          <img
            v-show="course.image"
            class="media-object"
            v-bind:src="course.image"
          />

          <div class="caption">
            <div class="clearfix">
              <span class="pull-right label label-primary info-label">{{
                COURSE_LEVEL | optionKV(course.level)
              }}</span>
              <span class="pull-right label label-primary info-label">{{
                COURSE_CHARGE | optionKV(course.charge)
              }}</span>
              <span class="pull-right label label-primary info-label">{{
                COURSE_STATUS | optionKV(course.status)
              }}</span>
            </div>

            <h3 class="search-title">
              <a href="#" class="blue">{{ course.name }} </a>
            </h3>

            <p>
              <span class="blue bolder bigger-150"
                >{{ course.price }}&nbsp;<i class="fa fa-rmb"></i
              ></span>
            </p>

            <p>
              {{ course.summary }}
            </p>

            <p>
              <span class="badge badge-info"> {{ course.id }} </span>
              <span class="badge badge-info">排序:{{ course.sort }} </span>
              <span class="badge badge-info"
                >时长:{{ course.time | formatSecond }}
              </span>
            </p>
            <p>
              <button
                v-on:click="toChapter(course)"
                class="btn btn-white btn-xs btn-default btn-round"
              >
                <i class="ace-icon fa fa-edit"></i>
                大章
              </button>
              <button
                v-on:click="edit(course)"
                class="btn btn-white btn-xs btn-info btn-round"
              >
                <!-- <i class="ace-icon fa fa-pencil bigger-120"></i> -->
                编辑
              </button>
              <button
                v-on:click="del(course.id)"
                class="btn btn-white btn-xs btn-warning btn-round"
              >
                <!-- <i class="ace-icon fa fa-trash-o bigger-120"></i> -->
                删除
              </button>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- <table id="simple-table" class="table table-bordered table-hover">
      <thead>
        <tr>
          <th>id</th>
          <th>名称</th>
          <th>概述</th>
          <th>时长</th>
          <th>价格（元）</th>
          <th>封面</th>
          <th>级别</th>
          <th>收费</th>
          <th>状态</th>
          <th>报名数</th>
          <th>顺序</th>
          <th>操作</th>
        </tr>
      </thead>

      <tbody>
        <tr v-for="course in courses">
          <td>{{ course.id }}</td>
          <td>{{ course.name }}</td>
          <td>{{ course.summary }}</td>
          <td>{{ course.time }}</td>
          <td>{{ course.price }}</td>
          <td>{{ course.image }}</td>
          <td>{{ COURSE_LEVEL | optionKV(course.level) }}</td>
          <td>{{ COURSE_CHARGE | optionKV(course.charge) }}</td>
          <td>{{ COURSE_STATUS | optionKV(course.status) }}</td>
          <td>{{ course.enroll }}</td>
          <td>{{ course.sort }}</td>
          <td>
            <div class="hidden-sm hidden-xs btn-group">
              <button v-on:click="edit(course)" class="btn btn-xs btn-info">
                <i class="ace-icon fa fa-pencil bigger-120"></i>
              </button>
              <button v-on:click="del(course.id)" class="btn btn-xs btn-danger">
                <i class="ace-icon fa fa-trash-o bigger-120"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table> -->

    <div id="form-modal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title">表单</h4>
          </div>
          <div class="modal-body">
            <form class="form-horizontal">
              <div class="form-group">
                <label class="col-sm-2 control-label"> 分类 </label>
                <div class="col-sm-10">
                  <ul id="tree" class="ztree"></ul>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">名称</label>
                <div class="col-sm-10">
                  <input v-model="course.name" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">概述</label>
                <div class="col-sm-10">
                  <input v-model="course.summary" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">时长</label>
                <div class="col-sm-10">
                  <input v-model="course.time" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">价格</label>
                <div class="col-sm-10">
                  <input v-model="course.price" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">封面</label>
                <div class="col-sm-10">
                  <input v-model="course.image" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">级别</label>
                <div class="col-sm-10">
                  <select v-model="course.level" class="form-control">
                    <option v-for="o in COURSE_LEVEL" v-bind:value="o.key">
                      {{ o.value }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">收费</label>
                <div class="col-sm-10">
                  <select v-model="course.charge" class="form-control">
                    <option v-for="o in COURSE_CHARGE" v-bind:value="o.key">
                      {{ o.value }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">状态</label>
                <div class="col-sm-10">
                  <select v-model="course.status" class="form-control">
                    <option v-for="o in COURSE_STATUS" v-bind:value="o.key">
                      {{ o.value }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">报名数</label>
                <div class="col-sm-10">
                  <input v-model="course.enroll" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">顺序</label>
                <div class="col-sm-10">
                  <input v-model="course.sort" class="form-control" />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              取消
            </button>
            <button v-on:click="save()" type="button" class="btn btn-primary">
              保存
            </button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
  </div>
</template>

<script>
import Pagination from "../../components/pagination";
export default {
  components: { Pagination },
  name: "business-course",
  data: function () {
    return {
      course: {},
      courses: [],
      COURSE_LEVEL: COURSE_LEVEL,
      COURSE_CHARGE: COURSE_CHARGE,
      COURSE_STATUS: COURSE_STATUS,
      categorys: [],
    };
  },
  mounted: function () {
    let _this = this;
    _this.$refs.pagination.size = 5;
    _this.allCategory();
    _this.list(1);

    // sidebar激活样式方法一
    // this.$parent.activeSidebar("business-course-sidebar");
  },
  methods: {
    allCategory() {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(process.env.VUE_APP_SERVER + "/business/admin/category/all")
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          _this.categorys = resp.content;

          _this.initTree();
        });
    },

    initTree() {
      let _this = this;
      let setting = {
        check: {
          enable: true,
        },
        data: {
          simpleData: {
            idKey: "id",
            pIdKey: "parent",
            rootPId: "00000000",
            enable: true,
          },
        },
      };

      let zNodes = _this.categorys;
      $.fn.zTree.init($("#tree"), setting, zNodes);
    },
    /**
     * ,点击【新增】
     */
    add() {
      let _this = this;
      _this.course = {};
      $("#form-modal").modal("show");
    },

    /**
     * 点击【编辑】
     */
    edit(course) {
      let _this = this;
      _this.course = $.extend({}, course);
      $("#form-modal").modal("show");
    },
    /**
     * 点击【大章】
     */
    toChapter(course) {
      let _this = this;
      SessionStorage.set("course", course);
      _this.$router.push("/business/chapter");
    },

    /**
     * 列表查询
     */
    list(page) {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(process.env.VUE_APP_SERVER + "/business/admin/course/list", {
          page: page,
          size: _this.$refs.pagination.size,
        })
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          _this.courses = resp.content.list;
          _this.$refs.pagination.render(page, resp.content.total);
        });
    },

    /**
     * 点击【保存】
     */
    save() {
      let _this = this;

      // 保存校验
      if (
        1 != 1 ||
        !Validator.require(_this.course.name, "名称") ||
        !Validator.length(_this.course.name, "名称", 1, 50) ||
        !Validator.length(_this.course.summary, "概述", 1, 2000) ||
        !Validator.length(_this.course.image, "封面", 1, 100)
      ) {
        return;
      }

      Loading.show();
      _this.$ajax
        .post(
          process.env.VUE_APP_SERVER + "/business/admin/course/save",
          _this.course
        )
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          if (resp.success) {
            $("#form-modal").modal("hide");
            _this.list(1);
            Toast.success("保存成功！");
          } else {
            Toast.warning(resp.message);
          }
        });
    },

    /**
     * 点击【删除】
     */
    del(id) {
      let _this = this;
      Confirm.show("删除课程后不可恢复，确认删除？", function () {
        Loading.show();
        _this.$ajax
          .delete(
            process.env.VUE_APP_SERVER + "/business/admin/course/delete/" + id
          )
          .then((response) => {
            Loading.hide();
            let resp = response.data;
            if (resp.success) {
              _this.list(1);
              Toast.success("删除成功！");
            }
          });
      });
    },
  },
};
</script>

<style scoped>
.caption h3 {
  font-size: 30px;
}
</style>
```



## 保存课程时，同时保存课程分类

```
# 课程分类
drop table if exists `course_category`;
create table `course_category` (
  `id` char(8) not null default '' comment 'id',
  `course_id` char(8) comment '课程|course.id',
  `category_id` char(8) comment '分类|course.id',
  primary key (`id`)
) engine=innodb default charset=utf8mb4 comment='课程分类';

```





生成持久层



生成服务， 这里有一个bug

```
List<Field> fieldList = DbUtil.getColumnByTableName(tableName); // domain
```



可以去掉生成出来的controller



我们只需要保存分类的id，所以数据传输可以选择id数组，也可以选择category数组





修改courseDto

```java
package com.lzn.dto;

import java.math.BigDecimal;
import java.util.Date;
import java.util.List;

import com.fasterxml.jackson.annotation.JsonFormat;

public class CourseDto {

    /**
     * id
     */
    private String id;

    /**
     * 名称
     */
    private String name;

    /**
     * 概述
     */
    private String summary;

    /**
     * 时长|单位秒
     */
    private Integer time;

    /**
     * 价格（元）
     */
    private BigDecimal price;

    /**
     * 封面
     */
    private String image;

    /**
     * 级别|枚举[CourseLevelEnum]：ONE("1", "初级"),TWO("2", "中级"),THREE("3", "高级")
     */
    private String level;

    /**
     * 收费|枚举[CourseChargeEnum]：CHARGE("C", "收费"),FREE("F", "免费")
     */
    private String charge;

    /**
     * 状态|枚举[CourseStatusEnum]：PUBLISH("P", "发布"),DRAFT("D", "草稿")
     */
    private String status;

    /**
     * 报名数
     */
    private Integer enroll;

    /**
     * 顺序
     */
    private Integer sort;

    /**
     * 创建时间
     */
    @JsonFormat(pattern="yyyy-MM-dd HH:mm:ss",timezone = "GMT+8")
    private Date createdAt;

    /**
     * 修改时间
     */
    @JsonFormat(pattern="yyyy-MM-dd HH:mm:ss",timezone = "GMT+8")
    private Date updatedAt;

    @Override
    public String toString() {
        return "CourseDto{" +
                "id='" + id + '\'' +
                ", name='" + name + '\'' +
                ", summary='" + summary + '\'' +
                ", time=" + time +
                ", price=" + price +
                ", image='" + image + '\'' +
                ", level='" + level + '\'' +
                ", charge='" + charge + '\'' +
                ", status='" + status + '\'' +
                ", enroll=" + enroll +
                ", sort=" + sort +
                ", createdAt=" + createdAt +
                ", updatedAt=" + updatedAt +
                ", categorys=" + categorys +
                '}';
    }

    public List<CategoryDto> getCategorys() {
        return categorys;
    }

    public void setCategorys(List<CategoryDto> categorys) {
        this.categorys = categorys;
    }

    private List<CategoryDto> categorys;



    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getSummary() {
        return summary;
    }

    public void setSummary(String summary) {
        this.summary = summary;
    }

    public Integer getTime() {
        return time;
    }

    public void setTime(Integer time) {
        this.time = time;
    }

    public BigDecimal getPrice() {
        return price;
    }

    public void setPrice(BigDecimal price) {
        this.price = price;
    }

    public String getImage() {
        return image;
    }

    public void setImage(String image) {
        this.image = image;
    }

    public String getLevel() {
        return level;
    }

    public void setLevel(String level) {
        this.level = level;
    }

    public String getCharge() {
        return charge;
    }

    public void setCharge(String charge) {
        this.charge = charge;
    }

    public String getStatus() {
        return status;
    }

    public void setStatus(String status) {
        this.status = status;
    }

    public Integer getEnroll() {
        return enroll;
    }

    public void setEnroll(Integer enroll) {
        this.enroll = enroll;
    }

    public Integer getSort() {
        return sort;
    }

    public void setSort(Integer sort) {
        this.sort = sort;
    }

    public Date getCreatedAt() {
        return createdAt;
    }

    public void setCreatedAt(Date createdAt) {
        this.createdAt = createdAt;
    }

    public Date getUpdatedAt() {
        return updatedAt;
    }

    public void setUpdatedAt(Date updatedAt) {
        this.updatedAt = updatedAt;
    }


}
```



保存课程时，调用saveBatch，那么课程新增的时候，会批量插入数据，课程更新的时候，会再次批量插入数据，每次调用保存都会批量插入数据

CourseCategoryService

```
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.CourseCategory;
import com.lzn.domain.CourseCategoryExample;
import com.lzn.domain.Test;
import com.lzn.domain.TestExample;
import com.lzn.dto.CategoryDto;
import com.lzn.dto.CourseCategoryDto;
import com.lzn.dto.PageDto;
import com.lzn.mapper.CourseCategoryMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;


@Service
public class CourseCategoryService {

    @Autowired
    private CourseCategoryMapper courseCategoryMapper;


    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        CourseCategoryExample courseCategoryExample = new CourseCategoryExample();


        List<CourseCategory> courseCategoryList = courseCategoryMapper.selectByExample(courseCategoryExample);

        PageInfo<CourseCategory> pageInfo = new PageInfo<>(courseCategoryList);
        pageDto.setTotal(pageInfo.getTotal());

        List<CourseCategoryDto> courseCategoryDtoList = new ArrayList<>();

        for(int i = 0;i<courseCategoryList.size();++i){
            CourseCategory courseCategory = courseCategoryList.get(i);
            CourseCategoryDto courseCategoryDto = new CourseCategoryDto();
            BeanUtils.copyProperties(courseCategory, courseCategoryDto);
            courseCategoryDtoList.add(courseCategoryDto);
        }
        pageDto.setList(courseCategoryDtoList);

    }

    public void save(CourseCategoryDto courseCategoryDto){
        CourseCategory courseCategory = CopyUtil.copy(courseCategoryDto, CourseCategory.class);
        if(StringUtils.isEmpty(courseCategoryDto.getId())){
            this.insert(courseCategory);
        } else {
            this.update(courseCategory);
        }
    }

    private void insert(CourseCategory courseCategory){
        courseCategory.setId(UuidUtil.getShortUuid());
        courseCategoryMapper.insert(courseCategory);
    }


    private void update(CourseCategory courseCategory){
        courseCategoryMapper.updateByPrimaryKey(courseCategory);
    }

    public void delete(String id) {
        courseCategoryMapper.deleteByPrimaryKey(id);
    }


    /**
     * 根据某一课程，先清空课程分类，再保存课程分类
     * @param dtoList
     */
    @Transactional
    public void saveBatch(String courseId, List<CategoryDto> dtoList) {
        CourseCategoryExample example = new CourseCategoryExample();
        example.createCriteria().andCourseIdEqualTo(courseId);
        courseCategoryMapper.deleteByExample(example);
        for (int i = 0, l = dtoList.size(); i < l; i++) {
            CategoryDto categoryDto = dtoList.get(i);
            CourseCategory courseCategory = new CourseCategory();
            courseCategory.setId(UuidUtil.getShortUuid());
            courseCategory.setCourseId(courseId);
            courseCategory.setCategoryId(categoryDto.getId());
            insert(courseCategory);
        }
    }
}
```



CourseService

```
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.Course;
import com.lzn.domain.CourseExample;
import com.lzn.domain.Test;
import com.lzn.domain.TestExample;
import com.lzn.dto.CourseDto;
import com.lzn.dto.PageDto;
import com.lzn.mapper.CourseMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.mapper.my.MyCourseMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;

    import java.util.Date;

@Service
public class CourseService {
    private static final Logger LOG = LoggerFactory.getLogger(CourseService.class);

    @Autowired
    private CourseMapper courseMapper;

    @Autowired
    private MyCourseMapper myCourseMapper;

    @Autowired
    private CourseCategoryService courseCategoryService;


    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        CourseExample courseExample = new CourseExample();

        courseExample.setOrderByClause("sort asc");

        List<Course> courseList = courseMapper.selectByExample(courseExample);

        PageInfo<Course> pageInfo = new PageInfo<>(courseList);
        pageDto.setTotal(pageInfo.getTotal());

        List<CourseDto> courseDtoList = new ArrayList<>();

        for(int i = 0;i<courseList.size();++i){
            Course course = courseList.get(i);
            CourseDto courseDto = new CourseDto();
            BeanUtils.copyProperties(course, courseDto);
            courseDtoList.add(courseDto);
        }
        pageDto.setList(courseDtoList);

    }

    public void save(CourseDto courseDto){
        Course course = CopyUtil.copy(courseDto, Course.class);
        if(StringUtils.isEmpty(courseDto.getId())){
            this.insert(course);
        } else {
            this.update(course);
        }

        // 批量保存课程分类
        courseCategoryService.saveBatch(courseDto.getId(), courseDto.getCategorys());

    }

    private void insert(Course course){
        Date now = new Date();
        course.setCreatedAt(now);
        course.setUpdatedAt(now);
        course.setId(UuidUtil.getShortUuid());
        courseMapper.insert(course);
    }


    private void update(Course course){
        course.setUpdatedAt(new Date());
        courseMapper.updateByPrimaryKey(course);
    }

    public void delete(String id) {
        courseMapper.deleteByPrimaryKey(id);
    }

    /**
     * 更新课程时长
     * @param courseId
     * @return
     */
    public void updateTime(String courseId) {
        LOG.info("更新课程时长：{}", courseId);
        myCourseMapper.updateTime(courseId);
    }


}
```





## 编辑课程时候，加载课程分类树，并设置勾选

courseService.java

```
@Transactional
public void save(CourseDto courseDto){
    Course course = CopyUtil.copy(courseDto, Course.class);
    if(StringUtils.isEmpty(courseDto.getId())){
        this.insert(course);
    } else {
        this.update(course);
    }

    // 批量保存课程分类
    courseCategoryService.saveBatch(courseDto.getId(), courseDto.getCategorys());

}
```



外层save增加了事务，saveBatch按理也可以不加事务，但是由于本身也是多个sql操作

且以后可能被多个地方调用，为了防止外层save忘记加事务，所以在saveBatch加事务，以防万一

```
CourseCategoryService
```

```
/**
 * 查找课程下所有分类
 * @param courseId
 */
public List<CourseCategoryDto> listByCourse(String courseId) {
    CourseCategoryExample example = new CourseCategoryExample();
    example.createCriteria().andCourseIdEqualTo(courseId);
    List<CourseCategory> courseCategoryList = courseCategoryMapper.selectByExample(example);
    return CopyUtil.copyList(courseCategoryList, CourseCategoryDto.class);
}
```





courseController

```
package com.lzn.business.controller.admin;

import com.lzn.dto.CourseCategoryDto;
import com.lzn.dto.CourseDto;
import com.lzn.dto.PageDto;
import com.lzn.dto.ResponseDto;
import com.lzn.service.CourseCategoryService;
import com.lzn.service.CourseService;
import com.lzn.util.ValidatorUtil;
import org.checkerframework.checker.units.qual.A;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/admin/course")
public class CourseController {

    public static final String BUSINESS_NAME = "课程";

    @Autowired
    private CourseService courseService;

    @Autowired
    private CourseCategoryService courseCategoryService;

    @PostMapping("/list")
    public ResponseDto list(@RequestBody PageDto pageDto) {
        ResponseDto responseDto = new ResponseDto();
        courseService.list(pageDto);
        responseDto.setContent(pageDto);
        return responseDto;
    }
    @PostMapping("/save")
    public ResponseDto save(@RequestBody CourseDto courseDto){
        // 保存校验
        ValidatorUtil.require(courseDto.getName(), "名称");
        ValidatorUtil.length(courseDto.getName(), "名称", 1, 50);
        ValidatorUtil.length(courseDto.getSummary(), "概述", 1, 2000);
        ValidatorUtil.length(courseDto.getImage(), "封面", 1, 100);


        ResponseDto responseDto = new ResponseDto();
        courseService.save(courseDto);
        responseDto.setContent(courseDto);
        return responseDto;
    }

    @DeleteMapping("/delete/{id}")
    public ResponseDto delete(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        courseService.delete(id);
        return responseDto;
    }

    /**
     * 查找课程下所有分类
     * @param courseId
     */
    @PostMapping("/list-category/{courseId}")
    public ResponseDto listCategory(@PathVariable(value = "courseId") String courseId) {
        ResponseDto responseDto = new ResponseDto();
        List<CourseCategoryDto> dtoList = courseCategoryService.listByCourse(courseId);
        responseDto.setContent(dtoList);
        return responseDto;
    }
}
```





course.vue

```vue
<template>
  <div>
    <p>
      <button v-on:click="add()" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-edit"></i>
        新增
      </button>
      &nbsp;
      <button v-on:click="list(1)" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-refresh"></i>
        刷新
      </button>
    </p>

    <pagination
      ref="pagination"
      v-bind:list="list"
      v-bind:itemCount="8"
    ></pagination>

    <div class="row">
      <div v-for="course in courses" class="col-md-4">
        <div class="thumbnail search-thumbnail">
          <img
            v-show="!course.image"
            class="media-object"
            src="/static/image/demo-course.jpg"
          />
          <img
            v-show="course.image"
            class="media-object"
            v-bind:src="course.image"
          />

          <div class="caption">
            <div class="clearfix">
              <span class="pull-right label label-primary info-label">{{
                COURSE_LEVEL | optionKV(course.level)
              }}</span>
              <span class="pull-right label label-primary info-label">{{
                COURSE_CHARGE | optionKV(course.charge)
              }}</span>
              <span class="pull-right label label-primary info-label">{{
                COURSE_STATUS | optionKV(course.status)
              }}</span>
            </div>

            <h3 class="search-title">
              <a href="#" class="blue">{{ course.name }} </a>
            </h3>

            <p>
              <span class="blue bolder bigger-150"
                >{{ course.price }}&nbsp;<i class="fa fa-rmb"></i
              ></span>
            </p>

            <p>
              {{ course.summary }}
            </p>

            <p>
              <span class="badge badge-info"> {{ course.id }} </span>
              <span class="badge badge-info">排序:{{ course.sort }} </span>
              <span class="badge badge-info"
                >时长:{{ course.time | formatSecond }}
              </span>
            </p>
            <p>
              <button
                v-on:click="toChapter(course)"
                class="btn btn-white btn-xs btn-default btn-round"
              >
                <i class="ace-icon fa fa-edit"></i>
                大章
              </button>
              <button
                v-on:click="edit(course)"
                class="btn btn-white btn-xs btn-info btn-round"
              >
                <!-- <i class="ace-icon fa fa-pencil bigger-120"></i> -->
                编辑
              </button>
              <button
                v-on:click="del(course.id)"
                class="btn btn-white btn-xs btn-warning btn-round"
              >
                <!-- <i class="ace-icon fa fa-trash-o bigger-120"></i> -->
                删除
              </button>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- <table id="simple-table" class="table table-bordered table-hover">
      <thead>
        <tr>
          <th>id</th>
          <th>名称</th>
          <th>概述</th>
          <th>时长</th>
          <th>价格（元）</th>
          <th>封面</th>
          <th>级别</th>
          <th>收费</th>
          <th>状态</th>
          <th>报名数</th>
          <th>顺序</th>
          <th>操作</th>
        </tr>
      </thead>

      <tbody>
        <tr v-for="course in courses">
          <td>{{ course.id }}</td>
          <td>{{ course.name }}</td>
          <td>{{ course.summary }}</td>
          <td>{{ course.time }}</td>
          <td>{{ course.price }}</td>
          <td>{{ course.image }}</td>
          <td>{{ COURSE_LEVEL | optionKV(course.level) }}</td>
          <td>{{ COURSE_CHARGE | optionKV(course.charge) }}</td>
          <td>{{ COURSE_STATUS | optionKV(course.status) }}</td>
          <td>{{ course.enroll }}</td>
          <td>{{ course.sort }}</td>
          <td>
            <div class="hidden-sm hidden-xs btn-group">
              <button v-on:click="edit(course)" class="btn btn-xs btn-info">
                <i class="ace-icon fa fa-pencil bigger-120"></i>
              </button>
              <button v-on:click="del(course.id)" class="btn btn-xs btn-danger">
                <i class="ace-icon fa fa-trash-o bigger-120"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table> -->

    <div id="form-modal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title">表单</h4>
          </div>
          <div class="modal-body">
            <form class="form-horizontal">
              <div class="form-group">
                <label class="col-sm-2 control-label"> 分类 </label>
                <div class="col-sm-10">
                  <ul id="tree" class="ztree"></ul>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">名称</label>
                <div class="col-sm-10">
                  <input v-model="course.name" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">概述</label>
                <div class="col-sm-10">
                  <input v-model="course.summary" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">时长</label>
                <div class="col-sm-10">
                  <input v-model="course.time" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">价格</label>
                <div class="col-sm-10">
                  <input v-model="course.price" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">封面</label>
                <div class="col-sm-10">
                  <input v-model="course.image" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">级别</label>
                <div class="col-sm-10">
                  <select v-model="course.level" class="form-control">
                    <option v-for="o in COURSE_LEVEL" v-bind:value="o.key">
                      {{ o.value }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">收费</label>
                <div class="col-sm-10">
                  <select v-model="course.charge" class="form-control">
                    <option v-for="o in COURSE_CHARGE" v-bind:value="o.key">
                      {{ o.value }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">状态</label>
                <div class="col-sm-10">
                  <select v-model="course.status" class="form-control">
                    <option v-for="o in COURSE_STATUS" v-bind:value="o.key">
                      {{ o.value }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">报名数</label>
                <div class="col-sm-10">
                  <input v-model="course.enroll" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">顺序</label>
                <div class="col-sm-10">
                  <input v-model="course.sort" class="form-control" />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              取消
            </button>
            <button v-on:click="save()" type="button" class="btn btn-primary">
              保存
            </button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
  </div>
</template>

<script>
import Pagination from "../../components/pagination";
export default {
  components: { Pagination },
  name: "business-course",
  data: function () {
    return {
      course: {},
      courses: [],
      COURSE_LEVEL: COURSE_LEVEL,
      COURSE_CHARGE: COURSE_CHARGE,
      COURSE_STATUS: COURSE_STATUS,
      categorys: [],
      tree: [],
    };
  },
  mounted: function () {
    let _this = this;
    _this.$refs.pagination.size = 5;
    _this.allCategory();
    _this.list(1);

    // sidebar激活样式方法一
    // this.$parent.activeSidebar("business-course-sidebar");
  },
  methods: {
    allCategory() {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(process.env.VUE_APP_SERVER + "/business/admin/category/all")
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          _this.categorys = resp.content;

          _this.initTree();
        });
    },

    initTree() {
      let _this = this;
      let setting = {
        check: {
          enable: true,
        },
        data: {
          simpleData: {
            idKey: "id",
            pIdKey: "parent",
            rootPId: "00000000",
            enable: true,
          },
        },
      };

      let zNodes = _this.categorys;
      _this.tree = $.fn.zTree.init($("#tree"), setting, zNodes);
      // 展开所有的节点
      _this.tree.expandAll(true);
    },
    /**
     * ,点击【新增】
     */
    add() {
      let _this = this;
      _this.course = {};
      // 新增的时候，让所有的节点都不选中
      _this.tree.checkAllNodes(false);
      $("#form-modal").modal("show");
    },

    /**
     * 点击【编辑】
     */
    edit(course) {
      let _this = this;
      _this.course = $.extend({}, course);
      _this.listCategory(course.id);
      $("#form-modal").modal("show");
    },
    /**
     * 点击【大章】
     */
    toChapter(course) {
      let _this = this;
      SessionStorage.set("course", course);
      _this.$router.push("/business/chapter");
    },

    /**
     * 查找课程下所有分类
     * @param courseId
     */
    listCategory(courseId) {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(
          process.env.VUE_APP_SERVER +
            "/business/admin/course/list-category/" +
            courseId
        )
        .then((res) => {
          Loading.hide();
          console.log("查找课程下所有分类结果：", res);
          let response = res.data;
          let categorys = response.content;

          // 勾选查询到的分类
          _this.tree.checkAllNodes(false);
          for (let i = 0; i < categorys.length; i++) {
            let node = _this.tree.getNodeByParam("id", categorys[i].categoryId);
            _this.tree.checkNode(node, true);
          }
        });
    },

    /**
     * 列表查询
     */
    list(page) {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(process.env.VUE_APP_SERVER + "/business/admin/course/list", {
          page: page,
          size: _this.$refs.pagination.size,
        })
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          _this.courses = resp.content.list;
          _this.$refs.pagination.render(page, resp.content.total);
        });
    },

    /**
     * 点击【保存】
     */
    save() {
      let _this = this;

      // 保存校验
      if (
        1 != 1 ||
        !Validator.require(_this.course.name, "名称") ||
        !Validator.length(_this.course.name, "名称", 1, 50) ||
        !Validator.length(_this.course.summary, "概述", 1, 2000) ||
        !Validator.length(_this.course.image, "封面", 1, 100)
      ) {
        return;
      }

      let categorys = _this.tree.getCheckedNodes();
      if (Tool.isEmpty(categorys)) {
        Toast.warning("请选择分类!");
        return;
      }
      _this.course.categorys = categorys;

      Loading.show();
      _this.$ajax
        .post(
          process.env.VUE_APP_SERVER + "/business/admin/course/save",
          _this.course
        )
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          if (resp.success) {
            $("#form-modal").modal("hide");
            _this.list(1);
            Toast.success("保存成功！");
          } else {
            Toast.warning(resp.message);
          }
        });
    },

    /**
     * 点击【删除】
     */
    del(id) {
      let _this = this;
      Confirm.show("删除课程后不可恢复，确认删除？", function () {
        Loading.show();
        _this.$ajax
          .delete(
            process.env.VUE_APP_SERVER + "/business/admin/course/delete/" + id
          )
          .then((response) => {
            Loading.hide();
            let resp = response.data;
            if (resp.success) {
              _this.list(1);
              Toast.success("删除成功！");
            }
          });
      });
    },
  },
};
</script>

<style scoped>
.caption h3 {
  font-size: 30px;
}
</style>
```





# 课程内容功能开发

## 课程内容表设计与基本代码生成



```sql
-- 课程内容
drop table if exists `course_content`;
create table `course_content` (
  `id` char(8) not null default '' comment '课程id',
  `content` mediumtext not null comment '课程内容',
  primary key (`id`)
) engine=innodb default charset=utf8mb4 comment='课程内容';
```



课程表和课程内容表是1：1的关系，两张表都用同样的id字段

课程详情一般会有文字、图片、视频等，所以用大字段，mediumtext比text长

大字段，尽量单独成一张表

方便dba的运维

分表： 垂直分表 水平分表

垂直分表：大字段，经常更新的字段





生成持久层代码

生成服务层代码

出现报错

```
updateByPrimaryKeyWithBLOBs
```

表里有大字段，就会生成withBLOBs方法

删除courseContentController以及service



## 完成课程内容管理

富文本编辑器 ，百度的有点笨重

https://summernote.org/ 所见即所得

课程内容只有读和写，没有列表查询，也没有删除



```
CourseService
```



新增课程的时候，course表有数据，course_content没有数据

先去select，看看有没有数据，在判断是insert还是update，

这样会执行两个sql，其实可以直接更新，没有更新到再插入，只有第一次会更新不到，执行两个sql，后面都只需要一个sql

```
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.*;
import com.lzn.dto.CourseContentDto;
import com.lzn.dto.CourseDto;
import com.lzn.dto.PageDto;
import com.lzn.mapper.CourseContentMapper;
import com.lzn.mapper.CourseMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.mapper.my.MyCourseMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;

    import java.util.Date;

@Service
public class CourseService {
    private static final Logger LOG = LoggerFactory.getLogger(CourseService.class);

    @Autowired
    private CourseMapper courseMapper;

    @Autowired
    private MyCourseMapper myCourseMapper;

    @Autowired
    private CourseCategoryService courseCategoryService;

    @Autowired
    private CourseContentMapper courseContentMapper;


    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        CourseExample courseExample = new CourseExample();

        courseExample.setOrderByClause("sort asc");

        List<Course> courseList = courseMapper.selectByExample(courseExample);

        PageInfo<Course> pageInfo = new PageInfo<>(courseList);
        pageDto.setTotal(pageInfo.getTotal());

        List<CourseDto> courseDtoList = new ArrayList<>();

        for(int i = 0;i<courseList.size();++i){
            Course course = courseList.get(i);
            CourseDto courseDto = new CourseDto();
            BeanUtils.copyProperties(course, courseDto);
            courseDtoList.add(courseDto);
        }
        pageDto.setList(courseDtoList);

    }

    @Transactional
    public void save(CourseDto courseDto){
        Course course = CopyUtil.copy(courseDto, Course.class);
        if(StringUtils.isEmpty(courseDto.getId())){
            this.insert(course);
        } else {
            this.update(course);
        }

        // 批量保存课程分类
        courseCategoryService.saveBatch(courseDto.getId(), courseDto.getCategorys());

    }

    private void insert(Course course){
        Date now = new Date();
        course.setCreatedAt(now);
        course.setUpdatedAt(now);
        course.setId(UuidUtil.getShortUuid());
        courseMapper.insert(course);
    }


    private void update(Course course){
        course.setUpdatedAt(new Date());
        courseMapper.updateByPrimaryKey(course);
    }

    public void delete(String id) {
        courseMapper.deleteByPrimaryKey(id);
    }

    /**
     * 更新课程时长
     * @param courseId
     * @return
     */
    public void updateTime(String courseId) {
        LOG.info("更新课程时长：{}", courseId);
        myCourseMapper.updateTime(courseId);
    }

    /**
     * 查找课程内容
     */
    public CourseContentDto findContent(String id) {
        CourseContent content = courseContentMapper.selectByPrimaryKey(id);
        if (content == null) {
            return null;
        }
        return CopyUtil.copy(content, CourseContentDto.class);
    }

    /**
     * 保存课程内容，包含新增和修改
     */
    public int saveContent(CourseContentDto contentDto) {
        CourseContent content = CopyUtil.copy(contentDto, CourseContent.class);
        int i = courseContentMapper.updateByPrimaryKeyWithBLOBs(content);
        if (i == 0) {
            i = courseContentMapper.insert(content);
        }
        return i;
    }



}
```







```
CourseController
```





```
package com.lzn.business.controller.admin;

import com.lzn.dto.*;
import com.lzn.service.CourseCategoryService;
import com.lzn.service.CourseService;
import com.lzn.util.ValidatorUtil;
import org.checkerframework.checker.units.qual.A;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/admin/course")
public class CourseController {

    public static final String BUSINESS_NAME = "课程";

    @Autowired
    private CourseService courseService;

    @Autowired
    private CourseCategoryService courseCategoryService;

    @PostMapping("/list")
    public ResponseDto list(@RequestBody PageDto pageDto) {
        ResponseDto responseDto = new ResponseDto();
        courseService.list(pageDto);
        responseDto.setContent(pageDto);
        return responseDto;
    }
    @PostMapping("/save")
    public ResponseDto save(@RequestBody CourseDto courseDto){
        // 保存校验
        ValidatorUtil.require(courseDto.getName(), "名称");
        ValidatorUtil.length(courseDto.getName(), "名称", 1, 50);
        ValidatorUtil.length(courseDto.getSummary(), "概述", 1, 2000);
        ValidatorUtil.length(courseDto.getImage(), "封面", 1, 100);


        ResponseDto responseDto = new ResponseDto();
        courseService.save(courseDto);
        responseDto.setContent(courseDto);
        return responseDto;
    }

    @DeleteMapping("/delete/{id}")
    public ResponseDto delete(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        courseService.delete(id);
        return responseDto;
    }

    /**
     * 查找课程下所有分类
     * @param courseId
     */
    @PostMapping("/list-category/{courseId}")
    public ResponseDto listCategory(@PathVariable(value = "courseId") String courseId) {
        ResponseDto responseDto = new ResponseDto();
        List<CourseCategoryDto> dtoList = courseCategoryService.listByCourse(courseId);
        responseDto.setContent(dtoList);
        return responseDto;
    }


    @GetMapping("/find-content/{id}")
    public ResponseDto findContent(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        CourseContentDto contentDto = courseService.findContent(id);
        responseDto.setContent(contentDto);
        return responseDto;
    }

    @PostMapping("/save-content")
    public ResponseDto saveContent(@RequestBody CourseContentDto contentDto) {
        ResponseDto responseDto = new ResponseDto();
        courseService.saveContent(contentDto);
        return responseDto;
    }

}
```





index.html

```
    <!--  富文本编辑器  -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.15/dist/summernote.min.css" rel="stylesheet">
    <!--  富文本编辑器  -->
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.15/dist/summernote.min.js"></script>

```



course.vue

```vue
<template>
  <div>
    <p>
      <button v-on:click="add()" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-edit"></i>
        新增
      </button>
      &nbsp;
      <button v-on:click="list(1)" class="btn btn-white btn-default btn-round">
        <i class="ace-icon fa fa-refresh"></i>
        刷新
      </button>
    </p>

    <pagination
      ref="pagination"
      v-bind:list="list"
      v-bind:itemCount="8"
    ></pagination>

    <div class="row">
      <div v-for="course in courses" class="col-md-4">
        <div class="thumbnail search-thumbnail">
          <img
            v-show="!course.image"
            class="media-object"
            src="/static/image/demo-course.jpg"
          />
          <img
            v-show="course.image"
            class="media-object"
            v-bind:src="course.image"
          />

          <div class="caption">
            <div class="clearfix">
              <span class="pull-right label label-primary info-label">{{
                COURSE_LEVEL | optionKV(course.level)
              }}</span>
              <span class="pull-right label label-primary info-label">{{
                COURSE_CHARGE | optionKV(course.charge)
              }}</span>
              <span class="pull-right label label-primary info-label">{{
                COURSE_STATUS | optionKV(course.status)
              }}</span>
            </div>

            <h3 class="search-title">
              <a href="#" class="blue">{{ course.name }} </a>
            </h3>

            <p>
              <span class="blue bolder bigger-150"
                >{{ course.price }}&nbsp;<i class="fa fa-rmb"></i
              ></span>
            </p>

            <p>
              {{ course.summary }}
            </p>

            <p>
              <span class="badge badge-info"> {{ course.id }} </span>
              <span class="badge badge-info">排序:{{ course.sort }} </span>
              <span class="badge badge-info"
                >时长:{{ course.time | formatSecond }}
              </span>
            </p>
            <p>
              <button
                v-on:click="toChapter(course)"
                class="btn btn-white btn-xs btn-default btn-round"
              >
                <i class="ace-icon fa fa-edit"></i>
                大章
              </button> &nbsp;

              <button
                v-on:click="editContent(course)"
                class="btn btn-white btn-xs btn-default btn-round"
              >
                <i class="ace-icon fa fa-edit"></i>
                内容
              </button>&nbsp;

              <button
                v-on:click="edit(course)"
                class="btn btn-white btn-xs btn-info btn-round"
              >
                <!-- <i class="ace-icon fa fa-pencil bigger-120"></i> -->
                编辑
              </button>&nbsp;
              <button
                v-on:click="del(course.id)"
                class="btn btn-white btn-xs btn-warning btn-round"
              >
                <!-- <i class="ace-icon fa fa-trash-o bigger-120"></i> -->
                删除
              </button>
            </p>
          </div>
        </div>
      </div>
    </div>

    <div id="form-modal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title">表单</h4>
          </div>
          <div class="modal-body">
            <form class="form-horizontal">
              <div class="form-group">
                <label class="col-sm-2 control-label"> 分类 </label>
                <div class="col-sm-10">
                  <ul id="tree" class="ztree"></ul>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">名称</label>
                <div class="col-sm-10">
                  <input v-model="course.name" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">概述</label>
                <div class="col-sm-10">
                  <input v-model="course.summary" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">时长</label>
                <div class="col-sm-10">
                  <input v-model="course.time" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">价格</label>
                <div class="col-sm-10">
                  <input v-model="course.price" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">封面</label>
                <div class="col-sm-10">
                  <input v-model="course.image" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">级别</label>
                <div class="col-sm-10">
                  <select v-model="course.level" class="form-control">
                    <option v-for="o in COURSE_LEVEL" v-bind:value="o.key">
                      {{ o.value }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">收费</label>
                <div class="col-sm-10">
                  <select v-model="course.charge" class="form-control">
                    <option v-for="o in COURSE_CHARGE" v-bind:value="o.key">
                      {{ o.value }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">状态</label>
                <div class="col-sm-10">
                  <select v-model="course.status" class="form-control">
                    <option v-for="o in COURSE_STATUS" v-bind:value="o.key">
                      {{ o.value }}
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">报名数</label>
                <div class="col-sm-10">
                  <input v-model="course.enroll" class="form-control" />
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">顺序</label>
                <div class="col-sm-10">
                  <input v-model="course.sort" class="form-control" />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              取消
            </button>
            <button v-on:click="save()" type="button" class="btn btn-primary">
              保存
            </button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <!-- Modal -->
    <div
      class="modal fade"
      id="course-content-modal"
      tabindex="-1"
      role="dialog"
    >
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
            <h4 class="modal-title">内容编辑</h4>
          </div>
          <div class="modal-body">
            <form class="form-horizontal">
              <div class="form-group">
                <div class="col-lg-12">
                  <div id="content"></div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              取消
            </button>
            <button v-on:click="saveContent()" type="button" class="btn btn-primary">
              保存
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import Pagination from "../../components/pagination";
export default {
  components: { Pagination },
  name: "business-course",
  data: function () {
    return {
      course: {},
      courses: [],
      COURSE_LEVEL: COURSE_LEVEL,
      COURSE_CHARGE: COURSE_CHARGE,
      COURSE_STATUS: COURSE_STATUS,
      categorys: [],
      tree: [],
    };
  },
  mounted: function () {
    let _this = this;
    _this.$refs.pagination.size = 5;
    _this.allCategory();
    _this.list(1);

    // sidebar激活样式方法一
    // this.$parent.activeSidebar("business-course-sidebar");
  },
  methods: {
    allCategory() {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(process.env.VUE_APP_SERVER + "/business/admin/category/all")
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          _this.categorys = resp.content;

          _this.initTree();
        });
    },

    initTree() {
      let _this = this;
      let setting = {
        check: {
          enable: true,
        },
        data: {
          simpleData: {
            idKey: "id",
            pIdKey: "parent",
            rootPId: "00000000",
            enable: true,
          },
        },
      };

      let zNodes = _this.categorys;
      _this.tree = $.fn.zTree.init($("#tree"), setting, zNodes);
      // 展开所有的节点
      _this.tree.expandAll(true);
    },
    /**
     * ,点击【新增】
     */
    add() {
      let _this = this;
      _this.course = {};
      // 新增的时候，让所有的节点都不选中
      _this.tree.checkAllNodes(false);
      $("#form-modal").modal("show");
    },

    /**
     * 点击【编辑】
     */
    edit(course) {
      let _this = this;
      _this.course = $.extend({}, course);
      _this.listCategory(course.id);
      $("#form-modal").modal("show");
    },
    /**
     * 打开内容编辑器
     */
    editContent(course) {
      $("#course-content-modal").modal("show");
      let _this = this;
      let id = course.id;
      _this.course = course;
        $("#content").summernote({
          focus: true,
          height: 300
        });

      // 先清空历史文本
      $("#content").summernote("code", "");

      Loading.show();

      _this.$ajax
        .get(
          process.env.VUE_APP_SERVER +
            "/business/admin/course/find-content/" +
            id
        )
        .then((response) => {
          Loading.hide();
          let resp = response.data;

          if (resp.success) {
            $("course-content-modal").modal({
              backdrop: "static",
              keyboard: false,
            });

            if (resp.content) {
              $("#content").summernote("code", resp.content.content);
            }
          } else {
            Toast.warning(resp.message);
          }
        });
    },

    /**
     * 保存内容
     */
    saveContent() {
      let _this = this;
      let content = $("#content").summernote("code");
      Loading.show();
      _this.$ajax
        .post(
          process.env.VUE_APP_SERVER + "/business/admin/course/save-content",
          {
            id: _this.course.id,
            content: content,
          }
        )
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          if (resp.success) {
            Toast.success("内容保存成功");
          } else {
            Toast.warning(resp.message);
          }
        });
    },
    /**
     * 点击【大章】
     */
    toChapter(course) {
      let _this = this;
      SessionStorage.set("course", course);
      _this.$router.push("/business/chapter");
    },

    /**
     * 查找课程下所有分类
     * @param courseId
     */
    listCategory(courseId) {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(
          process.env.VUE_APP_SERVER +
            "/business/admin/course/list-category/" +
            courseId
        )
        .then((res) => {
          Loading.hide();
          console.log("查找课程下所有分类结果：", res);
          let response = res.data;
          let categorys = response.content;

          // 勾选查询到的分类
          _this.tree.checkAllNodes(false);
          for (let i = 0; i < categorys.length; i++) {
            let node = _this.tree.getNodeByParam("id", categorys[i].categoryId);
            _this.tree.checkNode(node, true);
          }
        });
    },

    /**
     * 列表查询
     */
    list(page) {
      let _this = this;
      Loading.show();
      _this.$ajax
        .post(process.env.VUE_APP_SERVER + "/business/admin/course/list", {
          page: page,
          size: _this.$refs.pagination.size,
        })
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          _this.courses = resp.content.list;
          _this.$refs.pagination.render(page, resp.content.total);
        });
    },

    /**
     * 点击【保存】
     */
    save() {
      let _this = this;

      // 保存校验
      if (
        1 != 1 ||
        !Validator.require(_this.course.name, "名称") ||
        !Validator.length(_this.course.name, "名称", 1, 50) ||
        !Validator.length(_this.course.summary, "概述", 1, 2000) ||
        !Validator.length(_this.course.image, "封面", 1, 100)
      ) {
        return;
      }

      let categorys = _this.tree.getCheckedNodes();
      if (Tool.isEmpty(categorys)) {
        Toast.warning("请选择分类!");
        return;
      }
      _this.course.categorys = categorys;

      Loading.show();
      _this.$ajax
        .post(
          process.env.VUE_APP_SERVER + "/business/admin/course/save",
          _this.course
        )
        .then((response) => {
          Loading.hide();
          let resp = response.data;
          if (resp.success) {
            $("#form-modal").modal("hide");
            _this.list(1);
            Toast.success("保存成功！");
          } else {
            Toast.warning(resp.message);
          }
        });
    },

    /**
     * 点击【删除】
     */
    del(id) {
      let _this = this;
      Confirm.show("删除课程后不可恢复，确认删除？", function () {
        Loading.show();
        _this.$ajax
          .delete(
            process.env.VUE_APP_SERVER + "/business/admin/course/delete/" + id
          )
          .then((response) => {
            Loading.hide();
            let resp = response.data;
            if (resp.success) {
              _this.list(1);
              Toast.success("删除成功！");
            }
          });
      });
    },
  },
};
</script>

<style scoped>
.caption h3 {
  font-size: 30px;
}
</style>
```





有个bug改一下

CourseService

```
@Transactional
public void save(CourseDto courseDto){
    Course course = CopyUtil.copy(courseDto, Course.class);
    if(StringUtils.isEmpty(courseDto.getId())){
        this.insert(course);
    } else {
        this.update(course);
    }

    // 批量保存课程分类
    courseCategoryService.saveBatch(course.getId(), courseDto.getCategorys());

}
```



## 利用setInterval完成自动保存功能



