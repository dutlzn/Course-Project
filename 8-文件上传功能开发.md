---
typora-root-url: /images
---

# 文件上传功能开发

# 完成基本的文件上传功能

## 搭建单独文件模块file

com.lzn.file.config

启动类

```
package com.lzn.file.config;


import org.mybatis.spring.annotation.MapperScan;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.core.env.Environment;

@SpringBootApplication
@EnableEurekaClient // 注册到注册中心
@MapperScan("com.lzn.mapper")
@ComponentScan("com.lzn")
public class FileApplication {
    private static final Logger LOG = LoggerFactory.getLogger(FileApplication.class);

    public static void main(String[] args) {
        SpringApplication app = new SpringApplication(FileApplication.class);
        Environment environment = app.run(args).getEnvironment();
        LOG.info("启动成功！！");
        LOG.info("File地址: \thttp://127.0.0.1:{}", environment.getProperty("server.port"));
    }
}

```

file pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>course</artifactId>
        <groupId>com.lzn</groupId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>file</artifactId>
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!-- 集成mybatis -->
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>

        <dependency>
            <groupId>com.lzn</groupId>
            <artifactId>server</artifactId>
        </dependency>
        <dependency>
            <groupId>com.lzn</groupId>
            <artifactId>server</artifactId>
        </dependency>


    </dependencies>


</project>
```

复制system resource 下面的两个文件到file模块里

```
# 系统名称
spring.application.name=file
# 系统路径
server.servlet.context-path=/file
# 系统端口
server.port=9003
# 注册中心
eureka.client.service-url.defaultZone=http://localhost:8761/eureka/
```





修改logback.xml中的路径





修改gateway 配置文件

```
# 应用名字
spring.application.name=gateway
# 启动端口
server.port=9000
eureka.client.service-url.defaultZone=http://localhost:8761/eureka/

# 路由转发配置
spring.cloud.gateway.routes[0].id=system
spring.cloud.gateway.routes[0].uri=http://127.0.0.1:9001
spring.cloud.gateway.routes[0].predicates[0].name=Path
spring.cloud.gateway.routes[0].predicates[0].args[0]=/system/**


spring.cloud.gateway.routes[1].id=business
#spring.cloud.gateway.routes[1].uri=http://127.0.0.1:9002
spring.cloud.gateway.routes[1].uri=lb://business
spring.cloud.gateway.routes[1].predicates[0].name=Path
spring.cloud.gateway.routes[1].predicates[0].args[0]=/business/**

spring.cloud.gateway.routes[2].id=file
spring.cloud.gateway.routes[2].uri=lb://file
spring.cloud.gateway.routes[2].predicates[0].name=Path
spring.cloud.gateway.routes[2].predicates[0].args[0]=/file/**
```





## springboot + vue文件上传功能

type = "file" 文件上传控件

触发文件上传动作方法一： 在文件上传组件上增加change事件

teacher.vue

```vue
<template>
	<div>
		<p>
			<button v-on:click="add()" class="btn btn-white btn-default btn-round">
				<i class="ace-icon fa fa-edit"></i>
				新增
			</button>
			&nbsp;
			<button v-on:click="list(1)" class="btn btn-white btn-default btn-round">
				<i class="ace-icon fa fa-refresh"></i>
				刷新
			</button>
		</p>

		<pagination ref="pagination" v-bind:list="list" v-bind:itemCount="8"></pagination>


		<div class="row">
			<div v-for="teacher in teachers" class="col-md-3">
				<div class="center">
					<span class="profile-picture">
						<img v-show="!teacher.image" class="editable img-responsive editable-click editable-empty" src="/static/image/profile-pic.jpg"
						 v-bind:title="teacher.intro" />
						<img v-show="teacher.image" class="editable img-responsive editable-click editable-empty" v-bind:src="teacher.image"
						 v-bind:title="teacher.intro" />
					</span>

					<div class="space-4"></div>

					<div class="width-85 label label-info label-xlg arrowed-in arrowed-in-right">
						<div class="inline position-relative">
							<a href="javascript:;" class="user-title-label dropdown-toggle" data-toggle="dropdown">
								<i class="ace-icon fa fa-circle light-green"></i>
								&nbsp;
								<span class="white">{{teacher.position}}</span>
							</a>
						</div>
					</div>
				</div>

				<div class="space-6"></div>

				<div class="text-center">
					<a href="javascript:;" class="text-info bigger-110" v-bind:title="teacher.motto">
						<i class="ace-icon fa fa-user"></i>
						{{teacher.name}}【{{teacher.nickname}}】
					</a>
				</div>

				<div class="space-6"></div>

				<div class="profile-social-links align-center">
					<button v-on:click="edit(teacher)" class="btn btn-xs btn-info">
						<i class="ace-icon fa fa-pencil bigger-120"></i>
					</button>
					&nbsp;
					<button v-on:click="del(teacher.id)" class="btn btn-xs btn-danger">
						<i class="ace-icon fa fa-trash-o bigger-120"></i>
					</button>
				</div>

				<div class="hr hr16 dotted"></div>

			</div>
		</div>

		<div id="form-modal" class="modal fade" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">表单</h4>
					</div>
					<div class="modal-body">
						<form class="form-horizontal">
							<div class="form-group">
								<label class="col-sm-2 control-label">姓名</label>
								<div class="col-sm-10">
									<input v-model="teacher.name" class="form-control">
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-2 control-label">昵称</label>
								<div class="col-sm-10">
									<input v-model="teacher.nickname" class="form-control">
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-2 control-label">头像</label>
								<div class="col-sm-10">
									<input id="file-upload-input" type="file" v-on:change="uploadImage()">
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-2 control-label">职位</label>
								<div class="col-sm-10">
									<input v-model="teacher.position" class="form-control">
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-2 control-label">座右铭</label>
								<div class="col-sm-10">
									<input v-model="teacher.motto" class="form-control">
								</div>
							</div>
							<div class="form-group">
								<label class="col-sm-2 control-label">简介</label>
								<div class="col-sm-10">
									<textarea v-model="teacher.intro" class="form-control" rows="5"> </textarea>
								</div>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
						<button v-on:click="save()" type="button" class="btn btn-primary">保存</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
	</div>
</template>

<script>
	import Pagination from "../../components/pagination";
	export default {
		components: {
			Pagination
		},
		name: "business-teacher",
		data: function() {
			return {
				teacher: {},
				teachers: [],
			}
		},
		mounted: function() {
			let _this = this;
			_this.$refs.pagination.size = 5;
			_this.list(1);
			// sidebar激活样式方法一
			// this.$parent.activeSidebar("business-teacher-sidebar");

		},
		methods: {
			/**
			 * 点击【新增】
			 */
			add() {
				let _this = this;
				_this.teacher = {};
				$("#form-modal").modal("show");
			},

			/**
			 * 点击【编辑】
			 */
			edit(teacher) {
				let _this = this;
				_this.teacher = $.extend({}, teacher);
				$("#form-modal").modal("show");
			},

			/**
			 * 列表查询
			 */
			list(page) {
				let _this = this;
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/business/admin/teacher/list', {
					page: page,
					size: _this.$refs.pagination.size,
				}).then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.teachers = resp.content.list;
					_this.$refs.pagination.render(page, resp.content.total);

				})
			},

			/**
			 * 点击【保存】
			 */
			save() {
				let _this = this;

				// 保存校验
				if (1 != 1 ||
					!Validator.require(_this.teacher.name, "姓名") ||
					!Validator.length(_this.teacher.name, "姓名", 1, 50) ||
					!Validator.length(_this.teacher.nickname, "昵称", 1, 50) ||
					!Validator.length(_this.teacher.image, "头像", 1, 100) ||
					!Validator.length(_this.teacher.position, "职位", 1, 50) ||
					!Validator.length(_this.teacher.motto, "座右铭", 1, 50) ||
					!Validator.length(_this.teacher.intro, "简介", 1, 500)
				) {
					return;
				}

				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/business/admin/teacher/save', _this.teacher).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						$("#form-modal").modal("hide");
						_this.list(1);
						Toast.success("保存成功！");
					} else {
						Toast.warning(resp.message)
					}
				})
			},

			/**
			 * 点击【删除】
			 */
			del(id) {
				let _this = this;
				Confirm.show("删除讲师后不可恢复，确认删除？", function() {
					Loading.show();
					_this.$ajax.delete(process.env.VUE_APP_SERVER + '/business/admin/teacher/delete/' + id).then((response) => {
						Loading.hide();
						let resp = response.data;
						if (resp.success) {
							_this.list(1);
							Toast.success("删除成功！");
						}
					})
				});
			},
			
			
			uploadImage() {
				let _this = this;
				let formData = new window.FormData();
				// key: "file"必须和后端controller参数名一样
				formData.append('file', document.querySelector('#file-upload-input').files[0]);
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/file/admin/upload', formData).then((response) => {
					Loading.hide();
					let resp = response.data;
				})
			}
		}
	}
</script>

```

后端

file controller admin

```java
package com.lzn.file.controller.admin;


import com.lzn.dto.ResponseDto;
import com.lzn.util.UuidUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.IOException;


@RequestMapping("/admin")
@RestController
public class UploadController {

    private static final Logger LOG = LoggerFactory.getLogger(
            UploadController.class
    );


    public static final String BUSINESS_NAME = "文件上传";


    @RequestMapping("/upload")
    public ResponseDto upload(
            @RequestParam MultipartFile file
            ) throws IOException {
//        debug


        LOG.info("上传文件开始:{}", file);
        LOG.info(file.getOriginalFilename());
        LOG.info(String.valueOf(file.getSize()));

        // 保存文件到本地
        String fileName=  file.getOriginalFilename();
        String key = UuidUtil.getShortUuid();
        String fullPath = "D:/code/file/teacher/" + key +"-" + fileName;
        File dest = new File(fullPath);// 生成目标位置
        file.transferTo(dest);// 写道目标位置
        LOG.info(dest.getAbsolutePath());

        ResponseDto responseDto = new ResponseDto();
        return responseDto;
    }
}

```



# 讲师头像的保存和显示

## 文件访问配置

springboot 静态资源的配置，静态自愿包含图片、css、js等

file config 



```
package com.lzn.file.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class SpringMvcConfig implements WebMvcConfigurer {
//
//    @Value("${file.path}")
//    private String FILE_PATH;

    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/f/**").addResourceLocations("file:D:/code/file/teacher/");
    }
    // http:127.0.0.1:9003/file/f/teacher/XPEC7kSP-头像1.jpg
}
```

浏览器可以直接访问到图片

http://127.0.0.1:9000/file/teacher/njSFOZ5M-%E5%A4%B4%E5%83%8F2.jpg





测试路由转发到file是否生效，

测试的时候要注意浏览器是有静态资源缓存的，可以用ctrl+f5强制刷新，

也可以用chrome 无痕浏览来测试，不会有缓存





这里测试打开不来于是开始学习，如何进行文件访问配置

https://blog.csdn.net/shuaigg001/article/details/94433969

https://www.cnblogs.com/java-synchronized/p/7091723.html





## 修改BUG

uploadController



```
package com.lzn.file.controller.admin;


import com.lzn.dto.ResponseDto;
import com.lzn.util.UuidUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.IOException;


@RequestMapping("/admin")
@RestController
public class UploadController {

    private static final Logger LOG = LoggerFactory.getLogger(
            UploadController.class
    );


    public static final String BUSINESS_NAME = "文件上传";


    @RequestMapping("/upload")
    public ResponseDto upload(
            @RequestParam MultipartFile file
            ) throws IOException {
//        debug


        LOG.info("上传文件开始:{}", file);
        LOG.info(file.getOriginalFilename());
        LOG.info(String.valueOf(file.getSize()));

        // 保存文件到本地
        String fileName=  file.getOriginalFilename();
        String key = UuidUtil.getShortUuid();
        String fullPath = "D:/code/file/teacher/" + key +"-" + fileName;
        File dest = new File(fullPath);// 生成目标位置
        file.transferTo(dest);// 写道目标位置
        LOG.info(dest.getAbsolutePath());

        ResponseDto responseDto = new ResponseDto();
        return responseDto;
    }
}
```



config配置

```
package com.lzn.file.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.EnableWebMvc;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

//@Configuration
//@EnableWebMvc
//public class SpringMvcConfig implements WebMvcConfigurer {
//    @Override
//    public void addResourceHandlers(ResourceHandlerRegistry registry) {
//        registry.addResourceHandler("/f/**")
//                .addResourceLocations("file:D:/code/file/teacher/");
//
//    }
//}


@Configuration
public  class SpringMvcConfig extends WebMvcConfigurationSupport {
    @Override
    protected void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/f/**")
                .addResourceLocations("file:D:/code/file/teacher/");

        super.addResourceHandlers(registry);
    }
}
```

http://127.0.0.1:9003/file/f/hc7gLRQ2-%E5%A4%B4%E5%83%8F1.jpg

为什么f 后面不能跟teacher

```
package com.lzn.file.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.EnableWebMvc;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

//@Configuration
//@EnableWebMvc
//public class SpringMvcConfig implements WebMvcConfigurer {
//    @Override
//    public void addResourceHandlers(ResourceHandlerRegistry registry) {
//        registry.addResourceHandler("/f/**")
//                .addResourceLocations("file:D:/code/file/teacher/");
//
//    }
//}


@Configuration
public  class SpringMvcConfig extends WebMvcConfigurationSupport {
    @Override
    protected void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/f/teacher/**")
                .addResourceLocations("file:D:/code/file/teacher/");

        super.addResourceHandlers(registry);
    }
}
```

改成这样http://127.0.0.1:9003/file/f/teacher/hc7gLRQ2-%E5%A4%B4%E5%83%8F1.jpg 就可以访问了

