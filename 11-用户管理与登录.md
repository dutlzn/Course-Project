# 用户管理与登录

# 增加用户管理功能

## 用户表设计与基本代码生成

### 数据库

```sql
drop table if exists `user`;
create table `user` (
  `id` char(8) not null default '' comment 'id',
  `login_name` varchar(50) not null comment '登陆名',
  `name` varchar(50) comment '昵称',
  `password` char(32) not null comment '密码',
  primary key (`id`),
  unique key `login_name_unique` (`login_name`)
) engine=innodb default charset=utf8mb4 comment='用户';

# 初始test/test
insert into `user` (id, login_name, name, password) values ('10000000', 'test', '测试', 'e70e2222a9d67c4f2eae107533359aa4');

```



mybatis生成器



运行

```
package com.lzn.generator.server;

import com.lzn.generator.util.DbUtil;
import com.lzn.generator.util.Field;
import com.lzn.generator.util.FreemarkerUtil;
import freemarker.template.TemplateException;
import org.omg.CORBA.FREE_MEM;
import org.dom4j.Document;
import org.dom4j.Element;
import org.dom4j.io.SAXReader;

import java.io.File;
import java.util.*;
import java.util.*;

import java.io.IOException;

public class ServerGenerator {
    static String MODULE = "system";
    static String toServicePath = "server\\src\\main\\java\\com\\lzn\\service\\";
    static String toControllerPath = MODULE + "\\src\\main\\java\\com\\lzn\\"+MODULE+"\\controller\\admin\\";
    static String toDtoPath = "server\\src\\main\\java\\com\\lzn\\dto\\";
    static String generatorConfigPath = "server\\src\\main\\resources\\generator\\generatorConfig.xml";

    public static void main(String[] args) throws Exception {
// 只生成配置文件中的第一个table节点
        String module = MODULE;
        File file = new File(generatorConfigPath);
        SAXReader reader=new SAXReader();
        //读取xml文件到Document中
        Document doc=reader.read(file);
        //获取xml文件的根节点
        Element rootElement=doc.getRootElement();
        //读取context节点
        Element contextElement = rootElement.element("context");
        //定义一个Element用于遍历
        Element tableElement;
        //取第一个“table”的节点
        tableElement=contextElement.elementIterator("table").next();
        String Domain = tableElement.attributeValue("domainObjectName");
        String tableName = tableElement.attributeValue("tableName");
        String tableNameCn = DbUtil.getTableComment(tableName);
        String domain = Domain.substring(0, 1).toLowerCase() + Domain.substring(1);
        System.out.println("表："+tableElement.attributeValue("tableName"));
        System.out.println("Domain："+tableElement.attributeValue("domainObjectName"));
        List<Field> fieldList = DbUtil.getColumnByTableName(tableName); // domain
        Set<String> typeSet = getJavaTypes(fieldList);

        Map<String, Object> map = new HashMap<>();

        map.put("Domain", Domain);
        map.put("domain", domain);
        map.put("tableNameCn", tableNameCn);
        map.put("module", MODULE);

        map.put("fieldList", fieldList);
        map.put("typeSet", typeSet);

//        // 生成dto
        FreemarkerUtil.initConfig("dto.ftl");
        FreemarkerUtil.generator(toDtoPath + Domain + "Dto.java", map);

        // 生成service
        FreemarkerUtil.initConfig("service.ftl");
        FreemarkerUtil.generator(toServicePath + Domain + "Service.java" ,
                map);
        // 生成controller
        FreemarkerUtil.initConfig("controller.ftl");
        FreemarkerUtil.generator(toControllerPath + Domain + "Controller.java" ,
                map);



    }

    private static Set<String> getJavaTypes(List<Field> fieldList) {
        Set<String> set = new HashSet<>();
        for (int i = 0; i < fieldList.size(); i++) {
            Field field = fieldList.get(i);
            set.add(field.getJavaType());
        }
        return set;
    }
}
```



system 新建 system  controller admin包



前端生成器

```java
package com.lzn.generator.vue;

import com.lzn.generator.util.DbUtil;
import com.lzn.generator.util.Field;
import com.lzn.generator.util.FreemarkerUtil;
import org.dom4j.Document;
import org.dom4j.Element;
import org.dom4j.io.SAXReader;

import java.io.File;
import java.util.*;

public class VueGenerator {
    static String MODULE = "system";
    static String toVuePath = "D:\\code\\course-project\\course-admin\\src\\views\\admin\\";
    static String generatorConfigPath = "server\\src\\main\\resources\\generator\\generatorConfig.xml";

    public static void main(String[] args) throws Exception {
        String module = MODULE;

        // 只生成配置文件中的第一个table节点
        File file = new File(generatorConfigPath);
        SAXReader reader=new SAXReader();
        //读取xml文件到Document中
        Document doc=reader.read(file);
        //获取xml文件的根节点
        Element rootElement=doc.getRootElement();
        //读取context节点
        Element contextElement = rootElement.element("context");
        //定义一个Element用于遍历
        Element tableElement;
        //取第一个“table”的节点
        tableElement=contextElement.elementIterator("table").next();
        String Domain = tableElement.attributeValue("domainObjectName");
        String tableName = tableElement.attributeValue("tableName");
        String tableNameCn = DbUtil.getTableComment(tableName);
        String domain = Domain.substring(0, 1).toLowerCase() + Domain.substring(1);
        System.out.println("表："+tableElement.attributeValue("tableName"));
        System.out.println("Domain："+tableElement.attributeValue("domainObjectName"));

        List<Field> fieldList = DbUtil.getColumnByTableName(tableName);
        Set<String> typeSet = getJavaTypes(fieldList);
        Map<String, Object> map = new HashMap<>();
        map.put("Domain", Domain);
        map.put("domain", domain);
        map.put("tableNameCn", tableNameCn);
        map.put("module", module);
        map.put("fieldList", fieldList);
        map.put("typeSet", typeSet);

        // 生成vue
        FreemarkerUtil.initConfig("vue2.ftl");
        FreemarkerUtil.generator(toVuePath + domain + ".vue", map);
    }

    /**
     * 获取所有的Java类型，使用Set去重
     */
    private static Set<String> getJavaTypes(List<Field> fieldList) {
        Set<String> set = new HashSet<>();
        for (int i = 0; i < fieldList.size(); i++) {
            Field field = fieldList.get(i);
            set.add(field.getJavaType());
        }
        return set;
    }
}

```



narbar.vue

```vue
<template>
	<nav>
		<v-app-bar app color="#438EB9">

			<v-app-bar-nav-icon @click="drawer = !drawer"></v-app-bar-nav-icon>

			<v-toolbar-title class="text-uppercase">
				<span class="font-weight-bold">在线视频</span>
				<span>系统</span>
			</v-toolbar-title>

			<!-- text 透明度设置， color 改变按钮内部文字颜色 -->
			<!-- 尽可能多的占用空间 grid -->
			<v-spacer></v-spacer>
			<v-menu offset-y>
				<template v-slot:activator="{ on, attrs }">
					<v-btn text v-bind="attrs" v-on="on" class="font-weight-bold">
						菜单
					</v-btn>
				</template>

				<!-- 			<v-list>
					<v-list-item v-for="(item, i) in links" :key="i" :to="item.route" active-class="border">
						<v-list-item-title>{{item.text}}</v-list-item-title>
					</v-list-item>
				</v-list> -->
			</v-menu>

			<v-btn text>
				<span  class="font-weight-bold">退出</span>
				<v-icon>exit_to_app</v-icon>
			</v-btn>
		</v-app-bar>

		<v-navigation-drawer v-model="drawer" app  color="#F8F8F8">
			<!-- 对应了菜单先写死 -->
			<v-list>
				
				<v-list-group :value="true" prepend-icon="person" color="blue" no-action="">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>系统管理</v-list-item-title>
						</v-list-item-content>
					</template>
				
					<v-list-item to="/system/user">
						<v-list-item-content>
							<v-list-item-title>用户管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>
				
				</v-list-group>
				
				
				<v-list-group :value="true" prepend-icon="apps" color="blue" no-action="">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>业务管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/business/course">
						<v-list-item-content>
							<v-list-item-title>课程管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/business/teacher">
						<v-list-item-content>
							<v-list-item-title>讲师管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/business/category">
							<v-list-item-content>
								<v-list-item-title>分类管理</v-list-item-title>
							</v-list-item-content>
					</v-list-item>

				</v-list-group>
				
				
				<v-list-group :value="true" prepend-icon="folder" color="blue" no-action="">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>文件管理</v-list-item-title>
						</v-list-item-content>
					</template>
				
					<v-list-item to="/file/file">
						<v-list-item-content>
							<v-list-item-title>文件管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>
				
				</v-list-group>
				
				
				
				
			</v-list>

		</v-navigation-drawer>
	</nav>
</template>

<script>
	export default {
		data() {
			return {
				drawer: true,
				link: '/welcome',
			}
		}
	}
</script>

<style scoped>
</style>

```



路由

```js
import Vue from 'vue'
// import VueRouter from 'vue-router'
import Router from 'vue-router'
// 导入组件
import Login from '../views/login.vue'
import Admin from '../views/admin.vue'
import Welcome from '../views/admin/welcome.vue'
import Category from '../views/admin/category.vue'
import Teacher from '../views/admin/teacher.vue'
import Course from '../views/admin/course.vue'
import Chapter from '../views/admin/chapter.vue'
import Section from '../views/admin/section.vue'
import File from '../views/admin/file.vue'
import User from '../views/admin/user'
// Vue.use(VueRouter);
Vue.use(Router);

// const routes = [
	
// ]

// const router = new VueRouter({
//   mode: 'history',
//   base: process.env.BASE_URL,
//   routes
// })

// export default router
export default new Router(
    {
        mode: 'history', // history hash 推荐使用history hash 的话前面由前缀，url形式不美观，history推荐使用，路由前面只有以恶搞#
        base: process.env.BASE_URL,
        routes: [{
            path: '*',
            redirect: "/login",
        }, {
            path: "/login",
            component: Login
        }, {
            path: "/",
            name: "admin", 
            // name属性后面会用到
            component: Admin,
            children: [{
                path: 'welcome',
                name: 'welcome',
                component: Welcome
            }, {
                path: 'business/category',
                name: 'business/category',
                component: Category
            }, {
							path: 'business/teacher',
							name: 'business/teacher',
							component: Teacher
						}, {
							path: 'business/course',
							name: 'business/course',
							component: Course
						}, {
							path: 'business/chapter',
							name: 'business/chapter',
							component: Chapter
						}, {
							path: 'business/section',
							name: 'business/section',
							component: Section
						}, {
							path: 'file/file',
							name: 'file/file',
							component: File
						}, {
							path: 'system/user',
							name: 'system/user',
							component: User
						}]
        }],
				
				ScrollBehavior(to ,from, savedPosition) {
					return {x: 0, y:0};
				}
    }

)
```





## 增加用户名是否已经存在校验

登录名是不可以被编辑的，可能是个关联表

在校验不通过的时候，使用自定义异常



自定义异常

继承RuntimeException的一个好处就是代码不需要捕获



server exception

```
package com.lzn.exception;

public enum BusinessExceptionCode {

    MEMBER_NOT_EXIST("会员不存在"),
    USER_LOGIN_NAME_EXIST("登录名已存在"),
    LOGIN_USER_ERROR("用户名不存在或密码错误"),
    LOGIN_MEMBER_ERROR("手机号不存在或密码错误"),
    MOBILE_CODE_TOO_FREQUENT("短信请求过于频繁"),
    MOBILE_CODE_ERROR("短信验证码不正确"),
    MOBILE_CODE_EXPIRED("短信验证码不存在或已过期，请重新发送短信"),
    ;

    private String desc;

    BusinessExceptionCode(String desc) {
        this.desc = desc;
    }

    public String getDesc() {
        return desc;
    }

    public void setDesc(String desc) {
        this.desc = desc;
    }
}
```



```
package com.lzn.exception;

public class BusinessException extends RuntimeException{

    private BusinessExceptionCode code;

    public BusinessException (BusinessExceptionCode code) {
        super(code.getDesc());
        this.code = code;
    }

    public BusinessExceptionCode getCode() {
        return code;
    }

    public void setCode(BusinessExceptionCode code) {
        this.code = code;
    }

    /**
     * 不写入堆栈信息，提高性能
     */
    @Override
    public Throwable fillInStackTrace() {
        return this;
    }
}
```







抛出异常时候，不打印异常信息，一方面是提高性能，另一方面是没有业务异常没有必要打印堆栈





server

```
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.User;
import com.lzn.domain.UserExample;
import com.lzn.domain.Test;
import com.lzn.domain.TestExample;
import com.lzn.dto.UserDto;
import com.lzn.dto.PageDto;
import com.lzn.exception.BusinessException;
import com.lzn.exception.BusinessExceptionCode;
import com.lzn.mapper.UserMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.CollectionUtils;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;


@Service
public class UserService {

    @Autowired
    private UserMapper userMapper;


    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        UserExample userExample = new UserExample();


        List<User> userList = userMapper.selectByExample(userExample);

        PageInfo<User> pageInfo = new PageInfo<>(userList);
        pageDto.setTotal(pageInfo.getTotal());

        List<UserDto> userDtoList = new ArrayList<>();

        for(int i = 0;i<userList.size();++i){
            User user = userList.get(i);
            UserDto userDto = new UserDto();
            BeanUtils.copyProperties(user, userDto);
            userDtoList.add(userDto);
        }
        pageDto.setList(userDtoList);

    }

    public void save(UserDto userDto){
        User user = CopyUtil.copy(userDto, User.class);
        if(StringUtils.isEmpty(userDto.getId())){
            this.insert(user);
        } else {
            this.update(user);
        }
    }

    /**
     * 新增
     */
    private void insert(User user) {
        user.setId(UuidUtil.getShortUuid());
        User userDb = this.selectByLoginName(user.getLoginName());
        if (userDb != null) {
            throw new BusinessException(BusinessExceptionCode.USER_LOGIN_NAME_EXIST);
        }
        userMapper.insert(user);
    }



    private void update(User user){
        userMapper.updateByPrimaryKey(user);
    }

    public void delete(String id) {
        userMapper.deleteByPrimaryKey(id);
    }

    /**
     * 根据登录名查询用户信息
     * @param loginName
     * @return
     */
    public User selectByLoginName(String loginName) {
        UserExample userExample = new UserExample();
        userExample.createCriteria().andLoginNameEqualTo(loginName);
        List<User> userList = userMapper.selectByExample(userExample);
        if (CollectionUtils.isEmpty(userList)) {
            return null;
        } else {
            return userList.get(0);
        }
    }
}
```





全局捕获

system controller 

```
package com.lzn.system.controller;

import com.lzn.dto.ResponseDto;
import com.lzn.exception.BusinessException;
import com.lzn.exception.ValidatorException;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;

/**
 * 统一控制层异常处理器
 */
@ControllerAdvice
public class ControllerException {

    @ExceptionHandler(value = BusinessException.class)
    @ResponseBody
    public ResponseDto businessExceptionHandle(BusinessException e) {
        ResponseDto responseDto = new ResponseDto();
        responseDto.setSuccess(false);
        responseDto.setMessage(e.getCode().getDesc());
        return responseDto;
    }
}

```





user.vue

```vue
<!-- 小节页面 -->
<template>
	<v-app class="ma-3" app>
		<v-dialog v-model="dialog" persistent max-width="300">
			<v-card>
				<v-card-title>
					表单
				</v-card-title>

				<v-card-text>
					 	<v-col cols="12">
							<v-text-field label="登陆名" v-if="user.id" disabled v-model="user.loginName"></v-text-field>
											<v-text-field label="登陆名" v-if="!user.id"  v-model="user.loginName"></v-text-field>
						</v-col>
						<v-col cols="12">
							<v-text-field label="昵称" v-model="user.name" required></v-text-field>
						</v-col>
						<v-col cols="12">
							<v-text-field label="密码" v-model="user.password" required></v-text-field>
						</v-col>
				</v-card-text>
				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialog = false" clas="info">
						取消
					</v-btn>

					<v-btn @click="save()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>


		<p class="ma-10">

			<v-btn class="mr-5 mb-5" color="primary" @click="add()">
				<v-icon left small>add</v-icon>
				新增
			</v-btn>

			<v-btn class="mb-5" color="primary" @click="list(1)">
				<v-icon left small>refresh</v-icon>
				刷新
			</v-btn>

		</p>


		<pagination ref="pagination" v-bind:list="list" v-bind:itemCount="5"></pagination>


		<v-container>
			<v-row>
				<v-col cols="12">
					<v-simple-table>
						<thead>
							<tr>
										<th class="primary--text text-h6 text-center">id</th>
										<th class="primary--text text-h6 text-center">登陆名</th>
										<th class="primary--text text-h6 text-center">昵称</th>
										<th class="primary--text text-h6 text-center">密码</th>
								<th class="primary--text  text-h6 text-center">
									操作
								</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="user in users" class="text-center">

												<td>{{user.id}}</td>
												<td>{{user.loginName}}</td>
												<td>{{user.name}}</td>
												<td>{{user.password}}</td>

								<td>
									<v-row align="center" justify="space-around">
										<v-btn x-small fab @click="edit(user)" class="primary">
											<v-icon>edit</v-icon>
										</v-btn>

										<v-btn x-small fab @click="del(user.id)" class="warning">
											<v-icon>delete</v-icon>
										</v-btn>
									</v-row>
								</td>
							</tr>
						</tbody>
					</v-simple-table>
				</v-col>
			</v-row>
		</v-container>

	</v-app>
</template>

<script>
	import Pagination from "../../components/pagination.vue";
	export default {
		name: "system-user",
		components: {
			Pagination
		},

		data: function() {
			return {
	        user: {},
	        users: [],

					dialog: false,
			}
		},

	  mounted: function() {
			let _this = this;
			_this.$refs.pagination.size = 5;
			_this.list(1);

	  },

		methods: {
			// 获取所有小节的数据
			list(page) {
					let _this = this;
					Loading.show();
					_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/list', {
						page: page,
						size: _this.$refs.pagination.size,
					}).then((response)=>{
						Loading.hide();
						let resp = response.data;
						_this.users = resp.content.list;
						_this.$refs.pagination.render(page, resp.content.total);

					})
			},
			/**
			 * 新增小节
			 */
			add() {
        let _this = this;
        _this.user = {};
				_this.dialog = true;
			},

			/**
			 * 编辑小节
			 */
			edit(user) {
        let _this = this;
        _this.user = $.extend({}, user);
				_this.dialog = true;
      },

			/**
			 * 保存
			 */
			save() {
        let _this = this;

        // 保存校验
        if (1 != 1
          || !Validator.require(_this.user.loginName, "登陆名")
          || !Validator.length(_this.user.loginName, "登陆名", 1, 50)
          || !Validator.length(_this.user.name, "昵称", 1, 50)
          || !Validator.require(_this.user.password, "密码")
        ) {
          return;
        }

        Loading.show();
        _this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/save', _this.user).then((response)=>{
          Loading.hide();
          let resp = response.data;
          if (resp.success) {
            _this.dialog = false,
            _this.list(1);
            Toast.success("保存成功！");
          } else {
            Toast.warning(resp.message)
          }
        })
      },

			/**
			 * 删除小节
			 */
      del(id) {
        let _this = this;
        Confirm.show("删除用户后不可恢复，确认删除？", function () {
          Loading.show();
          _this.$ajax.delete(process.env.VUE_APP_SERVER + '/system/admin/user/delete/' + id).then((response)=>{
            Loading.hide();
            let resp = response.data;
            if (resp.success) {
              _this.list(1);
              Toast.success("删除成功！");
            }
          })
        });
      }
		}
	}
</script>

<style>
</style>

```







## 路由

```js
import Vue from 'vue'
// import VueRouter from 'vue-router'
import Router from 'vue-router'
// 导入组件
import Login from '../views/login.vue'
import Admin from '../views/admin.vue'
import Welcome from '../views/admin/welcome.vue'
import Category from '../views/admin/category.vue'
import Teacher from '../views/admin/teacher.vue'
import Course from '../views/admin/course.vue'
import Chapter from '../views/admin/chapter.vue'
import Section from '../views/admin/section.vue'
import File from '../views/admin/file.vue'
import User from '../views/admin/user'
// Vue.use(VueRouter);
Vue.use(Router);

// const routes = [
	
// ]

// const router = new VueRouter({
//   mode: 'history',
//   base: process.env.BASE_URL,
//   routes
// })

// export default router
export default new Router(
    {
        mode: 'history', // history hash 推荐使用history hash 的话前面由前缀，url形式不美观，history推荐使用，路由前面只有以恶搞#
        base: process.env.BASE_URL,
        routes: [{
            path: '*',
            redirect: "/login",
        }, {
            path: "",
            component: Login
        },{
						path: "/login",
						component: Login
				} ,{
            path: "/",
            name: "admin", 
            // name属性后面会用到
            component: Admin,
            children: [{
                path: 'welcome',
                name: 'welcome',
                component: Welcome
            }, {
                path: 'business/category',
                name: 'business/category',
                component: Category
            }, {
							path: 'business/teacher',
							name: 'business/teacher',
							component: Teacher
						}, {
							path: 'business/course',
							name: 'business/course',
							component: Course
						}, {
							path: 'business/chapter',
							name: 'business/chapter',
							component: Chapter
						}, {
							path: 'business/section',
							name: 'business/section',
							component: Section
						}, {
							path: 'file/file',
							name: 'file/file',
							component: File
						}, {
							path: 'system/user',
							name: 'system/user',
							component: User
						}]
        }],
				
				ScrollBehavior(to ,from, savedPosition) {
					return {x: 0, y:0};
				}
    }

)
```





# 密码的加密传输与加密存储



## 加密算法MD5与盐值



https://md5jiami.51240.com/



不能解密md5

网站的数据库里已经把原值和密码都算好并存储起来了，如果刚好你输入的密文在数据库里有，就能查出来

123_course

_course就是salt值，加上salt，密文不容易被破解

## 密码加密传输与加密加密

存成明文，至少程序员，可以直接到生产上看到所有人的密码

salt可以是随机的一串值，但是所欲用到salt的地方必须是同一个值，如果做平台系统，有多个客户用平台，最好是一个客户一个salt



保险方案就是两次加密

```
package com.lzn.system.controller.admin;

import com.lzn.dto.PageDto;
import com.lzn.dto.ResponseDto;
import com.lzn.dto.UserDto;
import com.lzn.service.UserService;
import com.lzn.util.ValidatorUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/admin/user")
public class UserController {

    public static final String BUSINESS_NAME = "用户";

    @Autowired
    private UserService userService;

    @PostMapping("/list")
    public ResponseDto list(@RequestBody PageDto pageDto) {
        ResponseDto responseDto = new ResponseDto();
        userService.list(pageDto);
        responseDto.setContent(pageDto);
        return responseDto;
    }
    @PostMapping("/save")
    public ResponseDto save(@RequestBody UserDto userDto){
        userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));
        // 保存校验
        ValidatorUtil.require(userDto.getLoginName(), "登陆名");
        ValidatorUtil.length(userDto.getLoginName(), "登陆名", 1, 50);
        ValidatorUtil.length(userDto.getName(), "昵称", 1, 50);
        ValidatorUtil.require(userDto.getPassword(), "密码");


        ResponseDto responseDto = new ResponseDto();
        userService.save(userDto);
        responseDto.setContent(userDto);
        return responseDto;
    }

    @DeleteMapping("/delete/{id}")
    public ResponseDto delete(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        userService.delete(id);
        return responseDto;
    }
}
```





user.vue

```vue
<!-- 小节页面 -->
<template>
	<v-app class="ma-3" app>
		<v-dialog v-model="dialog" persistent max-width="300">
			<v-card>
				<v-card-title>
					表单
				</v-card-title>

				<v-card-text>
					 	<v-col cols="12">
							<v-text-field label="登陆名" v-if="user.id" disabled v-model="user.loginName"></v-text-field>
											<v-text-field label="登陆名" v-if="!user.id"  v-model="user.loginName"></v-text-field>
						</v-col>
						<v-col cols="12">
							<v-text-field label="昵称" v-model="user.name" required></v-text-field>
						</v-col>
						<v-col cols="12">
							<v-text-field label="密码" v-model="user.password" required></v-text-field>
						</v-col>
				</v-card-text>
				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialog = false" clas="info">
						取消
					</v-btn>

					<v-btn @click="save()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>


		<p class="ma-10">

			<v-btn class="mr-5 mb-5" color="primary" @click="add()">
				<v-icon left small>add</v-icon>
				新增
			</v-btn>

			<v-btn class="mb-5" color="primary" @click="list(1)">
				<v-icon left small>refresh</v-icon>
				刷新
			</v-btn>

		</p>


		<pagination ref="pagination" v-bind:list="list" v-bind:itemCount="5"></pagination>


		<v-container>
			<v-row>
				<v-col cols="12">
					<v-simple-table>
						<thead>
							<tr>
										<th class="primary--text text-h6 text-center">id</th>
										<th class="primary--text text-h6 text-center">登陆名</th>
										<th class="primary--text text-h6 text-center">昵称</th>
										<th class="primary--text text-h6 text-center">密码</th>
								<th class="primary--text  text-h6 text-center">
									操作
								</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="user in users" class="text-center">

												<td>{{user.id}}</td>
												<td>{{user.loginName}}</td>
												<td>{{user.name}}</td>
												<td>{{user.password}}</td>

								<td>
									<v-row align="center" justify="space-around">
										<v-btn x-small fab @click="edit(user)" class="primary">
											<v-icon>edit</v-icon>
										</v-btn>

										<v-btn x-small fab @click="del(user.id)" class="warning">
											<v-icon>delete</v-icon>
										</v-btn>
									</v-row>
								</td>
							</tr>
						</tbody>
					</v-simple-table>
				</v-col>
			</v-row>
		</v-container>

	</v-app>
</template>

<script>
	import Pagination from "../../components/pagination.vue";
	export default {
		name: "system-user",
		components: {
			Pagination
		},

		data: function() {
			return {
	        user: {},
	        users: [],

					dialog: false,
			}
		},

	  mounted: function() {
			let _this = this;
			_this.$refs.pagination.size = 5;
			_this.list(1);

	  },

		methods: {
			// 获取所有小节的数据
			list(page) {
					let _this = this;
					Loading.show();
					_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/list', {
						page: page,
						size: _this.$refs.pagination.size,
					}).then((response)=>{
						Loading.hide();
						let resp = response.data;
						_this.users = resp.content.list;
						_this.$refs.pagination.render(page, resp.content.total);

					})
			},
			/**
			 * 新增小节
			 */
			add() {
        let _this = this;
        _this.user = {};
				_this.dialog = true;
			},

			/**
			 * 编辑小节
			 */
			edit(user) {
        let _this = this;
        _this.user = $.extend({}, user);
				_this.dialog = true;
      },

			/**
			 * 保存
			 */
			save() {
        let _this = this;

        // 保存校验
        if (1 != 1
          || !Validator.require(_this.user.loginName, "登陆名")
          || !Validator.length(_this.user.loginName, "登陆名", 1, 50)
          || !Validator.length(_this.user.name, "昵称", 1, 50)
          || !Validator.require(_this.user.password, "密码")
        ) {
          return;
        }
				
				_this.user.password = hex_md5(_this.user.password + KEY);
				
        Loading.show();
        _this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/save', _this.user).then((response)=>{
          Loading.hide();
          let resp = response.data;
          if (resp.success) {
            _this.dialog = false,
            _this.list(1);
            Toast.success("保存成功！");
          } else {
            Toast.warning(resp.message)
          }
        })
      },

			/**
			 * 删除小节
			 */
      del(id) {
        let _this = this;
        Confirm.show("删除用户后不可恢复，确认删除？", function () {
          Loading.show();
          _this.$ajax.delete(process.env.VUE_APP_SERVER + '/system/admin/user/delete/' + id).then((response)=>{
            Loading.hide();
            let resp = response.data;
            if (resp.success) {
              _this.list(1);
              Toast.success("删除成功！");
            }
          })
        });
      }
		}
	}
</script>

<style>
</style>

```





## 增加修改密码的功能

修改用户信息和修改密码应该分开，做成两个功能

user.vue

```vue
				<v-card-text>
					 	<v-col cols="12">
							<v-text-field label="登陆名" v-if="user.id" disabled v-model="user.loginName"></v-text-field>
							<v-text-field label="登陆名" v-if="!user.id"  v-model="user.loginName"></v-text-field>
						</v-col>
						<v-col cols="12">
							<v-text-field label="昵称" v-model="user.name" required></v-text-field>
						</v-col>
						<v-col cols="12">
							<v-text-field v-if="user.id" disabled label="密码" v-model="user.password" required></v-text-field>
							<v-text-field v-if="!user.id"  label="密码" v-model="user.password" required></v-text-field>
						</v-col>
				</v-card-text>
```





userServise

mybatis-generator生产的方法里，updateByPrimaryKeySelective会对字段进行非空判断，再更新，如果值为空，就不更新，原理就是利用mybatis的if拼成动态sql

```
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.User;
import com.lzn.domain.UserExample;
import com.lzn.domain.Test;
import com.lzn.domain.TestExample;
import com.lzn.dto.UserDto;
import com.lzn.dto.PageDto;
import com.lzn.exception.BusinessException;
import com.lzn.exception.BusinessExceptionCode;
import com.lzn.mapper.UserMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.CollectionUtils;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;


@Service
public class UserService {

    @Autowired
    private UserMapper userMapper;


    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        UserExample userExample = new UserExample();


        List<User> userList = userMapper.selectByExample(userExample);

        PageInfo<User> pageInfo = new PageInfo<>(userList);
        pageDto.setTotal(pageInfo.getTotal());

        List<UserDto> userDtoList = new ArrayList<>();

        for(int i = 0;i<userList.size();++i){
            User user = userList.get(i);
            UserDto userDto = new UserDto();
            BeanUtils.copyProperties(user, userDto);
            userDtoList.add(userDto);
        }
        pageDto.setList(userDtoList);

    }

    public void save(UserDto userDto){

        User user = CopyUtil.copy(userDto, User.class);
        if(StringUtils.isEmpty(userDto.getId())){
            this.insert(user);
        } else {
            this.update(user);
        }
    }

    /**
     * 新增
     */
    private void insert(User user) {
        user.setId(UuidUtil.getShortUuid());
        User userDb = this.selectByLoginName(user.getLoginName());
        if (userDb != null) {
            throw new BusinessException(BusinessExceptionCode.USER_LOGIN_NAME_EXIST);
        }
        userMapper.insert(user);
    }



    private void update(User user){
        user.setPassword(null);
        userMapper.updateByPrimaryKeySelective(user);
    }

    public void delete(String id) {
        userMapper.deleteByPrimaryKey(id);
    }

    /**
     * 根据登录名查询用户信息
     * @param loginName
     * @return
     */
    public User selectByLoginName(String loginName) {
        UserExample userExample = new UserExample();
        userExample.createCriteria().andLoginNameEqualTo(loginName);
        List<User> userList = userMapper.selectByExample(userExample);
        if (CollectionUtils.isEmpty(userList)) {
            return null;
        } else {
            return userList.get(0);
        }
    }
}
```







user.vue

```vue
<!-- 小节页面 -->
<template>
	<v-app class="ma-3" app>
		<v-dialog v-model="dialog" persistent max-width="300">
			<v-card>
				<v-card-title>
					表单
				</v-card-title>

				<v-card-text>
					<v-col cols="12">
						<v-text-field label="登陆名" v-if="user.id" disabled v-model="user.loginName"></v-text-field>
						<v-text-field label="登陆名" v-if="!user.id" v-model="user.loginName"></v-text-field>
					</v-col>
					<v-col cols="12">
						<v-text-field label="昵称" v-model="user.name" required></v-text-field>
					</v-col>
					<v-col cols="12">
						<v-text-field v-if="user.id" disabled label="密码" type="password" v-model="user.password"></v-text-field>
						<v-text-field v-if="!user.id" label="密码" type="password" v-model="user.password" required></v-text-field>
					</v-col>
				</v-card-text>
				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialog = false" clas="info">
						取消
					</v-btn>

					<v-btn @click="save()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>


		<v-dialog v-model="dialogPassword" persistent max-width="300">
			<v-card>
				<v-card-title>
					修改密码
				</v-card-title>

				<v-card-text>
					<v-col cols="12">
						<v-text-field label="密码" type="password" v-model="user.password" required></v-text-field>
					</v-col>
				</v-card-text>
				<v-card-actions>
					<v-spacer></v-spacer>
					<v-btn @click="dialogPassword = false" clas="info">
						取消
					</v-btn>

					<v-btn @click="savePassword()" class="success">
						保存
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-dialog>


		<p class="ma-10">

			<v-btn class="mr-5 mb-5" color="primary" @click="add()">
				<v-icon left small>add</v-icon>
				新增
			</v-btn>

			<v-btn class="mb-5" color="primary" @click="list(1)">
				<v-icon left small>refresh</v-icon>
				刷新
			</v-btn>

		</p>


		<pagination ref="pagination" v-bind:list="list" v-bind:itemCount="5"></pagination>


		<v-container>
			<v-row>
				<v-col cols="12">
					<v-simple-table>
						<thead>
							<tr>
								<th class="primary--text text-h6 text-center">id</th>
								<th class="primary--text text-h6 text-center">登陆名</th>
								<th class="primary--text text-h6 text-center">昵称</th>
								<th class="primary--text text-h6 text-center">密码</th>
								<th class="primary--text  text-h6 text-center">
									操作
								</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="user in users" class="text-center">

								<td>{{user.id}}</td>
								<td>{{user.loginName}}</td>
								<td>{{user.name}}</td>
								<td>{{user.password}}</td>

								<td>
									<v-row align="center" justify="space-around">
										<v-btn x-small fab @click="edit(user)" class="primary">
											<v-icon>edit</v-icon>
										</v-btn>
										<v-btn x-small fab @click="editPassword(user)" class="info">
											<v-icon>edit</v-icon>
										</v-btn>

										<v-btn x-small fab @click="del(user.id)" class="warning">
											<v-icon>delete</v-icon>
										</v-btn>
									</v-row>
								</td>
							</tr>
						</tbody>
					</v-simple-table>
				</v-col>
			</v-row>
		</v-container>

	</v-app>
</template>

<script>
	import Pagination from "../../components/pagination.vue";
	export default {
		name: "system-user",
		components: {
			Pagination
		},

		data: function() {
			return {
				user: {},
				users: [],

				dialog: false,
				dialogPassword: false,
			}
		},

		mounted: function() {
			let _this = this;
			_this.$refs.pagination.size = 5;
			_this.list(1);

		},

		methods: {
			// 获取所有小节的数据
			list(page) {
				let _this = this;
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/list', {
					page: page,
					size: _this.$refs.pagination.size,
				}).then((response) => {
					Loading.hide();
					let resp = response.data;
					_this.users = resp.content.list;
					_this.$refs.pagination.render(page, resp.content.total);

				})
			},
			/**
			 * 新增小节
			 */
			add() {
				let _this = this;
				_this.user = {};
				_this.dialog = true;
			},

			/**
			 * 编辑小节
			 */
			edit(user) {
				let _this = this;
				_this.user = $.extend({}, user);
				_this.dialog = true;
			},

			/**
			 * 保存
			 */
			save() {
				let _this = this;

				// 保存校验
				if (1 != 1 ||
					!Validator.require(_this.user.loginName, "登陆名") ||
					!Validator.length(_this.user.loginName, "登陆名", 1, 50) ||
					!Validator.length(_this.user.name, "昵称", 1, 50) ||
					!Validator.require(_this.user.password, "密码")
				) {
					return;
				}

				_this.user.password = hex_md5(_this.user.password + KEY);

				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/save', _this.user).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						_this.dialog = false,
							_this.list(1);
						Toast.success("保存成功！");
					} else {
						Toast.warning(resp.message)
					}
				})
			},

			/**
			 * 删除小节
			 */
			del(id) {
				let _this = this;
				Confirm.show("删除用户后不可恢复，确认删除？", function() {
					Loading.show();
					_this.$ajax.delete(process.env.VUE_APP_SERVER + '/system/admin/user/delete/' + id).then((response) => {
						Loading.hide();
						let resp = response.data;
						if (resp.success) {
							_this.list(1);
							Toast.success("删除成功！");
						}
					})
				});
			},

			/**
			 * 
			 * 修改密码
			 */

			editPassword(user) {
				let _this = this;
				_this.user = $.extend({}, user);
				_this.dialogPassword = true;
			},

			/**
			 * 保存密码
			 */
			savePassword() {
				let _this = this;

				// 保存校验
				if (1 != 1 ||
					!Validator.require(_this.user.loginName, "登陆名") ||
					!Validator.length(_this.user.loginName, "登陆名", 1, 50) ||
					!Validator.length(_this.user.name, "昵称", 1, 50) ||
					!Validator.require(_this.user.password, "密码")
				) {
					return;
				}

				_this.user.password = hex_md5(_this.user.password + KEY);

				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/save-password', _this.user).then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						_this.dialogPassword = false,
							_this.list(1);
						Toast.success("保存成功！");
					} else {
						Toast.warning(resp.message)
					}
				})
			}
		}
	}
</script>

<style>
</style>

```







后端

userService.java

```java
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.User;
import com.lzn.domain.UserExample;
import com.lzn.domain.Test;
import com.lzn.domain.TestExample;
import com.lzn.dto.UserDto;
import com.lzn.dto.PageDto;
import com.lzn.exception.BusinessException;
import com.lzn.exception.BusinessExceptionCode;
import com.lzn.mapper.UserMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.CollectionUtils;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;


@Service
public class UserService {

    @Autowired
    private UserMapper userMapper;


    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        UserExample userExample = new UserExample();


        List<User> userList = userMapper.selectByExample(userExample);

        PageInfo<User> pageInfo = new PageInfo<>(userList);
        pageDto.setTotal(pageInfo.getTotal());

        List<UserDto> userDtoList = new ArrayList<>();

        for(int i = 0;i<userList.size();++i){
            User user = userList.get(i);
            UserDto userDto = new UserDto();
            BeanUtils.copyProperties(user, userDto);
            userDtoList.add(userDto);
        }
        pageDto.setList(userDtoList);

    }

    public void save(UserDto userDto){

        User user = CopyUtil.copy(userDto, User.class);
        if(StringUtils.isEmpty(userDto.getId())){
            this.insert(user);
        } else {
            this.update(user);
        }
    }

    /**
     * 新增
     */
    private void insert(User user) {
        user.setId(UuidUtil.getShortUuid());
        User userDb = this.selectByLoginName(user.getLoginName());
        if (userDb != null) {
            throw new BusinessException(BusinessExceptionCode.USER_LOGIN_NAME_EXIST);
        }
        userMapper.insert(user);
    }



    private void update(User user){
        user.setPassword(null);
        userMapper.updateByPrimaryKeySelective(user);
    }

    public void delete(String id) {
        userMapper.deleteByPrimaryKey(id);
    }

    /**
     * 根据登录名查询用户信息
     * @param loginName
     * @return
     */
    public User selectByLoginName(String loginName) {
        UserExample userExample = new UserExample();
        userExample.createCriteria().andLoginNameEqualTo(loginName);
        List<User> userList = userMapper.selectByExample(userExample);
        if (CollectionUtils.isEmpty(userList)) {
            return null;
        } else {
            return userList.get(0);
        }
    }

    /**
     * 重置密码
     * @param userDto
     */
    public void savePassword(UserDto userDto) {
        User user = new User();
        user.setId(userDto.getId());
        user.setPassword(userDto.getPassword());
        userMapper.updateByPrimaryKeySelective(user);
    }
}


```







```
package com.lzn.system.controller.admin;

import com.lzn.dto.PageDto;
import com.lzn.dto.ResponseDto;
import com.lzn.dto.UserDto;
import com.lzn.service.UserService;
import com.lzn.util.ValidatorUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/admin/user")
public class UserController {

    public static final String BUSINESS_NAME = "用户";

    @Autowired
    private UserService userService;

    @PostMapping("/list")
    public ResponseDto list(@RequestBody PageDto pageDto) {
        ResponseDto responseDto = new ResponseDto();
        userService.list(pageDto);
        responseDto.setContent(pageDto);
        return responseDto;
    }
    @PostMapping("/save")
    public ResponseDto save(@RequestBody UserDto userDto){
        userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));
        // 保存校验
        ValidatorUtil.require(userDto.getLoginName(), "登陆名");
        ValidatorUtil.length(userDto.getLoginName(), "登陆名", 1, 50);
        ValidatorUtil.length(userDto.getName(), "昵称", 1, 50);
        ValidatorUtil.require(userDto.getPassword(), "密码");


        ResponseDto responseDto = new ResponseDto();
        userService.save(userDto);
        responseDto.setContent(userDto);
        return responseDto;
    }

    @DeleteMapping("/delete/{id}")
    public ResponseDto delete(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        userService.delete(id);
        return responseDto;
    }


    /**
     * 重置密码
     */
    @PostMapping("/save-password")
    public ResponseDto savePassword(@RequestBody UserDto userDto) {
        userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));
        ResponseDto responseDto = new ResponseDto();
        userService.savePassword(userDto);
        responseDto.setContent(userDto);
        return responseDto;
    }

    
}
```





# 基本的登录功能开发

## 基本的登录功能开发

login.vue

```vue
<template>
	<v-app>
		<v-content>
			<v-container class="fill-height" fluid>
				<v-row align="center" justify="center">
					<v-col col="12" sm="8" md="8">
						<v-card class="elevation-12">
							<v-window v-model="step">
								<v-window-item :value="1">
									<v-row>
										<v-col cols="12" md="8">
											<v-card-text class="mt-12">
												<h1 class="text-center display-2 blue--text text--accent-3">
													登录页面
												</h1>
												<v-form>
													<v-text-field v-model="user.loginName" label="name" name="name" prepend-icon="person" type="text" color="blue accent-3" />

													<v-text-field v-model="user.password" id="password" label="Password" name="Password" prepend-icon="lock"
													 type="password" color="blue accent-3" />


												</v-form>

												<h3 class="text-center mt-3">
													忘记密码
												</h3>

											</v-card-text>

											<div class="text-center mt-3">
												<v-btn rounded color="blue accent-3" dark v-on:click="login()">登录</v-btn>
											</div>
										</v-col>

										<v-col cols="12" md="4" class="green accent-3">
											<v-card-text class="blue-grey--text mt-12">
												<h1 class="text-center display-1">你好，朋友!</h1>
												<h5 class="text-center">输入您的个人详细信息，然后开始与我们一起旅行。</h5>
											</v-card-text>
											<div class="text-center">
												<v-btn rounded outlined="" dark v-on:click="change1()">
													注册
												</v-btn>
											</div>
										</v-col>
									</v-row>
								</v-window-item>
								<v-window-item :value="2">
									<v-row class="fill-height">
										<v-col cols="12" md="4" class="teal accent-3">
											<v-card-text class="white--text mt-12">
												<h1 class="text-center display-1">欢迎回来!</h1>
												<h5 class="text-center">请将您的个人信息与我们保持联系</h5>
											</v-card-text>
											<div class="text-center ">
												<v-btn rounded outlined dark v-on:click="change2()">
													登录
												</v-btn>
											</div>


										</v-col>
										<v-col cols="12" md="8">
											<v-card-text class="mt-12">
												<h1 class="text-center display-2 teal--text text--accent-3">
													创建账号
												</h1>

												<v-form>
													<v-text-field label="Name" name="name" prepend-icon="person" type="text" color="teal accent-3" />

													<v-text-field label="Email" name="Email" prepend-icon="email" type="text" color="teal accent-3" />

													<v-text-field id="password" label="Password" name="Password" prepend-icon="lock" type="password" color="teal accent-3" />

												</v-form>



											</v-card-text>

											<div class="text-center mt-5">
												<v-btn rounded color="teal accent-3" dark>
													注册
												</v-btn>
											</div>
										</v-col>
									</v-row>
								</v-window-item>
							</v-window>
						</v-card>
					</v-col>
				</v-row>
			</v-container>
		</v-content>
	</v-app>
</template>

<script>
	export default {
		name: 'login',
		data: () => ({
			user: {},
			step: 1,
		}),

		props: {
			source: String
		},

		methods: {
			change1() {
				this.step++;
			},

			change2() {
				this.step--;
			},

			login() {
				let _this = this;

				if (
					1 != 1 ||
					!Validator.require(_this.user.loginName, "用户名") ||
					!Validator.require(_this.user.password, "密码")
				) {
					return;
				}
				// 进行第一次加密
				_this.user.password = hex_md5(_this.user.password + KEY);
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/login', _this.user).then(
					(response) => {
						Loading.hide();
						let resp = response.data;
						if (resp.success) {
							console.log(resp.content);
							// _this.$router.push("/welcome");
						} else {
							Toast.warning(resp.message);
						}
					});
			}
		}
	}
</script>

```







```
package com.lzn.system.controller.admin;

import com.lzn.dto.PageDto;
import com.lzn.dto.ResponseDto;
import com.lzn.dto.UserDto;
import com.lzn.service.UserService;
import com.lzn.util.ValidatorUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/admin/user")
public class UserController {

    public static final String BUSINESS_NAME = "用户";

    @Autowired
    private UserService userService;

    @PostMapping("/list")
    public ResponseDto list(@RequestBody PageDto pageDto) {
        ResponseDto responseDto = new ResponseDto();
        userService.list(pageDto);
        responseDto.setContent(pageDto);
        return responseDto;
    }
    @PostMapping("/save")
    public ResponseDto save(@RequestBody UserDto userDto){
        userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));
        // 保存校验
        ValidatorUtil.require(userDto.getLoginName(), "登陆名");
        ValidatorUtil.length(userDto.getLoginName(), "登陆名", 1, 50);
        ValidatorUtil.length(userDto.getName(), "昵称", 1, 50);
        ValidatorUtil.require(userDto.getPassword(), "密码");


        ResponseDto responseDto = new ResponseDto();
        userService.save(userDto);
        responseDto.setContent(userDto);
        return responseDto;
    }

    @DeleteMapping("/delete/{id}")
    public ResponseDto delete(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        userService.delete(id);
        return responseDto;
    }


    /**
     * 重置密码
     */
    @PostMapping("/save-password")
    public ResponseDto savePassword(@RequestBody UserDto userDto) {
        userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));
        ResponseDto responseDto = new ResponseDto();
        userService.savePassword(userDto);
        responseDto.setContent(userDto);
        return responseDto;
    }

    /**
     * 登录
     */
    @PostMapping("/login")
    public ResponseDto login(@RequestBody UserDto userDto) {
        userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));
        ResponseDto responseDto = new ResponseDto();
        userService.login(userDto);
        responseDto.setContent(userDto);
        return responseDto;
    }
}
```



用户名+密码，去数据库中查找的话，程序不知道是用户名不对，还是密码不对，

程序应该要能知道，比如我如果发现有大量的用户名不对的报错，说明有人正在不断的探测我系统的用户名



LoginUserDto

```
package com.lzn.dto;


import java.util.HashSet;
import java.util.List;

public class LoginUserDto {

    /**
     * id
     */
    private String id;

    /**
     * 登陆名
     */
    private String loginName;

    /**
     * 昵称
     */
    private String name;

    /**
     * 登录凭证
     */
    private String token;

    /**
     * 所有资源，用于前端界面控制
     */
    /**
     * 所有资源中的请求，用于后端接口拦截
     */
    private HashSet<String> requests;

    public String getId() {
        return id;
    }

    public void setId(String id) {
        this.id = id;
    }

    public String getLoginName() {
        return loginName;
    }

    public void setLoginName(String loginName) {
        this.loginName = loginName;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getToken() {
        return token;
    }

    public void setToken(String token) {
        this.token = token;
    }

    public HashSet<String> getRequests() {
        return requests;
    }

    public void setRequests(HashSet<String> requests) {
        this.requests = requests;
    }

    @Override
    public String toString() {
        final StringBuffer sb = new StringBuffer("LoginUserDto{");
        sb.append("id='").append(id).append('\'');
        sb.append(", loginName='").append(loginName).append('\'');
        sb.append(", name='").append(name).append('\'');
        sb.append(", token='").append(token).append('\'');
        sb.append(", requests=").append(requests);
        sb.append('}');
        return sb.toString();
    }

}
```

UserService

```
package com.lzn.service;

import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.lzn.domain.User;
import com.lzn.domain.UserExample;
import com.lzn.domain.Test;
import com.lzn.domain.TestExample;
import com.lzn.dto.LoginUserDto;
import com.lzn.dto.UserDto;
import com.lzn.dto.PageDto;
import com.lzn.exception.BusinessException;
import com.lzn.exception.BusinessExceptionCode;
import com.lzn.mapper.UserMapper;
import com.lzn.mapper.TestMapper;
import com.lzn.util.CopyUtil;
import com.lzn.util.UuidUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.CollectionUtils;
import org.springframework.util.StringUtils;

import java.util.ArrayList;
import java.util.List;


@Service
public class UserService {

    private static final Logger LOG =
            LoggerFactory.getLogger(UserService.class);

    @Autowired
    private UserMapper userMapper;


    public void list(PageDto pageDto) {

        PageHelper.startPage(pageDto.getPage(), pageDto.getSize());
        UserExample userExample = new UserExample();


        List<User> userList = userMapper.selectByExample(userExample);

        PageInfo<User> pageInfo = new PageInfo<>(userList);
        pageDto.setTotal(pageInfo.getTotal());

        List<UserDto> userDtoList = new ArrayList<>();

        for(int i = 0;i<userList.size();++i){
            User user = userList.get(i);
            UserDto userDto = new UserDto();
            BeanUtils.copyProperties(user, userDto);
            userDtoList.add(userDto);
        }
        pageDto.setList(userDtoList);

    }

    public void save(UserDto userDto){

        User user = CopyUtil.copy(userDto, User.class);
        if(StringUtils.isEmpty(userDto.getId())){
            this.insert(user);
        } else {
            this.update(user);
        }
    }

    /**
     * 新增
     */
    private void insert(User user) {
        user.setId(UuidUtil.getShortUuid());
        User userDb = this.selectByLoginName(user.getLoginName());
        if (userDb != null) {
            throw new BusinessException(BusinessExceptionCode.USER_LOGIN_NAME_EXIST);
        }
        userMapper.insert(user);
    }



    private void update(User user){
        user.setPassword(null);
        userMapper.updateByPrimaryKeySelective(user);
    }

    public void delete(String id) {
        userMapper.deleteByPrimaryKey(id);
    }

    /**
     * 根据登录名查询用户信息
     * @param loginName
     * @return
     */
    public User selectByLoginName(String loginName) {
        UserExample userExample = new UserExample();
        userExample.createCriteria().andLoginNameEqualTo(loginName);
        List<User> userList = userMapper.selectByExample(userExample);
        if (CollectionUtils.isEmpty(userList)) {
            return null;
        } else {
            return userList.get(0);
        }
    }

    /**
     * 重置密码
     * @param userDto
     */
    public void savePassword(UserDto userDto) {
        User user = new User();
        user.setId(userDto.getId());
        user.setPassword(userDto.getPassword());
        userMapper.updateByPrimaryKeySelective(user);
    }

    public LoginUserDto login(UserDto userDto) {
        User user = selectByLoginName(userDto.getLoginName());
        if ( user == null ) {
            // 用户名不存在
            LOG.error("用户名不存在");
            throw new BusinessException(BusinessExceptionCode.LOGIN_USER_ERROR);
        } else {
            if ( user.getPassword().equals(userDto.getPassword())) {
                // 登录成功
                return CopyUtil.copy(user, LoginUserDto.class);
            } else {
                // 密码不对
                LOG.error("密码错误");
                throw new BusinessException(BusinessExceptionCode.LOGIN_USER_ERROR);
            }
        }
    }
}
```



UserController

```
package com.lzn.system.controller.admin;

import com.lzn.dto.LoginUserDto;
import com.lzn.dto.PageDto;
import com.lzn.dto.ResponseDto;
import com.lzn.dto.UserDto;
import com.lzn.service.UserService;
import com.lzn.util.ValidatorUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/admin/user")
public class UserController {

    public static final String BUSINESS_NAME = "用户";

    @Autowired
    private UserService userService;

    @PostMapping("/list")
    public ResponseDto list(@RequestBody PageDto pageDto) {
        ResponseDto responseDto = new ResponseDto();
        userService.list(pageDto);
        responseDto.setContent(pageDto);
        return responseDto;
    }
    @PostMapping("/save")
    public ResponseDto save(@RequestBody UserDto userDto){
        userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));
        // 保存校验
        ValidatorUtil.require(userDto.getLoginName(), "登陆名");
        ValidatorUtil.length(userDto.getLoginName(), "登陆名", 1, 50);
        ValidatorUtil.length(userDto.getName(), "昵称", 1, 50);
        ValidatorUtil.require(userDto.getPassword(), "密码");


        ResponseDto responseDto = new ResponseDto();
        userService.save(userDto);
        responseDto.setContent(userDto);
        return responseDto;
    }

    @DeleteMapping("/delete/{id}")
    public ResponseDto delete(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        userService.delete(id);
        return responseDto;
    }


    /**
     * 重置密码
     */
    @PostMapping("/save-password")
    public ResponseDto savePassword(@RequestBody UserDto userDto) {
        userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));
        ResponseDto responseDto = new ResponseDto();
        userService.savePassword(userDto);
        responseDto.setContent(userDto);
        return responseDto;
    }

    /**
     * 登录
     */
    @PostMapping("/login")
    public ResponseDto login(@RequestBody UserDto userDto) {
        userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));
        ResponseDto responseDto = new ResponseDto();
       LoginUserDto loginUserDto = userService.login(userDto);
        responseDto.setContent(loginUserDto);
        return responseDto;
    }
}
```





## 登录后保存登录信息

前端的信息保存有很多办法， 

h5的localStorage

sessionStorage 

js的全局变量

vue 的 store等



localStorage 在关闭页面后，登录信息还是在的，适合一些内网使用的系统保存登录信息

js全局变量或者vue的store，刷新浏览器的时候，信息会丢失



login.vue

```
		_this.user.password = hex_md5(_this.user.password + KEY);
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/login', _this.user).then(
					(response) => {
						Loading.hide();
						let resp = response.data;
						if (resp.success) {
							
							// console.log(resp.content);
							SessionStorage.set("USER", resp.content);
							_this.$router.push("/welcome");
						} else {
							Toast.warning(resp.message);
						}
					});
```





welcome.vue

```vue
<template>
	<div>
		<h1>您好，欢迎{{ loginUser.name  }}进入控制台.</h1>
	</div>
</template>

<script>
	export default {
		name: 'welcome',
		data: function () {
			return {
				loginUser: {},
			}
		},
		
		mounted: function() {
			let _this = this;
			_this.loginUser = SessionStorage.get("USER");
		},
		methods: {
			
		}
	}
</script>

<style>
</style>

```







做一个优化

一般会把登录信的保存和读取

做成一个通用的方法

tools.js

```js
Tool = {
	/**
	 * 空校验 null或""都返回true
	 */
	isEmpty: function(obj) {
		if ((typeof obj == 'string')) {
			// https://blog.csdn.net/dreamjay1997/article/details/86599404
			return !obj || obj.replace(/\s+/g, "") == ""
		} else {
			return (!obj || JSON.stringify(obj) === "{}" || obj.length === 0);
		}
	},

	/**
	 * 非空校验
	 */
	isNotEmpty: function(obj) {
		return !this.isEmpty(obj);
	},

	/**
	 * 长度校验
	 */
	isLength: function(str, min, max) {
		return $.trim(str).length >= min && $.trim(str).length <= max;
	},

	/**
	 * 时间格式化，date为空时取当前时间
	 */
	dateFormat: function(format, date) {
		let result;
		if (!date) {
			date = new Date();
		}
		const option = {
			"y+": date.getFullYear().toString(), // 年
			"M+": (date.getMonth() + 1).toString(), // 月
			"d+": date.getDate().toString(), // 日
			"h+": date.getHours().toString(), // 时
			"m+": date.getMinutes().toString(), // 分
			"s+": date.getSeconds().toString() // 秒
		};
		for (let i in option) {
			result = new RegExp("(" + i + ")").exec(format);
			if (result) {
				format = format.replace(result[1], (result[1].length == 1) ? (option[i]) : (option[i].padStart(result[1].length,
					"0")))
			}
		}
		return format;
	},


	/**
	 * 10进制转62进制
	 * @param number
	 * @returns {string}
	 * @private
	 */
	_10to62: function(number) {
		let chars = '0123456789abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ';
		let radix = chars.length;
		let arr = [];
		do {
			let mod = number % radix;
			number = (number - mod) / radix;
			arr.unshift(chars[mod]);
		} while (number);
		return arr.join('');
	},
	
	/**
	 * 保存登录用户
	 */
	setLoginUser: function(loginUser) {
		SessionStorage.set(SESSION_KEY_LOGIN_USER, loginUser);
	},
	
	/**
	 * 获取登录用户
	 */
	getLoginUser:function() {
		return SessionStorage.get(SESSION_KEY_LOGIN_USER) || {};
	}

}

```

​			Tool.setLoginUser(resp.content);







# 退出登录与记住登录

## 增加退出登录功能

点击退出登录，清空当前登录的缓存信息，并跳到登录页面

一般登录信息在前后端都会有保存

后端：

```
package com.lzn.dto;

public class Constants {

    public static final String LOGIN_USER = "LOGIN_USER";
}
```

UserController

```
package com.lzn.system.controller.admin;

import com.lzn.dto.*;
import com.lzn.service.UserService;
import com.lzn.util.ValidatorUtil;
import org.apache.tomcat.util.bcel.Const;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.DigestUtils;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;

@RestController
@RequestMapping("/admin/user")
public class UserController {

    public static final String BUSINESS_NAME = "用户";

    @Autowired
    private UserService userService;

    @PostMapping("/list")
    public ResponseDto list(@RequestBody PageDto pageDto) {
        ResponseDto responseDto = new ResponseDto();
        userService.list(pageDto);
        responseDto.setContent(pageDto);
        return responseDto;
    }
    @PostMapping("/save")
    public ResponseDto save(@RequestBody UserDto userDto){
        userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));
        // 保存校验
        ValidatorUtil.require(userDto.getLoginName(), "登陆名");
        ValidatorUtil.length(userDto.getLoginName(), "登陆名", 1, 50);
        ValidatorUtil.length(userDto.getName(), "昵称", 1, 50);
        ValidatorUtil.require(userDto.getPassword(), "密码");


        ResponseDto responseDto = new ResponseDto();
        userService.save(userDto);
        responseDto.setContent(userDto);
        return responseDto;
    }

    @DeleteMapping("/delete/{id}")
    public ResponseDto delete(@PathVariable String id) {
        ResponseDto responseDto = new ResponseDto();
        userService.delete(id);
        return responseDto;
    }


    /**
     * 重置密码
     */
    @PostMapping("/save-password")
    public ResponseDto savePassword(@RequestBody UserDto userDto) {
        userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));
        ResponseDto responseDto = new ResponseDto();
        userService.savePassword(userDto);
        responseDto.setContent(userDto);
        return responseDto;
    }

    /**
     * 登录
     */
    @PostMapping("/login")
    public ResponseDto login(@RequestBody UserDto userDto, HttpServletRequest request) {
        userDto.setPassword(DigestUtils.md5DigestAsHex(userDto.getPassword().getBytes()));
        ResponseDto responseDto = new ResponseDto();
        LoginUserDto loginUserDto = userService.login(userDto);
        request.getSession().setAttribute(Constants.LOGIN_USER, loginUserDto);
        responseDto.setContent(loginUserDto);
        return responseDto;
    }

    /**
     * 退出
     */
    @GetMapping("/logout")
    public ResponseDto logout(HttpServletRequest request) {
        ResponseDto responseDto = new ResponseDto();
        request.getSession().removeAttribute(Constants.LOGIN_USER);
        return responseDto;
    }

}

```







navbar.vue

```vue
<template>
	<nav>
		<v-app-bar app color="#438EB9">

			<v-app-bar-nav-icon @click="drawer = !drawer"></v-app-bar-nav-icon>

			<v-toolbar-title class="text-uppercase">
				<span class="font-weight-bold">在线视频</span>
				<span>系统</span>
			</v-toolbar-title>

			<!-- text 透明度设置， color 改变按钮内部文字颜色 -->
			<!-- 尽可能多的占用空间 grid -->
			<v-spacer></v-spacer>
			<v-menu offset-y>
				<template v-slot:activator="{ on, attrs }">
					<v-btn text v-bind="attrs" v-on="on" class="font-weight-bold">
						菜单
					</v-btn>
				</template>

				<!-- 			<v-list>
					<v-list-item v-for="(item, i) in links" :key="i" :to="item.route" active-class="border">
						<v-list-item-title>{{item.text}}</v-list-item-title>
					</v-list-item>
				</v-list> -->
			</v-menu>

			<v-btn text @click="logout()">
				<span class="font-weight-bold">退出</span>
				<v-icon>exit_to_app</v-icon>
			</v-btn>
		</v-app-bar>

		<v-navigation-drawer v-model="drawer" app color="#F8F8F8">
			<!-- 对应了菜单先写死 -->
			<v-list>

				<v-list-group prepend-icon="settings" color="blue" no-action="">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>系统管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/system/user">
						<v-list-item-content>
							<v-list-item-title>用户管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

				</v-list-group>


				<v-list-group prepend-icon="apps" color="blue" no-action="">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>业务管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/business/course">
						<v-list-item-content>
							<v-list-item-title>课程管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/business/teacher">
						<v-list-item-content>
							<v-list-item-title>讲师管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

					<v-list-item to="/business/category">
						<v-list-item-content>
							<v-list-item-title>分类管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

				</v-list-group>

				<!-- :value="true" 就是展开了 -->
				<v-list-group prepend-icon="folder" color="blue" no-action="">
					<template v-slot:activator>
						<v-list-item-content>
							<v-list-item-title>文件管理</v-list-item-title>
						</v-list-item-content>
					</template>

					<v-list-item to="/file/file">
						<v-list-item-content>
							<v-list-item-title>文件管理</v-list-item-title>
						</v-list-item-content>
					</v-list-item>

				</v-list-group>




			</v-list>

		</v-navigation-drawer>
	</nav>
</template>

<script>
	export default {
		data() {
			return {
				drawer: true,
				link: '/welcome',
			}
		},

		methods: {
			// 退出

			logout() {
				let _this = this;
				Loading.show();
				_this.$ajax.get(process.env.VUE_APP_SERVER + '/system/admin/user/logout/').then((response) => {
					Loading.hide();
					let resp = response.data;
					if (resp.success) {
						Tool.setLoginUser(null);
						_this.$router.push("/login")
					} else {
						Toast.warning(resp.message)
					}
				});
			},
		}
	}
</script>

<style scoped>
</style>

```







## 增加记住登录信息功能

  <v-checkbox label="Remember me" v-model="remember"></v-checkbox>



login.vue

```vue
<template>
	<v-app>
		<v-content>
			<v-container class="fill-height" fluid>
				<v-row align="center" justify="center">
					<v-col col="12" sm="8" md="8">
						<v-card class="elevation-12">
							<v-window v-model="step">
								<v-window-item :value="1">
									<v-row>
										<v-col cols="12" md="8">
											<v-card-text class="mt-12">
												<h1 class="text-center display-2 blue--text text--accent-3">
													登录页面
												</h1>
												<v-form>
													<v-text-field v-model="user.loginName" label="name" name="name" prepend-icon="person" type="text" color="blue accent-3" />

													<v-text-field v-model="user.password" id="password" label="Password" name="Password" prepend-icon="lock"
													 type="password" color="blue accent-3" />


												</v-form>

												<v-checkbox label="记住我" v-model="remember"></v-checkbox>

												<!-- 				<h3 class="text-center mt-3">
													忘记密码
												</h3>
 -->
											</v-card-text>

											<div class="text-center mt-3">
												<v-btn rounded color="blue accent-3" dark v-on:click="login()">登录</v-btn>
											</div>
										</v-col>

										<v-col cols="12" md="4" class="green accent-3">
											<v-card-text class="blue-grey--text mt-12">
												<h1 class="text-center display-1">你好，朋友!</h1>
												<h5 class="text-center">输入您的个人详细信息，然后开始与我们一起旅行。</h5>
											</v-card-text>
											<div class="text-center">
												<v-btn rounded outlined="" dark v-on:click="change1()">
													注册
												</v-btn>
											</div>
										</v-col>
									</v-row>
								</v-window-item>
								<v-window-item :value="2">
									<v-row class="fill-height">
										<v-col cols="12" md="4" class="teal accent-3">
											<v-card-text class="white--text mt-12">
												<h1 class="text-center display-1">欢迎回来!</h1>
												<h5 class="text-center">请将您的个人信息与我们保持联系</h5>
											</v-card-text>
											<div class="text-center ">
												<v-btn rounded outlined dark v-on:click="change2()">
													登录
												</v-btn>
											</div>


										</v-col>
										<v-col cols="12" md="8">
											<v-card-text class="mt-12">
												<h1 class="text-center display-2 teal--text text--accent-3">
													创建账号
												</h1>

												<v-form>
													<v-text-field label="Name" name="name" prepend-icon="person" type="text" color="teal accent-3" />

													<v-text-field label="Email" name="Email" prepend-icon="email" type="text" color="teal accent-3" />

													<v-text-field id="password" label="Password" name="Password" prepend-icon="lock" type="password" color="teal accent-3" />

												</v-form>



											</v-card-text>

											<div class="text-center mt-5">
												<v-btn rounded color="teal accent-3" dark>
													注册
												</v-btn>
											</div>
										</v-col>
									</v-row>
								</v-window-item>
							</v-window>
						</v-card>
					</v-col>
				</v-row>
			</v-container>
		</v-content>
	</v-app>
</template>

<script>
	export default {
		name: 'login',
		data: () => ({
			user: {},
			step: 1,
			remember: true,
		}),

		props: {
			source: String
		},

		mounted: function() {
			let _this = this;
			let rememberUser = LocalStorage.get(LOCAL_KEY_REMEMBER_USER);
			if (rememberUser) {
				_this.user = rememberUser;
			}
		},

		methods: {
			change1() {
				this.step++;
			},

			change2() {
				this.step--;
			},

			login() {
				let _this = this;


				if (
					1 != 1 ||
					!Validator.require(_this.user.loginName, "用户名") ||
					!Validator.require(_this.user.password, "密码")
				) {
					return;
				}
				
				// let passwordShow = _this.user.password;
				// 如果密码是从缓存带出来的，则不需要重新加密
				let md5 = hex_md5(_this.user.password);
				let rememberUser = LocalStorage.get(LOCAL_KEY_REMEMBER_USER) || {};
				if (md5 !== rememberUser.md5) {
					_this.user.password = hex_md5(_this.user.password + KEY);
				}
				
				
				
				// 进行第一次加密
				// _this.user.password = hex_md5(_this.user.password + KEY);
				Loading.show();
				_this.$ajax.post(process.env.VUE_APP_SERVER + '/system/admin/user/login', _this.user).then(
					(response) => {
						Loading.hide();
						let resp = response.data;
						let loginUser = resp.content;
						if (resp.success) {

							// console.log(resp.content);
							// SessionStorage.set("USER", resp.content);
							Tool.setLoginUser(resp.content);
							if (_this.remember) {
								// 如果勾选记住我，则将用户名密码保存到本地缓存
								// 原：这里需要保存密码明文，否则登录时又会再加一层密
								// 新：这里保存密码密文，并保存密文md5，用于检测密码是否被重新输入过
								let md5 = hex_md5(_this.user.password);
								LocalStorage.set(LOCAL_KEY_REMEMBER_USER, {
									loginName: loginUser.loginName,
									password: _this.user.password,
									md5: md5
								})
							} else {
								// 没有勾选“记住我”时，要把本地缓存清空，否则按照mounted的逻辑，下次打开时会自动显示用户名密码
								LocalStorage.set(LOCAL_KEY_REMEMBER_USER, null);
							}

							_this.$router.push("/welcome");
						} else {
							Toast.warning(resp.message);
						}
					});
			}
		}
	}
</script>

```







# 增加登录图形验证码

## 集成图形验证码Kaptcha



根pom.xml

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
   <modelVersion>4.0.0</modelVersion>
    <packaging>pom</packaging>
    <modules>
        <module>eureka</module>
      <module>system</module>
      <module>gateway</module>
        <module>server</module>
        <module>business</module>
      <module>generator</module>
        <module>file</module>
    </modules>
    <parent>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-parent</artifactId>
      <version>2.3.4.RELEASE</version>
      <relativePath/> <!-- lookup parent from repository -->
   </parent>
   <groupId>com.lzn</groupId>
   <artifactId>course</artifactId>
   <version>0.0.1-SNAPSHOT</version>
   <name>course</name>
   <description>Demo project for Spring Boot</description>

   <properties>
      <java.version>1.8</java.version>
      <spring-cloud.version>Hoxton.SR8</spring-cloud.version>
   </properties>



   <dependencyManagement>
      <dependencies>
         <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${spring-cloud.version}</version>
            <type>pom</type>
            <scope>import</scope>
         </dependency>


         <!-- 集成mybatis -->
         <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
            <version>1.3.2</version>
         </dependency>
         <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.37</version>
         </dependency>

         <dependency>
            <groupId>com.lzn</groupId>
            <artifactId>server</artifactId>
            <version>0.0.1-SNAPSHOT</version>
         </dependency>

<!--         mybatis分页插件pagehelper-->
         <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>1.2.11</version>
         </dependency>


<!--         fastjson-->
         <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>1.2.73</version>
         </dependency>


<!--         freemarker-->
         <dependency>
            <groupId>org.freemarker</groupId>
            <artifactId>freemarker</artifactId>
            <version>2.3.30</version>
         </dependency>

<!--         读xml-->
         <dependency>
            <groupId>org.dom4j</groupId>
            <artifactId>dom4j</artifactId>
            <version>2.1.1</version>
         </dependency>
         
<!--         图形验证码-->
         <dependency>
            <groupId>com.github.penggle</groupId>
            <artifactId>kaptcha</artifactId>
            <version>2.3.2</version>
         </dependency>



      </dependencies>


   </dependencyManagement>

   <build>
      <plugins>
         <plugin>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-maven-plugin</artifactId>
         </plugin>

         <!-- mybatis generator 自动生成代码插件 -->
         <plugin>
            <groupId>org.mybatis.generator</groupId>
            <artifactId>mybatis-generator-maven-plugin</artifactId>
            <version>1.3.7</version>
            <configuration>
<!--               配置文件 -->
               <configurationFile>src/main/resources/generator/generatorConfig.xml</configurationFile>
               <overwrite>true</overwrite>
               <verbose>true</verbose>
            </configuration>
            <dependencies>
               <dependency>
                  <groupId>mysql</groupId>
                  <artifactId>mysql-connector-java</artifactId>
                  <version>5.1.37</version>
               </dependency>
            </dependencies>
         </plugin>

      </plugins>
   </build>

</project>
```



server 

pom.xml

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>course</artifactId>
        <groupId>com.lzn</groupId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>server</artifactId>

    <dependencies>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!-- 集成mybatis -->
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>


<!--        分页插件-->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
        </dependency>


<!--        aop-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-aop</artifactId>
        </dependency>

        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
        </dependency>

        <dependency>
            <groupId>com.github.penggle</groupId>
            <artifactId>kaptcha</artifactId>
        </dependency>



    </dependencies>
</project>
```





server config

```
package com.lzn.config;

import com.google.code.kaptcha.impl.DefaultKaptcha;
import com.google.code.kaptcha.util.Config;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.Properties;

@Configuration
public class KaptchaConfig {
    @Bean
    public DefaultKaptcha getDefaultKaptcha() {
        DefaultKaptcha defaultKaptcha = new DefaultKaptcha();
        Properties properties = new Properties();
        properties.setProperty("kaptcha.border", "no");
//        properties.setProperty("kaptcha.border.color", "105,179,90");
        properties.setProperty("kaptcha.textproducer.font.color", "blue");
        properties.setProperty("kaptcha.image.width", "90");
        properties.setProperty("kaptcha.image.height", "32");
        properties.setProperty("kaptcha.textproducer.font.size", "24");
        properties.setProperty("kaptcha.session.key", "code");
        properties.setProperty("kaptcha.textproducer.char.length", "4");
        properties.setProperty("kaptcha.textproducer.font.names", "Arial");
        properties.setProperty("kaptcha.noise.impl", "com.google.code.kaptcha.impl.NoNoise");
        properties.setProperty("kaptcha.obscurificator.impl", "com.google.code.kaptcha.impl.WaterRipple");
        Config config = new Config(properties);
        defaultKaptcha.setConfig(config);
        return defaultKaptcha;
    }

    @Bean
    public DefaultKaptcha getWebKaptcha() {
        DefaultKaptcha defaultKaptcha = new DefaultKaptcha();
        Properties properties = new Properties();
        properties.setProperty("kaptcha.border", "no");
//        properties.setProperty("kaptcha.border.color", "105,179,90");
        properties.setProperty("kaptcha.textproducer.font.color", "blue");
        properties.setProperty("kaptcha.image.width", "90");
        properties.setProperty("kaptcha.image.height", "45");
        properties.setProperty("kaptcha.textproducer.font.size", "30");
        properties.setProperty("kaptcha.session.key", "code");
        properties.setProperty("kaptcha.textproducer.char.length", "4");
        properties.setProperty("kaptcha.textproducer.font.names", "Arial");
        properties.setProperty("kaptcha.noise.impl", "com.google.code.kaptcha.impl.NoNoise");
        properties.setProperty("kaptcha.obscurificator.impl", "com.google.code.kaptcha.impl.WaterRipple");
        Config config = new Config(properties);
        defaultKaptcha.setConfig(config);
        return defaultKaptcha;
    }
} 
```



system controller 

```
package com.lzn.system.controller.admin;

import com.google.code.kaptcha.impl.DefaultKaptcha;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.annotation.Resource;
import javax.imageio.ImageIO;
import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.awt.image.BufferedImage;
import java.io.ByteArrayOutputStream;
import java.util.concurrent.TimeUnit;

@RestController
@RequestMapping("/admin/kaptcha")
public class KaptchaController {
    public static final String BUSINESS_NAME = "图片验证码";

    @Qualifier("getDefaultKaptcha")
    @Autowired
    DefaultKaptcha defaultKaptcha;


    @GetMapping("/image-code/{imageCodeToken}")
    public void imageCode(@PathVariable(value = "imageCodeToken") String imageCodeToken, HttpServletRequest request, HttpServletResponse httpServletResponse) throws Exception{
        ByteArrayOutputStream jpegOutputStream = new ByteArrayOutputStream();
        try {
            // 生成验证码字符串
            String createText = defaultKaptcha.createText();

            // 将生成的验证码放入会话缓存中，后续验证的时候用到
             request.getSession().setAttribute(imageCodeToken, createText);
            // 使用验证码字符串生成验证码图片
            BufferedImage challenge = defaultKaptcha.createImage(createText);
            ImageIO.write(challenge, "jpg", jpegOutputStream);
        } catch (IllegalArgumentException e) {
            httpServletResponse.sendError(HttpServletResponse.SC_NOT_FOUND);
            return;
        }

        // 定义response输出类型为image/jpeg类型，使用response输出流输出图片的byte数组
        byte[] captchaChallengeAsJpeg = jpegOutputStream.toByteArray();
        httpServletResponse.setHeader("Cache-Control", "no-store");
        httpServletResponse.setHeader("Pragma", "no-cache");
        httpServletResponse.setDateHeader("Expires", 0);
        httpServletResponse.setContentType("image/jpeg");
        ServletOutputStream responseOutputStream = httpServletResponse.getOutputStream();
        responseOutputStream.write(captchaChallengeAsJpeg);
        responseOutputStream.flush();
        responseOutputStream.close();
    }
}
```







测试链接：

http://localhost:9000/system/admin/kaptcha/image-code/123